(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{138:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return b}));var a=n(2),r=n(6),i=(n(0),n(225)),o={title:"Cloud High Availability Plugin",sidebar_label:"Cloud HA"},l={unversionedId:"plugin_cloud_ha",id:"plugin_cloud_ha",isDocsHomePage:!1,title:"Cloud High Availability Plugin",description:"The 128T-cloud-ha plugin provides High Availability (HA) functionality for the 128T Networking Platform deployed in the cloud. HA for 128T routers in a non-cloud environment uses traditional techniques such as VRRP and GARP which both rely on a virtual MAC and virtual IP. In cloud environments such as AWS, Azure, etc., any techniques that rely on broadcast and multicast are not supported. This plugin uses node health metrics sent over SVR, as well as cloud API interactions to perform failovers in these cloud environments.",source:"@site/docs/plugin_cloud_ha.md",slug:"/plugin_cloud_ha",permalink:"/docs/plugin_cloud_ha",version:"current",lastUpdatedAt:1629860075,sidebar_label:"Cloud HA",sidebar:"docs",previous:{title:"AWS Transit Gateway Connect Plugin",permalink:"/docs/plugin_aws_tgw_connect"},next:{title:"DNS App Id Plugin",permalink:"/docs/plugin_dns_app_id"}},c=[{value:"Supported Solutions",id:"supported-solutions",children:[]},{value:"Version Restrictions",id:"version-restrictions",children:[]},{value:"Plugin Behavior",id:"plugin-behavior",children:[{value:"Monitoring Agent",id:"monitoring-agent",children:[]},{value:"HA Agent",id:"ha-agent",children:[]},{value:"API Agents",id:"api-agents",children:[]}]},{value:"Scenarios",id:"scenarios",children:[{value:"Both Healthy",id:"both-healthy",children:[]},{value:"Primary Failure",id:"primary-failure",children:[]},{value:"Primary Recovery",id:"primary-recovery",children:[]},{value:"Secondary Failure",id:"secondary-failure",children:[]},{value:"Secondary Recovery",id:"secondary-recovery",children:[]},{value:"Primary Shutdown",id:"primary-shutdown",children:[]},{value:"Secondary Shutdown",id:"secondary-shutdown",children:[]},{value:"Split Brain",id:"split-brain",children:[]},{value:"Split Brain Resolution",id:"split-brain-resolution",children:[]}]},{value:"Configuration",id:"configuration",children:[{value:"Groups",id:"groups",children:[]},{value:"Membership",id:"membership",children:[]},{value:"Address Prefixes",id:"address-prefixes",children:[]}]},{value:"Generated 128T Configuration",id:"generated-128t-configuration",children:[{value:"Validation",id:"validation",children:[]},{value:"Configuration Assumptions",id:"configuration-assumptions",children:[]},{value:"Cloud HA Loopback Interface",id:"cloud-ha-loopback-interface",children:[]},{value:"Health Status Transport",id:"health-status-transport",children:[]},{value:"Azure Load Balancer Config Generation",id:"azure-load-balancer-config-generation",children:[]}]},{value:"Troubleshooting",id:"troubleshooting",children:[{value:"Configuration Generation",id:"configuration-generation",children:[]},{value:"Logging",id:"logging",children:[]},{value:"PCLI Enhancements",id:"pcli-enhancements",children:[]},{value:"Systemd Services",id:"systemd-services",children:[]},{value:"Manual Failover",id:"manual-failover",children:[]},{value:"Alarms",id:"alarms",children:[]},{value:"Router Version Incompatibility",id:"router-version-incompatibility",children:[]}]},{value:"Appendix",id:"appendix",children:[{value:"Health Status Transport",id:"health-status-transport-1",children:[]},{value:"Azure Loadbalancer Configuration Generation",id:"azure-loadbalancer-configuration-generation",children:[]},{value:"Complete Example Configuration",id:"complete-example-configuration",children:[]}]},{value:"Release Notes",id:"release-notes",children:[{value:"Release 3.0.0",id:"release-300",children:[]}]}],s={rightToc:c};function b(e){var t=e.components,o=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},s,o,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"The 128T-cloud-ha plugin provides High Availability (HA) functionality for the 128T Networking Platform deployed in the cloud. HA for 128T routers in a non-cloud environment uses traditional techniques such as VRRP and GARP which both rely on a virtual MAC and virtual IP. In cloud environments such as AWS, Azure, etc., any techniques that rely on broadcast and multicast are not supported. This plugin uses node health metrics sent over SVR, as well as cloud API interactions to perform failovers in these cloud environments."),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"The instructions for installing and managing the plugin can be found ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/plugin_intro#installation-and-management"}),"here"),"."))),Object(i.b)("h2",{id:"supported-solutions"},"Supported Solutions"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Solution Name"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"th"},"solution-type")),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Available In Version"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Azure VNET"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"azure-vnet")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"2.0.0")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Azure Loadbalancer"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),Object(i.b)("inlineCode",{parentName:"td"},"azure-lb")),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"2.0.0")))),Object(i.b)("h2",{id:"version-restrictions"},"Version Restrictions"),Object(i.b)("p",null," The router component can only be installed on versions of 128T which support provisional state on ",Object(i.b)("em",{parentName:"p"},"device interfaces"),". This is necessary for the plugin to be able to prevent asymmetrical routing.\nThe versions of 128T that support this feature have a ",Object(i.b)("inlineCode",{parentName:"p"},"Provides: 128T-device-interface-api(1.0)"),", so it can be checked ahead of time by performing a ",Object(i.b)("inlineCode",{parentName:"p"},"rpm -q --whatprovides 128T-device-interface-api(1.0)")," to see if the currently installed 128T satisfies this requirement or ",Object(i.b)("inlineCode",{parentName:"p"},"dnf list --whatprovides 128T-device-interface-api(1.0)")," to see all versions of 128T that satisfy this requirement."),Object(i.b)("h2",{id:"plugin-behavior"},"Plugin Behavior"),Object(i.b)("p",null,Object(i.b)("img",{alt:"architecture",src:n(572).default})),Object(i.b)("h3",{id:"monitoring-agent"},"Monitoring Agent"),Object(i.b)("p",null,"The job of the Monitoring Agent is to produce and transmit health status messages. The Monitoring Agent collects the administrative status, operational status, and mac address of all of the configured redundant interfaces and additional interfaces at one second intervals. The health status is then sent via an HTTP POST to the IP address of the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface where the HA Agent is listening on port 12800."),Object(i.b)("h3",{id:"ha-agent"},"HA Agent"),Object(i.b)("p",null,"The job of the HA Agent is to process the health status messages from the the local Monitoring Agent and determine the health status for performing failover operations. For an interface to be healthy, it must be administratively and operationally up. For a node to be healthy, it must have at least one healthy ",Object(i.b)("inlineCode",{parentName:"p"},"redundant-interface"),". If there are additional interfaces configured, then the node must have at least one healthy ",Object(i.b)("inlineCode",{parentName:"p"},"additional-interface"),"."),Object(i.b)("p",null,"The following flow diagram summarizes the process followed by the HA Agent using information supplied by the Monitoring Agent, and resulting in interactions with the API Agent."),Object(i.b)("p",null,Object(i.b)("img",{alt:"HA Agent Flow Diagram",src:n(573).default})),Object(i.b)("p",null,"An HA Agent configured with a priority of 1 will be defined as the Primary node; a priority of 2 becomes the Secondary node. "),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Primary: This node is preferred to be active except when the local node is unhealthy."),Object(i.b)("li",{parentName:"ul"},"Secondary: This node is preferred to become active only when the local node is healthy and the remote node is unhealthy or unreachable.")),Object(i.b)("p",null,"The internal state machines wait for the value set in seconds in ",Object(i.b)("inlineCode",{parentName:"p"},"up-holddown-timeout")," before considering a node healthy. If at any point during that wait the HA Agent receives an unhealthy status, the timeout will be reset and the node is considered unhealthy."),Object(i.b)("p",null,"The internal state machines wait for the ",Object(i.b)("inlineCode",{parentName:"p"},"peer-reachability-timeout")," after every health status before considering the node unreachable. The timer is reset if a health report is processed before the timeout expires."),Object(i.b)("p",null,"When the HA Agent determines that a node must become active, the first active redundant interface's mac address and the list of configured prefixes are sent to the API Agent's appropriate REST endpoint. The HA Agent changes the provisional status of the configured ",Object(i.b)("inlineCode",{parentName:"p"},"redundant-interface")," to ",Object(i.b)("strong",{parentName:"p"},"Up"),". "),Object(i.b)("h3",{id:"api-agents"},"API Agents"),Object(i.b)("p",null,"The job of the API Agent is to perform failover actions specific to the cloud provider and the chosen solution."),Object(i.b)("h4",{id:"azure-loadbalancer"},"Azure Loadbalancer"),Object(i.b)("p",null,"A ",Object(i.b)("inlineCode",{parentName:"p"},"solution-type")," of ",Object(i.b)("inlineCode",{parentName:"p"},"azure-lb")," can be used to enable the Azure Loadbalancer API agent. This solution requires an ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview"}),"Azure Loadbalancer")," to be configured using an HTTP probe on the ",Object(i.b)("inlineCode",{parentName:"p"},"probe-port")," with backend pools pointing towards the redundant interfaces. "),Object(i.b)("p",null,"Probe example:"),Object(i.b)("p",null,Object(i.b)("img",{alt:"Azure Loadblancer Probe Configuration",src:n(574).default})),Object(i.b)("p",null,"Backend Pool example:"),Object(i.b)("p",null,Object(i.b)("img",{alt:"Azure Loadblancer Backend Pool Configuration",src:n(575).default})),Object(i.b)("p",null,"The Azure Loadbalancer sends a health probe to the redundant 128T's redundant interfaces. These probes are routed through the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface, through a ",Object(i.b)("inlineCode",{parentName:"p"},"128T-azure-lb-nginx")," instance, and down to the Azure Loadbalancer API Agent. "),Object(i.b)("p",null,"The Azure Loadbalancer API Agent responds to the probes with a ",Object(i.b)("inlineCode",{parentName:"p"},"200")," status code when the current node is active and a ",Object(i.b)("inlineCode",{parentName:"p"},"500")," code when its inactive. A probe to the inactive node will not reach the 128T when the redundant interfaces are set provisionally down."),Object(i.b)("h4",{id:"azure-vnet"},"Azure VNET"),Object(i.b)("p",null,"A ",Object(i.b)("inlineCode",{parentName:"p"},"solution-type")," of ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet")," can be used to enable the Azure VNET API agent. It requires an Azure Route Table setup on the same VNET as the redundant interfaces. The Virtual Machines where these members are running must be granted the following permissions in order for the route updates to work correctly:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Microsoft.Network/routeTables/read"),Object(i.b)("li",{parentName:"ul"},"Microsoft.Network/networkInterfaces/read"),Object(i.b)("li",{parentName:"ul"},"Microsoft.Network/routeTables/routes/*/write"),Object(i.b)("li",{parentName:"ul"},"Microsoft.Network/routeTables/routes/read"),Object(i.b)("li",{parentName:"ul"},"Microsoft.Compute/virtualMachines/read"),Object(i.b)("li",{parentName:"ul"},"Microsoft.Network/virtualNetworks/read")),Object(i.b)("p",null,"The agent finds all of the route tables within the VNET using the Azure REST APIs. When a redundant interface becomes active, the agent updates the route tables for all the configured prefixes to point to that interface. The solution is designed to be idempotent, so the peer member's redundant interface will now be inactive. There is no update to the route table needed when becoming inactive."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"Microsoft.Network/virtualNetworks/read")," is only necessary when the plugin should discover and modify peer VNET route tables. This feature can be enabled by configuring ",Object(i.b)("inlineCode",{parentName:"p"},"include-peer-vnets")," to ",Object(i.b)("inlineCode",{parentName:"p"},"true"),"."),Object(i.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"To prevent routing loops, the solution will not update the Azure Route Tables assigned to a subnet that has an activating node's ",Object(i.b)("em",{parentName:"p"},"network interface"),"."))),Object(i.b)("h2",{id:"scenarios"},"Scenarios"),Object(i.b)("h3",{id:"both-healthy"},"Both Healthy"),Object(i.b)("p",null,"In the case where both members are healthy, the primary node is preferred and set to active. The secondary node is inactive. The redundant interface on the secondary node is set provisionally down and the API Agent steers traffic towards the primary node."),Object(i.b)("p",null,Object(i.b)("img",{alt:"both-healthy-scenario",src:n(301).default})),Object(i.b)("h3",{id:"primary-failure"},"Primary Failure"),Object(i.b)("p",null,"When the ",Object(i.b)("strong",{parentName:"p"},"primary node")," becomes unhealthy and the redundant interfaces are operationally down, the Monitoring Agent sends an unhealthy status to the local HA Agent. When the ",Object(i.b)("strong",{parentName:"p"},"local node")," is deemed unhealthy, the local HA Agent sends an unhealthy message to the remote HA Agent, and notifies the internal state machine. When the ",Object(i.b)("strong",{parentName:"p"},"primary node")," recognizes it is no longer fit to process traffic, it becomes inactive. The ",Object(i.b)("strong",{parentName:"p"},"secondary node")," recognizes the primary node is not processing traffic, and the ",Object(i.b)("strong",{parentName:"p"},"secondary node")," is healthy so the secondary node becomes active."),Object(i.b)("p",null,Object(i.b)("img",{alt:"primary-failure-scenario",src:n(576).default})),Object(i.b)("h3",{id:"primary-recovery"},"Primary Recovery"),Object(i.b)("p",null,"Now something causes the primary node to recover and the ",Object(i.b)("inlineCode",{parentName:"p"},"redundant-interface")," becomes healthy again. The healthy statuses will propagate to the primary and secondary HA Agents and they will update their internal state machines which will determine that they are back to the Both Healthy Scenario. The primary node will become active and the secondary node will become inactive."),Object(i.b)("p",null,Object(i.b)("img",{alt:"both-healthy-scenario",src:n(301).default})),Object(i.b)("h3",{id:"secondary-failure"},"Secondary Failure"),Object(i.b)("p",null,"Now let us consider after recovering, the secondary node becomes unhealthy. The primary node will recognize that it is still healthy so it will not do anything and continue to process traffic. The secondary node will also realize that it is unfit to process traffic so it will also not do anything and continue sit idle."),Object(i.b)("p",null,Object(i.b)("img",{alt:"secondary-failure-scenario",src:n(577).default})),Object(i.b)("h3",{id:"secondary-recovery"},"Secondary Recovery"),Object(i.b)("p",null,"If the problem with the secondary node resolves, then the HA Agents will update their internal state, but again since traffic is preferred to flow the same as before, both the primary and secondary will not perform any API calls to the API Agents."),Object(i.b)("p",null,Object(i.b)("img",{alt:"secondary-recovery-scenario",src:n(578).default})),Object(i.b)("h3",{id:"primary-shutdown"},"Primary Shutdown"),Object(i.b)("p",null,"This scenario is what will occur if the primary node were to be taken down for maintenance or failed completely. The primary node's HA Agent (and Monitoring Agent and API Agent) will be shutdown when 128T is shutdown, so it will not perform any failover operations. The secondary node will wait for ",Object(i.b)("inlineCode",{parentName:"p"},"peer-reachability-timeout")," seconds of not hearing from the primary node to determine that the secondary node is unreachable. Once the primary node is determined unreachable, the secondary HA Agent will take over and become active since it does not know if the primary node is shutdown or unreachable."),Object(i.b)("p",null,Object(i.b)("img",{alt:"primary-shutdown-scenario",src:n(579).default})),Object(i.b)("h3",{id:"secondary-shutdown"},"Secondary Shutdown"),Object(i.b)("p",null,"If the secondary node is shutdown while the primary is healthy, the primary HA Agent will deteremine the secondary node unreachable. Similar to the the Secondary Failure scenario, since the primary node is preferred, it will not do anything and continue to process traffic."),Object(i.b)("p",null,Object(i.b)("img",{alt:"secondary-shutdown-scenario",src:n(580).default})),Object(i.b)("h3",{id:"split-brain"},"Split Brain"),Object(i.b)("p",null,"This is slightly distinct from the Primary Shutdown or Secondary Shutdown because both nodes and HA Agents are up and running, but the peer link between the nodes is down. In this case, both HA Agents determine that the other HA Agent is unreachable. This is indistinguisable from the other node being shutdown, so both HA Agents will determine they are in the position to take control of traffic, so whichever node was not already active will become active. This means that both nodes will have their ",Object(i.b)("inlineCode",{parentName:"p"},"redundant-interface"),"s provisionally up. For the ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet")," solution, there will still only be one node that the route tables are pointing their routes towards due to the nature of the solution. For the ",Object(i.b)("inlineCode",{parentName:"p"},"azure-lb")," solution, both nodes will respond to the probes so traffic will be split according to the Azure Loadbalancer configuration. This situation can cause asymmetrical routing where if branch traffic comes in on the node that the solution is not pointed towards, then traffic will be sent into Azure through that node and come back in through the other node."),Object(i.b)("p",null,"The split brain scenario can be identified if the peers can't reach each other which will be captured with alarms:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"# show alarms\n\n========================= ===================== ========== ======== =========== =======================================\n ID                        Time                  Severity   Source   Category    Message\n========================= ===================== ========== ======== =========== =======================================\n router.node:11            2020-12-16 05:40:40   CRITICAL   router2    PEER      Peer router2 is not reachable\n router2.node2:10          2020-12-16 05:40:42   CRITICAL   router     PEER      Peer router is not reachable\n\n")),Object(i.b)("p",null,"Another indicator of a split brain scenario is having the ",Object(i.b)("inlineCode",{parentName:"p"},"remote-status")," be ",Object(i.b)("inlineCode",{parentName:"p"},"unreachable")," for the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"#state-fields"}),"state output")," for both members."),Object(i.b)("p",null,Object(i.b)("img",{alt:"split-brain-scenario",src:n(581).default})),Object(i.b)("h3",{id:"split-brain-resolution"},"Split Brain Resolution"),Object(i.b)("p",null,"Once the health statuses are able to flow between the two nodes, the unreachable status that each Cloud HA Agent has for the other node will resolve to healthy or unhealthy. Even if the determination of whether the node is the same as it was before, each HA Agent will still set the provisional statuses and make the appropriate HTTP call on API Agent. This is because each node does not know what calls the other node made while the split brain was occurring, so it is safer to make calls even if it may not be necessary. Consider the scenario where the primary node is active and the secondary node is inactive before a split brain. When the split brain occurs, the secondary will then become active. If this is with a solution like ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet"),", the last node to hit the API Agent will be the one that the solution point to. Thus the secondary node will be the active node from the Azure Route Table's perspective. Once the split brain is resolved, without the extra API calls, the primary would stay active without making any API calls and the secondary would become inactive. The problem with this is that the last node to trigger the API Agent was the secondary node so all branch bound traffic would be sent into interfaces that are provisionally down. The plugin solves this by reperforming API calls when it detects that the remote node goes from unreachable to not unreachable."),Object(i.b)("p",null,Object(i.b)("img",{alt:"both-healthy-scenario",src:n(301).default})),Object(i.b)("h2",{id:"configuration"},"Configuration"),Object(i.b)("h3",{id:"groups"},"Groups"),Object(i.b)("p",null,"A group is a collection of nodes which all share the same settings such as the solution type. In the below configuration snippet, there is an example of each of the supported solution types with the solution-specific configuration explicitly configured with their defaults. ",Object(i.b)("inlineCode",{parentName:"p"},"group1")," has all of the solution-agnostic configuration settings explicitly configured with their defaults."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"authority\n    cloud-redundandy-group group1\n        name group1\n        enabled true\n        solution-type azure-lb\n        additional-branch-prefix 1.1.1.1/32\n        additional-branch-prefix 2.2.2.2/24\n        up-holddown-timeout 2\n        peer-reachability-timeout 10\n        remote-health-network 169.254.180.0/24\n        health-interval 2\n    exit\n    cloud-redundandy-group group2\n        name group2\n        solution-type azure-vnet\n        include-peer-vnets false\n    exit\nexit\n")),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Element"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Type"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Properties"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null})))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"name"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"string"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"key"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The name of the group to be referenced in other places."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"enabled"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"boolean"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: true"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Whether the group is enabled."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"solution-type"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"enum"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"required"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The solution to use on member nodes.  Value can be one of the values in #Supported Solutions."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"additional-branch-prefix"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"list: ip-prefix"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null})),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Additional ip prefixes that the member routers will control."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"up-holddown-timeout"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"int"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: 2"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The number of seconds to wait before declaring a member up."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"peer-reachability-timeout"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"int"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: 10"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The number of seconds to wait before declaring a peer unreachable. This field must be at least twice the value of ",Object(i.b)("inlineCode",{parentName:"td"},"health-interval"),"."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"health-interval"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"int"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: 2"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The interval in seconds for health reports to be collected."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"remote-health-network"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"ip-prefix"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: 169.254.180.0/24"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ip prefix to use for inter-member health status messages."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"include-peer-vnets"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"boolean"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"if: solution-type = azure-vnet, default: false"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Whether to include peer VNETs as part of the route table discovery algorithm."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"probe-port"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"port"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"if: solution-type = azure-lb, default: 12801"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The port that the Azure Loadbalancer will be sending the HTTP probes on."),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}))))),Object(i.b)("h3",{id:"membership"},"Membership"),Object(i.b)("p",null,"Membership is how a node declares that it is part of a group. The configuration for a membership exists under the node and is where the node-specific configuration exists."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"node\n    cloud-redundancy-plugin-network 169.254.137.0/30\n\n    cloud-redundancy-membership group1\n        cloud-redundancy-group group1\n        priority 1\n        redundant-interface private\n        redundant-interface private2\n        additional-interface public1\n        additional-interface public2\n        log-level\n            ha-agent info\n            api-agent info\n        exit\n    exit\nexit\n\n...\n\nnode\n    cloud-redundancy-membership group1\n        cloud-redundancy-group group1\n        priority 2\n        redundant-interface private\n    exit\nexit\n")),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Element"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Type"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Properties"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"cloud-redundancy-plugin-network"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"ip-network"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: 169.254.137.0/30"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ip network to use for internal networking. This should only be configured when the default value conflicts with a different service in the configuration.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"cloud-redundancy-group"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"reference"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"required"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The group that this member belongs to.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"priority"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"int"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"min-value: 1, max-value:2"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The priority of the member where lower priority has higher preference.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"redundant-interface"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"list: reference"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"min-number: 1"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ",Object(i.b)("em",{parentName:"td"},"device interfaces")," that will be redundant with the ",Object(i.b)("inlineCode",{parentName:"td"},"redundant-interfaces")," on the peer members.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"additional-interface"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"list: reference"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null})),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The ",Object(i.b)("em",{parentName:"td"},"device interfaces")," that will be considered for node health, but not considered for redundant operations.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"log-level/ha-agent"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"log-level"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: info"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The log level for the HA Agent.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"log-level/api-agent"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"log-level"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"default: info"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The log level for the active API Agent.")))),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"Nodes can only be members of one group."))),Object(i.b)("h3",{id:"address-prefixes"},"Address Prefixes"),Object(i.b)("p",null,"Certain prefixes can be configured to be controlled by the Cloud HA 128T by tagging services with groups. The services that are tagged with a certain group will have all of their ",Object(i.b)("inlineCode",{parentName:"p"},"address")," fields added to the list of configured prefixes."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"service\n    address 3.3.3.3\n    address 4.4.4.4/24\n    cloud-redundancy-group group1\n    cloud-redundancy-group azure-vnet\nexit\n")),Object(i.b)("p",null,"Any additional prefixes that should be included in the controlled prefix list can be configured as ",Object(i.b)("inlineCode",{parentName:"p"},"additional-branch-prefix"),"s under the group."),Object(i.b)("h2",{id:"generated-128t-configuration"},"Generated 128T Configuration"),Object(i.b)("p",null,"To see a full blown configuration and the configuration it generates, look at ",Object(i.b)("inlineCode",{parentName:"p"},"Complete Example Configuration")," in the ",Object(i.b)("inlineCode",{parentName:"p"},"Appendix"),"."),Object(i.b)("h3",{id:"validation"},"Validation"),Object(i.b)("p",null,"The following criteria need to be met in order for the cloud-ha plugin to take effect for a specific group:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Priorities across all members in a group are unique."),Object(i.b)("li",{parentName:"ul"},"IP Network fields such as ",Object(i.b)("inlineCode",{parentName:"li"},"remote-health-network")," and ",Object(i.b)("inlineCode",{parentName:"li"},"cloud-redundancy-plugin-network")," are validated to be an acceptable prefix size."),Object(i.b)("li",{parentName:"ul"},"The ",Object(i.b)("inlineCode",{parentName:"li"},"peer-reachability-timeout")," for a group must be at least twice the amount of time as the ",Object(i.b)("inlineCode",{parentName:"li"},"health-interval"),".")),Object(i.b)("p",null,"Please check ",Object(i.b)("inlineCode",{parentName:"p"},"/var/log/128technology/plugins/cloud-ha-config-generation.log")," on the Conductor for the errors causing the config to be invalid."),Object(i.b)("h3",{id:"configuration-assumptions"},"Configuration Assumptions"),Object(i.b)("p",null,"The components that are assumed to be setup already:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"There is at least one functioning forwarding ",Object(i.b)("em",{parentName:"li"},"device interface")," on each of the member nodes."),Object(i.b)("li",{parentName:"ul"},"There is peering between member nodes if the member nodes are not under the same router.")),Object(i.b)("h3",{id:"cloud-ha-loopback-interface"},"Cloud HA Loopback Interface"),Object(i.b)("p",null,"An interface with the name ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," is generated for each node that is a member of an enabled group. This interface is used for the solution to communicate with the other group members and any other outside entities such as a load balancer."),Object(i.b)("h3",{id:"health-status-transport"},"Health Status Transport"),Object(i.b)("p",null,"To facilitate the transport of the health status between members of the same group, the plugin generates services and service routes. Services are generated to classify the health summaries that each member sends to its peers. The address that they use is an address from the network defined in ",Object(i.b)("inlineCode",{parentName:"p"},"remote-health-network")," under the group config. If the two nodes are under different routers in the configuration, then peer service routes will be generated."),Object(i.b)("h3",{id:"azure-load-balancer-config-generation"},"Azure Load Balancer Config Generation"),Object(i.b)("p",null,"If the ",Object(i.b)("inlineCode",{parentName:"p"},"solution-type")," of a group is ",Object(i.b)("inlineCode",{parentName:"p"},"azure-lb"),", then the plugin will generate services and service routes to route the http probes down into the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface for the Azure Load Balancer API Agent to respond to. "),Object(i.b)("h2",{id:"troubleshooting"},"Troubleshooting"),Object(i.b)("h3",{id:"configuration-generation"},"Configuration Generation"),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"/var/log/128technology/persistentDataManager.log")," file at trace level will hold whether the configuration generation was run as well as output and return code.\nConfiguration generation logs can be found on the conductor under ",Object(i.b)("inlineCode",{parentName:"p"},"/var/log/128technology/plugins/cloud-ha-config-generation.log"),"."),Object(i.b)("p",null,"Additional configuration validation is done without causing a traditional validation error. These validation rules will cause the configuration generation to fail for just that group. If the configuration generation is not generating what is expected, then check ",Object(i.b)("inlineCode",{parentName:"p"},"/var/log/128technology/plugins/cloud-ha-config-generation.log")," for validation errors similar to these:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"2020-10-09 19:54:21,190: ERROR - Validation errors occurred:\nGroup group1 does not have unique priorities across members: {'node2 router2': '2', 'node1 router1': '2'}\n")),Object(i.b)("h3",{id:"logging"},"Logging"),Object(i.b)("p",null,"The different services on the router all log to the files captured by the glob ",Object(i.b)("inlineCode",{parentName:"p"},"/var/log/128technology/plugins/cloud-ha-*.log")),Object(i.b)("h3",{id:"pcli-enhancements"},"PCLI Enhancements"),Object(i.b)("p",null,"To check the state of the Cloud HA solution running on the router, the plugin adds output to the  ",Object(i.b)("inlineCode",{parentName:"p"},"show device-interface")," command for the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface. This state information is also accessible from the 128T's public REST API with a ",Object(i.b)("inlineCode",{parentName:"p"},"GET")," on ",Object(i.b)("inlineCode",{parentName:"p"},"/api/v1/router/<router>/node/<node>/cloud-ha/state"),"."),Object(i.b)("h4",{id:"state-fields"},"State Fields"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Field"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"is-active"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Whether the HA Agent considers itself active.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"last-activity-change"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The timestamp of the last time the node called the became active or became inactive API on the API Agent.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"first-active-interface"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The name of the first interface from the list of ",Object(i.b)("inlineCode",{parentName:"td"},"redundant-interface"),"s that is healthy.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"first-active-mac-address"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The mac address of the first interface from the list of ",Object(i.b)("inlineCode",{parentName:"td"},"redundant-interface"),"s that is healthy.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"prefixes"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The list of configured prefixes. See ",Object(i.b)("inlineCode",{parentName:"td"},"Address Prefixes"),".")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"local-status"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The understood state of the local node.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"remote-status"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The understood state of the remote node.")))),Object(i.b)("p",null,"Example output for the ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet")," solution:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"# show device-interface name cloud-ha\n\n======================================================\n node1.router1:cloud-ha\n======================================================\n Type:                host\n Forwarding:          true\n Mode:                host\n MAC Address:         92:39:db:ab:fa:e4\n\n Admin Status:        up\n Operational Status:  up\n Redundancy Status:   non-redundant\n Speed:               1 Gb/s\n Duplex:              full\n\n in-octets:                     5653457\n in-unicast-pkts:                 57794\n in-errors:                           0\n out-octets:                    5648738\n out-unicast-pkts:                57863\n out-errors:                          0\n\n Cloud HA:\n     is-active:       True\n     last-activity-change:Mon 2020-10-05 19:07:42 UTC\n     first-active-interface:private\n     first-active-mac-address:00:0d:3a:4e:17:b7\n     prefixes:\n     local-status:    healthy\n     remote-status:   healthy\n\nCompleted in 1.67 seconds\n")),Object(i.b)("p",null,"Example output for the ",Object(i.b)("inlineCode",{parentName:"p"},"azure-lb")," solution:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"# show device-interface name cloud-ha\n\n======================================================\n node1.router1:cloud-ha\n======================================================\n Type:                host\n Forwarding:          true\n Mode:                host\n MAC Address:         92:39:db:ab:fa:e4\n\n Admin Status:        up\n Operational Status:  up\n Redundancy Status:   non-redundant\n Speed:               1 Gb/s\n Duplex:              full\n\n in-octets:                     6126820\n in-unicast-pkts:                 62630\n in-errors:                           0\n out-octets:                    6120618\n out-unicast-pkts:                62701\n out-errors:                          0\n\n Cloud HA:\n     is-active:       True\n     last-activity-change:Mon 2020-10-05 20:18:15 UTC\n     first-active-interface:private\n     first-active-mac-address:00:0d:3a:4e:17:b7\n     prefixes:\n     local-status:    healthy\n     remote-status:   healthy\n\nCompleted in 1.72 seconds\n")),Object(i.b)("h3",{id:"systemd-services"},"Systemd Services"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"128T-telegraf@cloud_ha_health"),": the instance of the monitoring agent that produces the health statuses"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"128T-cloud-ha"),": the decision making Cloud HA Agent"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"128T-azure-lb")," and ",Object(i.b)("inlineCode",{parentName:"li"},"128T-azure-lb-nginx"),": the ",Object(i.b)("inlineCode",{parentName:"li"},"azure-lb")," specific services"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"128T-azure-api"),": the ",Object(i.b)("inlineCode",{parentName:"li"},"azure-vnet")," specific service")),Object(i.b)("h3",{id:"manual-failover"},"Manual Failover"),Object(i.b)("p",null,"This should only be done in an emergency, but if the plugin is not behaving as expected, there is a script to manually set the activity status of the nodes. First you need to disable the HA Agents by running ",Object(i.b)("inlineCode",{parentName:"p"},"/usr/bin/t128_cloud_ha_controller disable")," on both nodes. This step disables the automatic API calls of the HA Agent to ensure that the following manual changes will not be overridden. Then you can run ",Object(i.b)("inlineCode",{parentName:"p"},"/usr/bin/t128_cloud_ha_controller become-active")," to become active and ",Object(i.b)("inlineCode",{parentName:"p"},"/usr/bin/t128_cloud_ha_controller become-inactive")," to become inactive. The commands should be done together at the most similar time as possible to minimize convergence time. It is better to perform the ",Object(i.b)("inlineCode",{parentName:"p"},"become-active")," first to allow traffic and then ",Object(i.b)("inlineCode",{parentName:"p"},"become-inactive")," second to disallow traffic. The HA Agents can be re-enabled with the command ",Object(i.b)("inlineCode",{parentName:"p"},"/usr/bin/t128_cloud_ha_controller enable"),"."),Object(i.b)("h3",{id:"alarms"},"Alarms"),Object(i.b)("p",null,"If the Cloud HA Agent does not come up cleanly or fails for a prolonged period of time, the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface will become operationally down. An alarm will be created when this happens."),Object(i.b)("p",null,"Example output when the agent did not come up cleanly:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-admin@combo-west.RTR_WEST_COMBO#",metastring:"show alarms",show:!0,alarms:!0}),"Tue 2020-10-09 16:42:50 UTC\n\n============== ===================== ========== ============= =========== ======================================\n ID             Time                  Severity   Source        Category    Message\n============== ===================== ========== ============= =========== ======================================\n combo-west:8   2020-06-30 16:32:42   critical   unavailable   interface   Intf cloud-ha (4) operationally down\n\nThere are 0 shelved alarms\nCompleted in 0.10 seconds\n")),Object(i.b)("h3",{id:"router-version-incompatibility"},"Router Version Incompatibility"),Object(i.b)("p",null,"As mentioned in the ",Object(i.b)("inlineCode",{parentName:"p"},"Version Restrictions")," section, the router component of the plugin will only install on 128T versions which support the provisional device interface state. This will be apparent to the user if the router component is not being setup and ",Object(i.b)("inlineCode",{parentName:"p"},"show assets")," indicates an error similar to:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"Error:\n    Problem: conflicting requests\n    - nothing provides 128T-device-interface-api(1.0) needed by 128T-cloud-ha-router-1.1.0-1.x86_64\n")),Object(i.b)("p",null,"The router will need to be upgraded to a compatible version. Compatible versions can be listed with  ",Object(i.b)("inlineCode",{parentName:"p"},"dnf list --whatprovides 128T-device-interface-api(1.0)"),"."),Object(i.b)("h2",{id:"appendix"},"Appendix"),Object(i.b)("h3",{id:"health-status-transport-1"},"Health Status Transport"),Object(i.b)("p",null,"With the example configuration, we will generate the services below:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"service                 cloud-ha-service-group1-2\n    name                  cloud-ha-service-group1-2\n\n    applies-to            router\n        type         router\n        router-name  router1\n        router-name  router2\n    exit\n    security              internal\n    address               169.254.180.2\n\n    access-policy         cloud-ha\n        source      cloud-ha\n        permission  allow\n    exit\n    share-service-routes  false\nexit\n\nservice                 cloud-ha-service-group1-1\n    name                  cloud-ha-service-group1-1\n\n    applies-to            router\n        type         router\n        router-name  router1\n        router-name  router2\n    exit\n    security              internal\n    address               169.254.180.1\n\n    access-policy         cloud-ha\n        source      cloud-ha\n        permission  allow\n    exit\n    share-service-routes  false\nexit\n\n")),Object(i.b)("p",null,"Corresponding service routes to route them into the ",Object(i.b)("inlineCode",{parentName:"p"},"cloud-ha")," interface will be generated."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"router router1\n    service-route        cloud-ha-service-route-group1-1\n        name          cloud-ha-service-route-group1-1\n        service-name  cloud-ha-service-group1-1\n        nat-target    169.254.137.2\n    exit\nexit\n\nrouter router2\n    service-route        cloud-ha-service-route-group1-2\n        name          cloud-ha-service-route-group1-2\n        service-name  cloud-ha-service-group1-2\n        nat-target    169.254.137.2\n    exit\nexit\n")),Object(i.b)("p",null,"If the two nodes are under different routers in the configuration, this would produce service routes:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"router router1\n    service-route        cloud-ha-peer-service-route-group1-2\n        name          cloud-ha-peer-service-route-group1-2\n        service-name  cloud-ha-service-group1-2\n        peer          router2\n    exit\nexit\n\nrouter router2\n    service-route        cloud-ha-peer-service-route-group1-1\n        name          cloud-ha-peer-service-route-group1-1\n        service-name  cloud-ha-service-group1-1\n        peer          router1\n    exit\nexit\n")),Object(i.b)("h3",{id:"azure-loadbalancer-configuration-generation"},"Azure Loadbalancer Configuration Generation"),Object(i.b)("p",null,"With the example configuration, this would result in the following services being generated:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"service                 cloud-ha-lb-probe-service-group1-2\n    name                  cloud-ha-lb-probe-service-group1-2\n\n    applies-to            router\n        type         router\n        router-name  router2\n    exit\n    security              internal\n\n    transport             tcp\n        protocol    tcp\n\n        port-range  12801\n            start-port  12801\n        exit\n    exit\n    address               1.1.1.2\n\n    access-policy         private\n        source      private\n        permission  allow\n    exit\n    share-service-routes  false\nexit\n\nservice                 cloud-ha-lb-probe-service-group1-1\n    name                  cloud-ha-lb-probe-service-group1-1\n\n    applies-to            router\n        type         router\n        router-name  router1\n    exit\n    security              internal\n\n    transport             tcp\n        protocol    tcp\n\n        port-range  12801\n            start-port  12801\n        exit\n    exit\n    address               1.1.1.1\n\n    access-policy         private\n        source      private\n        permission  allow\n    exit\n    share-service-routes  false\nexit\n")),Object(i.b)("p",null,"There would also be corresponding service routes generated:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"router router1\n    service-route        cloud-ha-lb-probe-service-route-group1-1\n        name          cloud-ha-lb-probe-service-route-group1-1\n        service-name  cloud-ha-lb-probe-service-group1-1\n        nat-target    169.254.137.2\n    exit\nexit\n\nrouter router2\n    service-route        cloud-ha-lb-probe-service-route-group1-2\n        name          cloud-ha-lb-probe-service-route-group1-2\n        service-name  cloud-ha-lb-probe-service-group1-2\n        nat-target    169.254.137.2\n    exit\nexit\n")),Object(i.b)("h3",{id:"complete-example-configuration"},"Complete Example Configuration"),Object(i.b)("p",null,"Below is an example of a complete, but minimal configuration entered by the user."),Object(i.b)("div",{className:"admonition admonition-warning alert alert--danger"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})))),"warning")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"This example configuration is good to understand all of the concepts but should not be used on a system as is."))),Object(i.b)("p",null,"This example uses ",Object(i.b)("inlineCode",{parentName:"p"},"azure-lb")," since it results in a superset of the configuration generated ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet"),". If you are interested in ",Object(i.b)("inlineCode",{parentName:"p"},"azure-vnet"),", then ignore the probe-specific services and service routes in the generated config."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"config\n    authority\n        tenant private\n        exit\n\n        cloud-redundandy-group group1\n            name group1\n            solution-type azure-lb\n        exit\n\n        router               router1\n\n            node node1\n                device-interface          private\n                    name               private\n\n                    network-interface  privateintf\n                        name          privateintf\n                        tenant        private\n\n                        address       1.1.1.1\n                            ip-address     1.1.1.1\n                            prefix-length  24\n                            gateway        1.1.1.3\n                        exit\n                    exit\n                exit\n\n                device-interface          intracloud\n                    name               intracloud\n\n                    network-interface  intracloudintf\n                        name          intracloudintf\n                        \n                        inter-router-security internal\n                        neighborhood intracloud\n                            name intracloud\n                            topology mesh\n                        exit\n\n                        address       2.2.2.1\n                            ip-address     2.2.2.1\n                            prefix-length  24\n                            gateway        2.2.2.3\n                        exit\n                    exit\n                exit\n\n                cloud-redundancy-membership group1\n                    cloud-redundancy-group group1\n                    priority 1\n                    redundant-interface private\n                exit\n            exit\n        exit\n\n        router               router2\n\n            node node1\n                device-interface          private\n                    name               private\n\n                    network-interface  privateintf\n                        name          privateintf\n                        tenant        private\n\n                        address       1.1.1.2\n                            ip-address     1.1.1.2\n                            prefix-length  24\n                            gateway        1.1.1.3\n                        exit\n                    exit\n                exit\n\n                device-interface          intracloud\n                    name               intracloud\n\n                    network-interface  intracloudintf\n                        name          intracloudintf\n                        \n                        inter-router-security internal\n                        neighborhood intracloud\n                            name intracloud\n                            topology mesh\n                        exit\n\n                        address       2.2.2.2\n                            ip-address     2.2.2.2\n                            prefix-length  24\n                            gateway        2.2.2.3\n                        exit\n                    exit\n                exit\n\n                cloud-redundancy-membership group1\n                    cloud-redundancy-group group1\n                    priority 2\n                    redundant-interface private\n                exit\n            exit\n        exit\n    exit\nexit\n")),Object(i.b)("p",null,"Upon commit, the plugin will generate other configuration as shown below:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),'config\n    authority\n        tenant                  cloud-ha\n            name         cloud-ha\n            description  "Auto-generated tenant for cloud ha"\n        exit\n\n        router router1\n            node node1\n                device-interface             cloud-ha\n                    name               cloud-ha\n                    description        "Auto-generated host KNI interface for cloud ha"\n                    type               host\n\n                    network-interface  cloud-ha-intf\n                        name        cloud-ha-intf\n                        type        external\n                        tenant      cloud-ha\n                        source-nat  true\n\n                        address     169.254.137.1\n                            ip-address     169.254.137.1\n                            prefix-length  30\n                            gateway        169.254.137.2\n                        exit\n                    exit\n                exit\n            exit\n\n            service-route        cloud-ha-service-route-group1-1\n                name          cloud-ha-service-route-group1-1\n                service-name  cloud-ha-service-group1-1\n                nat-target    169.254.137.2\n            exit\n\n            service-route        cloud-ha-peer-service-route-group1-2\n                name          cloud-ha-peer-service-route-group1-2\n                service-name  cloud-ha-service-group1-2\n                peer          router2\n            exit\n\n            service-route        cloud-ha-lb-probe-service-route-group1-1\n                name          cloud-ha-lb-probe-service-route-group1-1\n                service-name  cloud-ha-lb-probe-service-group1-1\n                nat-target    169.254.137.2\n            exit\n        exit\n\n        router router2\n            node node1\n                device-interface             cloud-ha\n                    name               cloud-ha\n                    description        "Auto-generated host KNI interface for cloud ha"\n                    type               host\n\n                    network-interface  cloud-ha-intf\n                        name        cloud-ha-intf\n                        type        external\n                        tenant      cloud-ha\n                        source-nat  true\n\n                        address     169.254.137.1\n                            ip-address     169.254.137.1\n                            prefix-length  30\n                            gateway        169.254.137.2\n                        exit\n                    exit\n                exit\n            exit\n\n            service-route        cloud-ha-service-route-group1-2\n                name          cloud-ha-service-route-group1-2\n                service-name  cloud-ha-service-group1-2\n                nat-target    169.254.137.2\n            exit\n\n            service-route        cloud-ha-peer-service-route-group1-1\n                name          cloud-ha-peer-service-route-group1-1\n                service-name  cloud-ha-service-group1-1\n                peer          router1\n            exit\n\n            service-route        cloud-ha-lb-probe-service-route-group1-2\n                name          cloud-ha-lb-probe-service-route-group1-2\n                service-name  cloud-ha-lb-probe-service-group1-2\n                nat-target    169.254.137.2\n            exit\n        exit\n\n        service                 cloud-ha-lb-probe-service-group1-2\n            name                  cloud-ha-lb-probe-service-group1-2\n\n            applies-to            router\n                type         router\n                router-name  router2\n            exit\n            security              internal\n\n            transport             tcp\n                protocol    tcp\n\n                port-range  12801\n                    start-port  12801\n                exit\n            exit\n            address               1.1.1.2\n\n            access-policy         private\n                source      private\n                permission  allow\n            exit\n            share-service-routes  false\n        exit\n\n        service                 cloud-ha-lb-probe-service-group1-1\n            name                  cloud-ha-lb-probe-service-group1-1\n\n            applies-to            router\n                type         router\n                router-name  router1\n            exit\n            security              internal\n\n            transport             tcp\n                protocol    tcp\n\n                port-range  12801\n                    start-port  12801\n                exit\n            exit\n            address               1.1.1.1\n\n            access-policy         private\n                source      private\n                permission  allow\n            exit\n            share-service-routes  false\n        exit\n\n        service                 cloud-ha-service-group1-2\n            name                  cloud-ha-service-group1-2\n\n            applies-to            router\n                type         router\n                router-name  router1\n                router-name  router2\n            exit\n            security              internal\n            address               169.254.180.2\n\n            access-policy         cloud-ha\n                source      cloud-ha\n                permission  allow\n            exit\n            share-service-routes  false\n        exit\n\n        service                 cloud-ha-service-group1-1\n            name                  cloud-ha-service-group1-1\n\n            applies-to            router\n                type         router\n                router-name  router1\n                router-name  router2\n            exit\n            security              internal\n            address               169.254.180.1\n\n            access-policy         cloud-ha\n                source      cloud-ha\n                permission  allow\n            exit\n            share-service-routes  false\n        exit\n    exit\nexit\n')),Object(i.b)("h2",{id:"release-notes"},"Release Notes"),Object(i.b)("h3",{id:"release-300"},"Release 3.0.0"),Object(i.b)("h4",{id:"issues-fixed"},"Issues Fixed"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("strong",{parentName:"li"},"PLUGIN-768")," Support the Cloud HA plugin in 128T versions ",Object(i.b)("inlineCode",{parentName:"li"},"5.1.0")," and greater.")))}b.isMDXComponent=!0},225:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=r.a.createContext({}),b=function(e){var t=r.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=b(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},p=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=b(n),p=a,h=d["".concat(o,".").concat(p)]||d[p]||u[p]||i;return n?r.a.createElement(h,l(l({ref:t},s),{},{components:n})):r.a.createElement(h,l({ref:t},s))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=p;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},301:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-both-healthy-scenario-da33d383ca2729425f2f21b2fde4561a.png"},572:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-architecture-347bc488da8f21bedb0da9f1cd562a8f.png"},573:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-ha-agent-flow-diagram-1508de7b8a95497ed25571e40b41451d.png"},574:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-azure-lb-probe-config-2797db24e4678a45df16de5e2d8dcda7.png"},575:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-azure-lb-backend-pool-config-fec533861724cfbc1c723bbca45b332e.png"},576:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-primary-failure-scenario-61a5bfef1e2d2b36299756e0d1eda755.png"},577:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-secondary-failure-scenario-01c12db4240126767aa1e7e16297b507.png"},578:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-secondary-recovery-scenario-2852dbcd653070aadcf15d69d5432652.png"},579:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-primary-shutdown-scenario-044f8017a5b506aead38404306b3e0e8.png"},580:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-secondary-shutdown-scenario-0e31057330e473ab41d153fdf72abacd.png"},581:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/cloud-ha-split-brain-scenario-84ab365c12b5b6b7f17163bb9b9e4d3f.png"}}]);