---
title: Configuration Integrity
sidebar_label: Configuration Integrity
--- 

#### Version History

| Release | Modification                |
| ------- | --------------------------- |
| 7.1.3   | SSR Configuration Integrity added. |

SSR Configuration Integrity addresses security requirements for protecting sensitive data stored on SSR devices when they are at rest - when a system is powered off for extended periods, physically stolen, or have their storage media removed and analyzed offline by malicious actors seeking to extract sensitive information or compromise network security. 

SSR devices are frequently deployed in environments where physical security cannot be guaranteed, ranging from remote branch offices and retail locations to temporary installations and field deployments. In these environments, configuration files, private keys, and operational data stored on the device require protection from unauthorized access. 

Modern compliance requirements and regulatory frameworks mandate encryption-at-rest for sensitive data, particularly in the financial services, healthcare, and government sectors. High-security customers require robust protection against data exfiltration to maintain their security posture and meet regulatory obligations. These requirements have evolved beyond simple access controls to demand cryptographic protection of stored credentials, configuration data, and private key material that could be exploited to compromise broader network infrastructure.

SSR Configuration Integrity protects authentication credentials, keys and certificates, network topology information, and other pieces of sensitive SSR configuration from unauthorized access when the system is powered off Furthermore, Configuration Integrity prevents network and SSR operations from executing when the drive is determined to be in a compromised state. These protected secrets cannot be exfiltrated even if the bad actor has physical access to the drive, preventing attackers from impersonating network nodes or intercepting encrypted communications. Most importantly, it meets compliance requirements for encryption-at-rest without impacting runtime performance, allowing organizations to satisfy regulatory mandates while maintaining the high-performance networking capabilities that SSR devices are designed to provide.

Configuration Integrity does not address any runtime access-policy or permissions concerns. Proper file and directory permissions are still required, as well as proper login and authentication controls. Configuration Integrity augments the existing SSR security functionality to provide encryption-at-rest guarantees. 

Configuration Integrity is enabled by default on new installations of, and upgrades to, SSR 7.1.3-r2. 

## How It Works

Configuration Integrity utilizes a hybrid approach combining TPM2 hardware security with Linux native filesystem encryption, administered by the userspace tool fscrypt. fscrypt utilizes an AES-256 key generated and protected by the TPM to perform encryption and decryption operations. Once the encrypted directories are unlocked, they operate as a normal directory; the encryption is transparent to the user.

### Major Components

The following are the major components of Configuration Integrity. 

### TPM2 Hardware Security Module

The TPM is the trust anchor of the system. It creates and unseals the Filesystem Encryption Key (FEK), and is the only component of the system that can perform this task. If the storage of the SSR is somehow separated from the TPM, the FEK can no longer be unsealed, and the filesystem cannot be unlocked, ensuring that sensitive data remains protected.  

All SSR TPMs are provisioned with an RSA-2048 key, which is used to perform the encryption and decryption of the FEK.

### Filesystem Encryption Key (FEK)

The FEK is a 256-bit random number generated by the TPM. Once it has been generated, it is encrypted by the TPM using RSA-2048 before being written to disk. At no time will the unencrypted FEK be written on disk. Any time it is decrypted, it is stored in memory only.

### fscrypt 

fscrypt is a userspace interface to the Kernel-level filesystem and encryption stacks. It operates on a per-directory basis, leveraging either a PAM module, a passphrase, or a 256-bit raw key to unlock and decrypt the directory. The SSR uses only the raw key mode.

fscrypt requires that no target directory exist as a repository for decrypted files. Because technology allows the recovery of deleted files from a directory, the process of migrating files to an existing encrypted directory leaves traces of the unencrypted versions on disk resulting in a potential security risk. 

All sensitive files will be written to the encrypted directory from their inception onward, ensuring that there is no security risk. fscrypt configured in raw_key mode uses AES-256-XTS encryption for file contents and AES-256-CBC-CTS encryption for filenames. 

### Hardware Bootstrapper

The hardware bootstrapper is an existing component of the SSR, responsible for the initialization of the SSR during its first boot. It performs the enablement requirements check (detailed below) to verify that the system can support Configuration Integrity, and if so, go through the steps to enable it for the lifetime of the system.  This workflow will be explained in more detail in a later section.

### Configuration Integrity Systemd Service

This systemd service handles the subsequent boots of the SSR after Configuration Integrity has been enabled.  It runs a series of integrity checks, and identifies when the system is ready to continue operation after successful unlocking of the encrypted directories. When it is run, it performs the following sequence:

1.	Locate encrypted FEK on disk.
2.	Unseal FEK with the TPM.
3.	Pass unencrypted FEK to fscrypt.
4.	fscrypt uses the FEK to automatically unlock the necessary encrypted directories.

If any of these steps fail, it is interpreted as an integrity event, an emergency log is generated (which is also broadcast to all consoles on the system) that the system has had its integrity compromised and it must be reprovisioned. The SSR will repeatedly try to start the integrity service to unlock the encrypted directories and fail, each time writing the emergency log.

## Troubleshooting

Use the information below to investigate issues and understand the Configuration Integrity feature.

### Logging

Logging is handled through existing system components rather than a dedicated log category. During initial system provisioning, the Hardware Bootstrapper handles all Configuration Integrity initialization logging as part of its standard provisioning process. On subsequent boots, the systemd service that is responsible for unlocking encrypted directories logs all unlock operations and service status information through the systemd journal. This provides comprehensive visibility into the operational state of the encryption system during the boot sequence.

Key operational messages include TPM provisioning status and error conditions, filesystem encryption capability detection results, and detailed logging of FEK generation, storage, and retrieval operations. The system also logs all directory encryption and decryption operations along with integrity violation events that may trigger protective responses. 
