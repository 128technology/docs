<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">Using Saltstack at Scale With 128T | SSN Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.128technology.com/docs/bcp_salt_pillars"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Using Saltstack at Scale With 128T | SSN Docs"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.128technology.com/docs/bcp_salt_pillars"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/bcp_salt_pillars" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/bcp_salt_pillars" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.21b25f22.css">
<link rel="preload" href="/assets/js/runtime~main.1cff6756.js" as="script">
<link rel="preload" href="/assets/js/main.bf52851a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Juniper Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo_dark.png" alt="Juniper Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Session Smart</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro_getting_started">Docs</a><a href="https://community.juniper.net/answers/communities/community-home?CommunityKey=310d1a41-12fa-4627-9a99-880145a7c87c" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Session Smart Community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.juniper.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Company<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/about_128t">About</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_getting_started">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_system_reqs">Deployment Considerations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation">Installation Process</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_aws">Cloud Installations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_installer">Supporting Information - Appendix</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/concepts_application_discovery">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/config_basics">Administration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/events_overview">Events</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/bcp_att_avpn_configuration">Best Practices</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_att_avpn_configuration">AT&amp;T AVPN Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_using_128T_as_ntp_server">Branch NTP Service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_conductor_deployment">Conductor Deployment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_per-adjacency_traffic_engineering">Per Adjacency Traffic Engineering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_qos_msft_expressroute">ExpressRoute QoS Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_lte_peering">LTE Peering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_monitoring_headends">Monitoring Head End Routers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/bcp_salt_pillars">Saltstack at Scale With 128T</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_sdwan_design_guide">SD-WAN Design Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_service_and_service_policy_design">Service and Service Policy Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_service-policy_defaults">Service Policy Baseline Defaults</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/bcp_tenants">Tenancy Design</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/cli_reference">CLI and Element Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/installer_cli_reference">Installer/Initializer Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/plugin_intro">Plugins</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/release_notes_128t_5.5">Release Notes</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Using Saltstack at Scale With 128T</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>This guide is intended to provide methods for users to implement custom Saltstack functionality in a performant way that will not affect their ability to provision new systems at scale.</p><p>This guide is not intended to teach the users how to use Saltstack. This document will reference the Salt top file and Salt pillars. Some good resources for these topics are:</p><p><a href="https://docs.saltstack.com/en/latest/ref/states/top.html" target="_blank" rel="noopener noreferrer">Salt Top File</a></p><p><a href="https://docs.saltstack.com/en/latest/topics/tutorials/pillar.html" target="_blank" rel="noopener noreferrer">Salt Pillars</a></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="using-salt-with-128t">Using Salt with 128T<a class="hash-link" href="#using-salt-with-128t" title="Direct link to heading">​</a></h2><p>The 128T Conductor uses different Salt environments to logically separate the 128T specific Salt state and modules from any custom Salt modules implemented by the user. The locations for each environment are defined in the Salt-Master configuration file on the Conductor.</p><p><code>/etc/128technology/salt/master</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">file_roots:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  128T:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /usr/lib/128technology/python/salt/file_roots</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  base:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /srv/salt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  plugins:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /var/lib/128technology/plugins/salt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pillar_roots:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  128T:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /usr/lib/128technology/python/salt/pillar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  base:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /srv/pillar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  plugins:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - /var/lib/128technology/plugins/pillar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>128T</code> and <code>plugins</code> environments are managed by the Conductor and should not be modified. The <code>base</code> environment is left for the user to implement any custom Salt logic for their specific deployment. When a Salt Minion connects to the 128T Conductor the Salt-Master will execute the Salt highstate for each Salt environment automatically. The highstate consists of the states listed in the <code>top.sls</code> for each environment. By default the <code>top.sls</code> for the <code>base</code> environment performs a dummy state meant to serve as an example to users, but can be modified to perform states for the users specific deployment:</p><p><code>/srv/salt/top.sls</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">base:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;*&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - dummy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>/srv/salt/dummy.sls</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/dev/null:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  file.touch:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: /dev/null</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="using-salt-pillars">Using Salt Pillars<a class="hash-link" href="#using-salt-pillars" title="Direct link to heading">​</a></h2><p>Pillars are tree-like structures of data defined on the Salt-Master and passed through to Salt Minions. Salt pillars are intended to be used for confidential information as the information is encrypted and sent securely to the respective Salt Minion. The Salt Minion uses the pillar data assigned to its Minion ID to render Salt states before executing them. The following is an example of a common approach for using Salt pillars.</p><p>The pillar top file defines which pillars apply to which Salt Minions:</p><p><code>/srv/pillar/top.sls</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">base:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;*&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - common</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;Router1NodeA&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - router1A</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;Router1NodeB&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - router1B</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;Router999NodeA&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - router999A</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;Router999NodeB&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - router999B</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The ellipsis is not part of the syntax, it serves to illustrate there are a large number of Salt Minions</p></div></div><p>Each pillar file defined above contains the variables for a specific Salt Minion:</p><p><code>/srv/pillar/router1A.sls</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">configured_interfaces:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: eth0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address: &#x27;192.168.1.1&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    netmask: &#x27;255.255.255.254&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gateway: &#x27;192.168.1.2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: eth1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address: &#x27;172.16.0.1&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    netmask: &#x27;255.255.255.0&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gateway: &#x27;172.16.0.100&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>/srv/pillar/router1B.sls</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">configured_interfaces:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: eth0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address: &#x27;192.168.1.2&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    netmask: &#x27;255.255.255.254&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gateway: &#x27;192.168.1.1&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: eth1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address: &#x27;172.16.0.2&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    netmask: &#x27;255.255.255.0&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    gateway: &#x27;172.16.0.100&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The pillar data can be accessed as variables in Salt states and the Salt Minion will automatically render the state with the correct pillar information when the state is executed:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{%- set configured_interfaces = pillar.get(&#x27;configured_interfaces&#x27;) %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{%- for interface in configured_interfaces %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Interface {{ interface.name }}:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  network.managed:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - enabled: True</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - type: eth</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - ipaddr: {{ interface.address }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - netmask: {{ interface.netmask }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - gateway: {{ interface.gateway }}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - dns:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - 8.8.8.8</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - 8.8.4.4</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This approach quickly breaks down at scale. Each time a highstate is run the Salt-Master needs to parse the pillar top file and decide which pillar files apply to each Salt Minion. The top file supports glob matching and is not always a simple 1:1 match from Salt Minion ID to pillar file, therefore the entire file needs to be parsed each time a highstate is performed. Next, the Salt-Master encrypts the pillar data and sends it securely to each Salt Minion. These operations become extremely costly and profiling shows the Salt-Master spends 95% of its compute time compiling pillar data if the pillar top file contains more than one thousand individual pillar files. The Salt-Master becomes unable to process incoming minion requests and cannot communicate with more than ~250 minions concurrently. The Salt-Master&#x27;s ten worker threads saturate to 100% CPU usage and impact the performance of the rest of the 128T processes operating on the Conductor.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="a-better-approach-map-files">A Better Approach: Map Files<a class="hash-link" href="#a-better-approach-map-files" title="Direct link to heading">​</a></h2><p>Pillar files are best used only for sensitive data like passwords or SSH keys. Any other data should be converted to use map files instead. The swap from pillar files to map files is very simple.</p><p>Move all pillar files from the pillar directory <code>/srv/pillar/</code> to a new data directory within the Salt file roots <code>/srv/salt/data</code> and rename the pillar files to have the extension matching their data type instead of the <code>.sls</code> extension:</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>In this example the map files for each Salt Minion contain contents formatted in YAML so the file extension becomes <code>.yaml</code>. Salt also supports map files formatted in JSON, which would result in the <code>.json</code> extension instead.</p></div></div><p><code>/srv/salt/data/</code>:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 473 May  6 23:06 common.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router1A.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router1B.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router2A.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router2B.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router999A.yaml</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root  74 May  6 23:06 router999B.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now convert all Salt states to access the information from the map file instead of the pillar file.</p><p>Before:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{%- set configured_interfaces = pillar.get(&#x27;configured_interfaces&#x27;) %}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>After:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{%- import_yaml &#x27;data/%s.yaml&#x27; % opts.id as data %}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{%- set configured_interfaces = data.get(&#x27;configured_interfaces&#x27;) %}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>In this example the map files for each Salt Minion are named after the Salt Minion ID. The first line uses the Salt Minion ID to form the file name.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>In this example the map files are formatted in YAML so the Salt state uses the <code>import_yaml</code> keyword to load the data. If the user chose to format their map files in JSON then the Salt state would use the <code>import_json</code> keyword instead.</p></div></div><p>There is no need to manually sync the map file from the data directory on the Salt-Master to the Salt Minions. Since the map files located at <code>/srv/salt/data</code> are placed within the Salt file roots <code>/srv/salt/</code> the Salt Minion can fetch them from the Salt-Master automatically. Within the states the data file path is referenced as <code>data/</code> as seen in the first line of the example above because the Salt state&#x27;s root directory is the Salt file roots.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>With the Salt pillar approach the Salt-Master renders the entire pillar top file and encrypts the pillar data each time it needs to perform highstate. With the map file approach the Salt-Master simply executes the highstate and the Salt Minion will fetch the correct map file automatically and render the information locally, saving lots of CPU cycles on the Salt-Master. With either approach the data is retrieved over an encrypted SSH tunnel between Salt Minion and Salt-Master. The only downside with the map approach is that the data is not encrypted on the Salt Minion when cached locally, which is why the map approach should not be used for sensitive data.</p><p>Pillars can still be used at scale provided that the pillar top file is small. One example would be using Salt pillars to set the same root password on all managed 128T Routers:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">base:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &#x27;*&#x27;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - password</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-04-27T15:23:45.000Z">4/27/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/bcp_monitoring_headends"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Monitoring Head End Routers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/bcp_sdwan_design_guide"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SD-WAN Design Guide</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#using-salt-with-128t" class="table-of-contents__link toc-highlight">Using Salt with 128T</a></li><li><a href="#using-salt-pillars" class="table-of-contents__link toc-highlight">Using Salt Pillars</a></li><li><a href="#a-better-approach-map-files" class="table-of-contents__link toc-highlight">A Better Approach: Map Files</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Juniper Networks, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.1cff6756.js"></script>
<script src="/assets/js/main.bf52851a.js"></script>
</body>
</html>