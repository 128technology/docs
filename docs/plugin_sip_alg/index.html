<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">SIP ALG Plugin | SSN Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.128technology.com/docs/plugin_sip_alg"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="SIP ALG Plugin | SSN Docs"><meta data-react-helmet="true" name="description" content="The Session Initiation Protocol (SIP) is a signaling protocol used for initiating, maintaining, and terminating real-time sessions that include voice, video and messaging applications. SIP is a text based protocol and exchanges IP address information within its messages as a means to establish signaling and media sessions between endpoints. When the SIP clients are behind NAT this poses a particular challenge since the addresses in the SIP messages for such clients will be private IPs which are not reachable beyond the NAT boundaries."><meta data-react-helmet="true" property="og:description" content="The Session Initiation Protocol (SIP) is a signaling protocol used for initiating, maintaining, and terminating real-time sessions that include voice, video and messaging applications. SIP is a text based protocol and exchanges IP address information within its messages as a means to establish signaling and media sessions between endpoints. When the SIP clients are behind NAT this poses a particular challenge since the addresses in the SIP messages for such clients will be private IPs which are not reachable beyond the NAT boundaries."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.128technology.com/docs/plugin_sip_alg"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/plugin_sip_alg" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/plugin_sip_alg" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.21b25f22.css">
<link rel="preload" href="/assets/js/runtime~main.b8267a61.js" as="script">
<link rel="preload" href="/assets/js/main.aff4260a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Juniper Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo_dark.png" alt="Juniper Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Session Smart</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro_getting_started">Docs</a><a href="https://community.128technology.com/home" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Interchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.juniper.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Company<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/about_128t">About</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_getting_started">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_system_reqs">Deployment Considerations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation">Installation Process</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_aws">Cloud Installations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_installer">Supporting Information - Appendix</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/concepts_application_discovery">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/config_basics">Administration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/events_overview">Events</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/bcp_att_avpn_configuration">Best Practices</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/cli_reference">CLI and Element Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/installer_cli_reference">Installer/Initializer Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/plugin_intro">Plugins</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_aws_tgw_connect">AWS Transit Gateway Connect</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_bgp_community_services">BGP Community Services</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_cloud_ha">Cloud HA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_dns_app_id">DNS App Id</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_dns_cache">DNS Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_gre">GRE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_ha_sync_redundancy">HA Sync Redundancy Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_http_probe">HTTP Probe Reachability Detection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_icmp_reachability_detection">ICMP Reachability Detection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_ipsec_client">IPsec Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_loopback_static_routes">Loopback Static Routes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_m800_watchdog">M800 Watchdog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_monitoring_agent">Monitoring Agent</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_mosh">Mosh</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_set_hostname">Set Hostname</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/plugin_sip_alg">SIP ALG</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_wireguard">Wireguard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugin_kni_namespace_scripts">KNI Namespace Scripts</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/api_rest_4.2.0">REST APIs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/release_notes_128t_5.5">Release Notes</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SIP ALG Plugin</h1></header><p>The Session Initiation Protocol (SIP)<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> is a signaling protocol used for initiating, maintaining, and terminating real-time sessions that include voice, video and messaging applications. SIP is a text based protocol and exchanges IP address information within its messages as a means to establish signaling and media sessions between endpoints. When the SIP clients are behind NAT this poses a particular challenge since the addresses in the SIP messages for such clients will be private IPs which are not reachable beyond the NAT boundaries.</p><p>When 128T router is present at the edge of the NAT boundary, it is capable of performing a Application Layer Gateway (ALG) function for SIP protocol by doing packet inspection and re-writing the private IP address information in the SIP messages for both SIP headers and Session Description Protocol (SDP)<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>. This enables both signaling and media traffic to traverse the NAT and makes the communication possible between the client behind the NAT and the remote SIP endpoint(s). The SIP ALG function can be enabled by installing and configuring the <code>128T-sip-alg</code> plugin.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The instructions for installing and managing the plugin can be found <a href="/docs/plugin_intro#installation-and-management">here</a>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h2><p>The sip-alg configuration can be enabled on a router. In order to configure <code>sip-alg</code>, it is important to consider the following:</p><ul><li>Static IP mappings</li><li>Services for making inbound and outbound calls</li><li>Additional changes to the SDP to enable SIP interworking</li></ul><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>The 128T sip-alg function only supports a scenario whereby all the SIP endpoints on the private network communicate via a SIP enabled PBX device.</p></div></div><p>The following configuration shows an example of what the configuration for a single PBX device would look like:</p><div class="codeBlockContainer_J+bg language-config theme-code-block"><div class="codeBlockContent_csEI config"><pre tabindex="0" class="prism-code language-config codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">authority</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    router router1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        sip-alg                   PBX</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            name                        PBX</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            enabled                     true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            proxy-ip                    172.16.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ip-mappings                 192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                private-ip  192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                public-ip   172.16.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            sip-service                 outbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                direction       outbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                egress-service  sip-outbound-dc1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    name           sip-inbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    access-policy  lan</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        source      lan</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        permission  allow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                egress-service  sip-outbound-dc2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    name           sip-outbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    access-policy  lan</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        source      lan</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        permission  allow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            sip-service                 inbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                direction       inbound</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                egress-service  sip-inbound-pbx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    name           sip-inbound-pbx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    access-policy  datacenter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        source      datacenter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        permission  allow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    additional-address   192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    ingress-service-policy  custom</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            remove-sdp-lines-by-prefix  a=candidate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">exit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The <code>128T-sip-alg</code> plugin supports multiple branch PBXs by letting the user configure multiple <code>sip-alg</code> instances on the router. There is a limit of 10 sip-alg configurations per router.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="proxy-ip-and-ip-mappings">Proxy IP and IP Mappings<a class="hash-link" href="#proxy-ip-and-ip-mappings" title="Direct link to heading">​</a></h3><p>The <code>proxy-ip</code> represents a non-private address for the branch PBX that the remote endpoint (such as a data center server) can use for all inbound and outbound calls. The <code>ip-mappings</code> on the other hand provide the translation to the private IP address that can be used to reach the branch PBX. In the above example, the mappings are a way to indicate that any inbound calls on the <code>172.16.2.128</code> from the remote endpoint will be routed to the <code>192.168.2.128</code> address. This information is also useful for <a href="#sip-message-changes">fixing</a> all the relevant IP addresses in the SIP messages. For the outbound calls, the <code>proxy-ip</code> is used to replace the private branch PBX IP address with a non-private address that represents the branch from the perspective of the data center.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="inbound-and-outbound-services">Inbound and Outbound Services<a class="hash-link" href="#inbound-and-outbound-services" title="Direct link to heading">​</a></h3><p>The <code>sip-alg</code> plugin operates on the concept of <a href="/docs/plugin_intro#service-function-chaining">SFC</a> where all traffic is routed using KNIs to and from Linux. The 128T router uses <code>kamailio</code><sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> to then <a href="#sip-message-changes">fix all SIP messages</a> and perform additional routing to manage both inbound and outbound calls. For each of the <code>inbound</code> and <code>outbound</code> calls the plugin requires two services - an <code>ingress service</code> to route the traffic to the KNI and an <code>egress service</code> to route the traffic to the other SIP endpoint. The user is responsible for configuring the <code>egress service</code> and corresponding routes. The plugin automatically generates the <code>ingress service</code> and associated routes using the egress service and plugin configuration.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="outbound-service-and-config-auto-generation">Outbound Service and Config Auto Generation<a class="hash-link" href="#outbound-service-and-config-auto-generation" title="Direct link to heading">​</a></h4><p>The <code>outbound</code> service is used for initial registration between the branch PBX and the SIP server as well as making all outbound calls to remote endpoints. A typical call flow originates from the private LAN network, routed via the 128T sip-alg function that transforms the SIP messages, which are then routed over the WAN interface to the remote endpoint. Consider the following example:</p><div class="codeBlockContainer_J+bg language-config theme-code-block"><div class="codeBlockContent_csEI config"><pre tabindex="0" class="prism-code language-config codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">authority</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    service  sip-outbound-dc1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name           sip-outbound-dc1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        service-group  all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        description    &quot;outbound service for sip towards data center 1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        enabled        true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        scope          private</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        transport      udp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            protocol    udp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            port-range  5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                start-port  5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        address        172.16.2.102/32</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        access-policy  _internal_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            source      _internal_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            permission  allow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">exit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The service <code>sip-outbound-dc1</code> captures all SIP UDP traffic towards port 5060 originating from the <a href="/docs/bcp_tenants#the-internal-tenant"><code>_internal_</code> tenant</a>. This is a special tenant associated with the SFC KNIs. The <code>sip-service &gt; outbound</code> for the sip-alg configuration refers to this user configured service in the above example. In this process, the plugin will inherit all the address and transport configuration from this <em>service</em>, combined with the defined <em>access-policy</em> on the plugin, will generate the configuration for SIP traffic received on the lan tenant. The <code>ingress-service-policy</code> can be used to provide a custom policy to be applied to the generated service. More details on service policy design can be found <a href="/docs/bcp_service_and_service_policy_design#service-policy">here</a></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If the egress service has no transport configured, the plugin assumes the default SIP port of <code>5060</code> for both TCP and UDP.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Custom SIP ports are supported by configuring the appropriate ports for the inbound and outbound services</p></div></div><p><img alt="SIP ALG outbound call" src="/assets/images/sip_alg_outbound_call-76a5c94b7d79c612ef794eda5362613d.png"></p><p>The overall sessions for an outbound SIP call will appear as follows:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">admin@node1.router1# show sessions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Tue 2020-07-07 21:37:11 UTC</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node: node1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">====================================== ===== =================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> Session Id                             Dir   Service                                             Tenant       Dev Name       VLAN   Proto   Src IP         Src Port   Dest IP        Dest Port   NAT IP    NAT Port   Payload     Timeout   Uptime</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                       Encrypted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">====================================== ===== =================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 1fe41d38-9385-4e4d-a801-19204ddde325   fwd   outbound-ingress_router1_PBX-                       lan          lan               0   udp     192.168.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3590   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                              outbound-dc1                                                                                                                                                                                   0:00:16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 1fe41d38-9385-4e4d-a801-19204ddde325   rev   outbound-ingress_router1_PBX-                       lan          sip-private0      0   udp     172.16.2.102       5060   192.168.2.128        5060   0.0.0.0          0   false          3590   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                              outbound-dc1                                                                                                                                                                                   0:00:16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0b70b390-0704-4504-911a-08cc93306e59   fwd   sip-outbound-dc1                                    _internal_   sip-public0       0   udp     172.16.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3590   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                                             0:00:16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0b70b390-0704-4504-911a-08cc93306e59   rev   sip-outbound-dc1                                    _internal_   wan               0   udp     172.16.2.102       5060   172.16.2.128        5060   0.0.0.0          0   false          3590   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                                             0:00:16</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Completed in 0.04 seconds</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">admin@node1.router1#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="inbound-service-and-config-auto-generation">Inbound Service and Config Auto Generation<a class="hash-link" href="#inbound-service-and-config-auto-generation" title="Direct link to heading">​</a></h4><p>The <code>inbound</code> service is used for processing all incoming calls to the branch PBX from the remote server. A typical call flow originates from the public WAN network, routed via the 128T sip-alg function that transforms the SIP messages, which are then routed over the LAN interface to the branch PBX. The user is responsible for configuring the ingress service and the associated service-routes. Consider the following example:</p><div class="codeBlockContainer_J+bg language-config theme-code-block"><div class="codeBlockContent_csEI config"><pre tabindex="0" class="prism-code language-config codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">authority</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    service  sip-inbound-pbx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name           sip-inbound-pbx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        service-group  all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        description    &quot;inbound service for sip towards branch PBX&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        enabled        true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        scope          private</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        security       aes1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        transport      udp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            protocol    udp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            port-range  5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                start-port  5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        address        172.16.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        access-policy  _internal_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            source      _internal_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            permission  allow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    exit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">exit</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The service <code>sip-inbound-pbx</code> captures all SIP UDP traffic towards port 5060 originating from the <a href="/docs/bcp_tenants#the-internal-tenant"><code>_internal_</code> tenant</a>. This is a special tenant associated with the SFC KNIs. The <code>sip-service &gt; inbound</code> for the sip-alg configuration refers to this user configured service in the above example. In this process, the plugin will inherit all the address and transport configuration from this <em>service</em>, combined with the defined <em>access-policy</em> on the plugin, will generate the configuration for SIP traffic received on the <code>datacenter</code> tenant. The <code>ingress-service-policy</code> can be used to provide a custom policy to be applied to the generated service. More details on service policy design can be found <a href="/docs/bcp_service_and_service_policy_design#service-policy">here</a></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>If the ingress service has no transport configured, the plugin assumes the default SIP port of <code>5060</code> for both TCP and UDP.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The <code>additional-address</code> configuration can be used to add the <code>proxy-ip</code> address to the generated service.</p></div></div><p><img alt="SIP ALG inbound call" src="/assets/images/sip_alg_inbound_call-7c8c0d0fe0b66e6e2992bd10de3b4cb8.png"></p><p>The overall sessions for an inbound SIP call will appear as follows:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">admin@node1.router1# show sessions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Tue 2020-07-07 21:42:32 UTC</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Node: node1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">====================================== ===== ================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> Session Id                             Dir   Service                                            Tenant       Dev Name       VLAN   Proto   Src IP         Src Port   Dest IP        Dest Port   NAT IP    NAT Port   Payload     Timeout   Uptime</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                      Encrypted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">====================================== ===== ================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 6997aaf4-8d20-40bc-827e-494bb881563c   fwd   inbound-ingress_router1_PBX-                        wan          wan               0   udp     172.16.2.102       5060   172.16.2.128        5060   0.0.0.0          0   false          3538   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                              inbound-pbx                                                                                                                                                                                   0:01:07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 6997aaf4-8d20-40bc-827e-494bb881563c   rev   inbound-ingress_router1_PBX-                        wan          sip-public0       0   udp     172.16.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3538   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                              inbound-pbx                                                                                                                                                                                   0:01:07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> f62248d7-a003-4e6b-b586-d196c4b23d3d   fwd   sip-inbound-pbx                                    _internal_   sip-private0      0   udp     172.16.2.128       5060   192.168.2.128        5060   0.0.0.0          0   false          3538   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                                            0:01:07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> f62248d7-a003-4e6b-b586-d196c4b23d3d   rev   sip-inbound-pbx                                    _internal_   lan               0   udp     192.168.2.128       5060   172.16.2.128        5060   0.0.0.0          0   false          3538   0 days</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                                                                                                                                                                                                                                            0:01:07</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Completed in 0.05 seconds</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">admin@node1.router1#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="remove-sdp-prefixes">Remove SDP Prefixes<a class="hash-link" href="#remove-sdp-prefixes" title="Direct link to heading">​</a></h3><p>Some of the SDP options can include private IP addresses and pose additional challenges with the SIP NAT inter-working. The <code>remove-sdp-lines-by-prefix</code> can be used to remove such lines from the SIP messages. As shown in the <a href="#configuration">above example</a>, the <code>a=candidate</code> line is configured to be removed from all SIP messages.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="sip-message-changes">SIP Message Changes<a class="hash-link" href="#sip-message-changes" title="Direct link to heading">​</a></h2><p>The 128T <code>sip-alg</code> functionality is completely stateless and works by applying NAT rules to every SIP message sent and received. The SIP stack, however, is aware of directionality and uses this information to fix the messages with the correct set of IP addresses.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="outbound-call-changes">Outbound Call Changes<a class="hash-link" href="#outbound-call-changes" title="Direct link to heading">​</a></h4><p>Consider an outbound <code>SIP INVITE</code> message received from the PBX destined towards a remote endpoint.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">INVITE sip:service@172.16.2.102:5060 SIP/2.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 192.168.2.128:5060;branch=z9hG4bK-4178-1-0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">From: sipp &lt;sip:sipp@192.168.2.128:5060&gt;;tag=4178SIPpTag001</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To: service &lt;sip:service@172.16.2.102:5060&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Call-ID: 1-4178@192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CSeq: 1 INVITE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact: sip:sipp@192.168.2.128:5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max-Forwards: 70</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Subject: Performance Test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: application/sdp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Length:   135</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">v=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">o=user1 53655765 2353687637 IN IP4 192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">s=-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c=IN IP4 192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">t=0 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m=audio 6000 RTP/AVP 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a=rtpmap:0 PCMU/8000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above message, contains the private address <code>192.168.2.128</code> in several key places such as <code>Contact</code> header and the <code>c=</code> line in the SDP. These fields are typically used by the remote server to communicate with the endpoint and establish a call. In the scenario where the endpoint is behind a NAT, these addresses are not reachable. After passing through the <code>sip-alg</code> function, the above SIP INVITE message is fixed up as shown below:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">INVITE sip:service@172.16.2.102:5060 SIP/2.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Record-Route: &lt;sip:172.16.2.128;lr;ftag=4178SIPpTag001&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 172.16.2.128:5060;branch=z9hG4bK9d03.16530dac338af7723b8b1d42857c6b6d.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 192.168.2.128:5060;branch=z9hG4bK-4178-1-0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">From: sipp &lt;sip:sipp@172.16.2.128:5060&gt;;tag=4178SIPpTag001</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To: service &lt;sip:service@172.16.2.102:5060&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Call-ID: 1-4178@192.168.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CSeq: 1 INVITE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact: sip:sipp@172.16.2.128:5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max-Forwards: 70</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Subject: Performance Test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: application/sdp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Length:   135</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">v=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">o=user1 53655765 2353687637 IN IP4 172.16.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">s=-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c=IN IP4 172.16.2.128</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">t=0 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m=audio 6000 RTP/AVP 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a=rtpmap:0 PCMU/8000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>A few important aspects of the changes made to the original SIP INVITE are as follows:</p><ul><li>A SIP <code>Record-Route</code> header is added to the <code>INVITE</code> to ensure that the router stays in path of all requests associates with this call-id.</li><li>A new <code>Via</code> header is added to insert the router in paths of all responses associated with this call-id. The information related to the client is encoded in the <code>branch</code> cookie within the <code>Via</code> header.</li><li>The <code>Contact</code>, <code>Call-ID</code>, <code>SDP</code> and any other header that referenced the private address of <code>192.168.2.128</code> has been replaced with the corresponding proxy address of <code>172.16.2.128</code>.</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="inbound-call-changes">Inbound Call Changes<a class="hash-link" href="#inbound-call-changes" title="Direct link to heading">​</a></h4><p>Consider an inbound SIP call received from the server <code>172.16.2.102</code> on the <code>proxy-ip</code> representing the PBX.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">INVITE sip:phone3@172.16.2.128:5060 SIP/2.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 172.16.2.102:5060;branch=z9hG4bK-3585-1-0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">From: sipp &lt;sip:sipp@172.16.2.102:5060&gt;;tag=3585SIPpTag001</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To: phone3 &lt;sip:phone3@172.16.2.128:5060&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Call-ID: 1-3585@172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CSeq: 1 INVITE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact: sip:sipp@172.16.2.102:5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max-Forwards: 70</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Subject: Performance Test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: application/sdp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Length:   135</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">v=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">o=user1 53655765 2353687637 IN IP4 172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">s=-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c=IN IP4 172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">t=0 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m=audio 6000 RTP/AVP 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a=rtpmap:0 PCMU/8000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above message is sent to <code>kamailio</code> which in turn converts the public IPs to private addresses and forwards the message to the branch PBX. The new message will look as follows:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">INVITE sip:phone3@192.168.2.128:5060 SIP/2.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Record-Route: &lt;sip:172.16.2.128;lr;ftag=3585SIPpTag001&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 172.16.2.128:5060;branch=z9hG4bK626e.01bb9cb7cd546e70477186f224a898da.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Via: SIP/2.0/UDP 172.16.2.102:5060;branch=z9hG4bK-3585-1-0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">From: sipp &lt;sip:sipp@172.16.2.102:5060&gt;;tag=3585SIPpTag001</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">To: phone3 &lt;sip:phone3@192.168.2.128:5060&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Call-ID: 1-3585@172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CSeq: 1 INVITE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact: sip:sipp@172.16.2.102:5060</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Max-Forwards: 70</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Subject: Performance Test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: application/sdp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Length:   135</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">v=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">o=user1 53655765 2353687637 IN IP4 172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">s=-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">c=IN IP4 172.16.2.102</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">t=0 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m=audio 6000 RTP/AVP 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">a=rtpmap:0 PCMU/8000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the inbound case, the following modifications were performed:</p><ul><li>The <code>Record-Route</code> header was added to ensure that the proxy is in the path for all future requests for the call.</li><li>The <code>Via</code> header is added to ensure the proxy remains in path for all response messages.</li><li>The Request URI and the <code>To</code> headers are fixed to point to the PBX private address instead of the <code>proxy-ip</code>.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="troubleshooting">Troubleshooting<a class="hash-link" href="#troubleshooting" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="inspecting-kamailio">Inspecting Kamailio<a class="hash-link" href="#inspecting-kamailio" title="Direct link to heading">​</a></h3><p>The 128T <code>sip-alg</code> function launches a <code>kamailio</code> service which is responsible for fixing up all the SIP messages. The operation of the process can be inspected via querying the systemd service for the appropriate <code>sip-alg</code> instance. For example:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># systemctl status t128-sip-alg@PBX.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">● t128-sip-alg@PBX.service - Kamailio service running in PBX</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Loaded: loaded (/etc/systemd/system/t128-sip-alg@.service; disabled; vendor preset: disabled)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   Active: active (running) since Wed 2020-07-08 18:52:33 UTC; 10h ago</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> Main PID: 22261 (kamailio)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   CGroup: /system.slice/system-t128\x2dsip\x2dalg.slice/t128-sip-alg@PBX.service</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22261 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22264 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22265 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22266 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22267 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22268 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22269 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22270 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22271 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22272 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22273 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22274 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22275 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22276 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22277 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22278 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22279 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22280 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22281 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           ├─22282 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           └─22283 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ TO service &lt;sip:service@172.16.2.102:5061&gt;;tag=11336SIPpTag015 ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ CONTACT &lt;sip:172.16.2.102:5061;transport=UDP&gt; ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: It is a response to an outbound request</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: Reverse natting From header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: Sending natted reply as:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ STATUS 200 OK ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ VIA SIP/2.0/UDP 172.16.2.128:5061;branch=z9hG4bK4911.716b96ecc6684d3543e468d8454f285e.0, SIP/2.0/UDP 172.16.1.1...hG4bK-12741-5-7 ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ FROM sipp &lt;sip:sipp@192.168.2.128:5060&gt;;tag=12741SIPpTag005 ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ TO service &lt;sip:service@172.16.2.102:5061&gt;;tag=11336SIPpTag015 ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Jul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} &lt;script&gt;: [ CONTACT &lt;sip:172.16.2.102:5061;transport=UDP&gt; ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Hint: Some lines were ellipsized, use -l to show in full.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>kamailio</code> configuration can be found under <code>/etc/kamailio/kamailio.PBX.cfg</code> and should reflect the ip-mappings and other configuration from the plugin configuration.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Users should not make any manual changes to the <code>kamailio</code> config as it would get overwritten from the 128T conductor.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="inspecting-the-sip-alg-namespace">Inspecting the sip-alg Namespace<a class="hash-link" href="#inspecting-the-sip-alg-namespace" title="Direct link to heading">​</a></h3><p>All of the <code>sip-alg</code> function, including <code>kamailio</code>, operate from within a network namespace. Some of the common commands and the expected outputs are shown below.</p><p>The following example shows the KNI configuration and the default route on a running system</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ip netns exec PBX ip a</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet6 ::1/128 scope host</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">62: sip-private0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    link/ether 66:2e:6e:54:ac:cb brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet 169.254.129.18/30 scope global sip-private0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet6 fe80::642e:6eff:fe54:accb/64 scope link</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">63: sip-public0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    link/ether 3e:01:42:65:a9:fc brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet 169.254.129.22/30 scope global sip-public0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    inet6 fe80::3c01:42ff:fe65:a9fc/64 scope link</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ip netns exec PBX ip route</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default via 169.254.129.21 dev sip-public0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">169.254.129.16/30 dev sip-private0 proto kernel scope link src 169.254.129.18</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">169.254.129.20/30 dev sip-public0 proto kernel scope link src 169.254.129.22</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.2.128 via 169.254.129.17 dev sip-private0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>kamailio</code> process would be listening on the configured SIP port to intercept and fix the SIP messages. The behavior can be validated by running the following command:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ip netns exec PBX netstat -pant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Active Internet connections (servers and established)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tcp        0      0 169.254.129.22:5060     0.0.0.0:*               LISTEN      19098/kamailio</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tcp        0      0 169.254.129.18:5060     0.0.0.0:*               LISTEN      19098/kamailio</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, the namespace is configured with a set of <code>iptables</code> rules to enable the static mapping from public to private. A typical set of rules can be seen below.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># ip netns exec PBX iptables -t nat -nvL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    4  1776 DNAT       all  --  sip-private0 *       0.0.0.0/0            0.0.0.0/0            to:169.254.129.18</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    5  2558 DNAT       all  --  sip-public0 *       0.0.0.0/0            0.0.0.0/0            to:169.254.129.22</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chain INPUT (policy ACCEPT 9 packets, 4334 bytes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chain OUTPUT (policy ACCEPT 10 packets, 5485 bytes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> pkts bytes target     prot opt in     out     source               destination</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   10  5485 SNAT       all  --  *      *       0.0.0.0/0            0.0.0.0/0            to:172.16.2.128</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="release-notes">Release Notes<a class="hash-link" href="#release-notes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="release-240-311">Release 2.4.0, 3.1.1<a class="hash-link" href="#release-240-311" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="new-features-and-improvements">New Features and Improvements<a class="hash-link" href="#new-features-and-improvements" title="Direct link to heading">​</a></h4><ul><li><strong>PLUGIN-756</strong> Provide support for DSCP marking on transformed packets</li></ul><p>The feature adds support for configuring <code>sip-alg &gt; dscp</code> to specify the TOS marking to be used for the packets transformed by the SIP ALG plugin, allowing the traffic to be prioritized appropriately on the egress.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="issues-fixed">Issues Fixed<a class="hash-link" href="#issues-fixed" title="Direct link to heading">​</a></h4><ul><li><p><strong>PLUGIN-1131</strong> The default log-level for the plugin on the router is too high</p><p><em><strong>Resolution:</strong></em> Reduce the log level by default and allow the appropriate log level to be configured for debugging and troubleshooting as needed.</p></li><li><p><strong>PLUGIN-756</strong> Missing <code>access-policy &gt; permission</code> for the SIP ALG configuration caused config to fail</p><p><em><strong>Resolution:</strong></em> The logic for service config generation now defaults to the appropriate permission when user does not configure it</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="release-300">Release 3.0.0<a class="hash-link" href="#release-300" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="issues-fixed-1">Issues Fixed<a class="hash-link" href="#issues-fixed-1" title="Direct link to heading">​</a></h4><ul><li><strong>PLUGIN-768</strong> Support the SIP ALG plugin in 128T versions <code>5.1.0</code> and greater.</li></ul><div class="footnotes"><hr><ol><li id="fn-1"><a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Session_Initiation_Protocol</a><a href="#fnref-1" class="footnote-backref">↩</a></li><li id="fn-2"><a href="https://en.wikipedia.org/wiki/Session_Description_Protocol" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Session_Description_Protocol</a><a href="#fnref-2" class="footnote-backref">↩</a></li><li id="fn-3"><a href="https://www.kamailio.org/" target="_blank" rel="noopener noreferrer">https://www.kamailio.org/</a><a href="#fnref-3" class="footnote-backref">↩</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-03-29T20:37:40.000Z">3/29/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/plugin_set_hostname"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Set Hostname</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/plugin_wireguard"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Wireguard</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a><ul><li><a href="#proxy-ip-and-ip-mappings" class="table-of-contents__link toc-highlight">Proxy IP and IP Mappings</a></li><li><a href="#inbound-and-outbound-services" class="table-of-contents__link toc-highlight">Inbound and Outbound Services</a></li><li><a href="#remove-sdp-prefixes" class="table-of-contents__link toc-highlight">Remove SDP Prefixes</a></li></ul></li><li><a href="#sip-message-changes" class="table-of-contents__link toc-highlight">SIP Message Changes</a></li><li><a href="#troubleshooting" class="table-of-contents__link toc-highlight">Troubleshooting</a><ul><li><a href="#inspecting-kamailio" class="table-of-contents__link toc-highlight">Inspecting Kamailio</a></li><li><a href="#inspecting-the-sip-alg-namespace" class="table-of-contents__link toc-highlight">Inspecting the sip-alg Namespace</a></li></ul></li><li><a href="#release-notes" class="table-of-contents__link toc-highlight">Release Notes</a><ul><li><a href="#release-240-311" class="table-of-contents__link toc-highlight">Release 2.4.0, 3.1.1</a></li><li><a href="#release-300" class="table-of-contents__link toc-highlight">Release 3.0.0</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Juniper Networks, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b8267a61.js"></script>
<script src="/assets/js/main.aff4260a.js"></script>
</body>
</html>