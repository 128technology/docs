<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">SSR Metadata | SSN Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.128technology.com/docs/concepts_metadata"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="SSR Metadata | SSN Docs"><meta data-react-helmet="true" name="description" content="As part of the SSR&#x27;s operation, it performs functions such as flow classification, route selection, load balancing, etc., upon receipt of a first packet from a new five tuple source. Before sending this packet to another SSR, it inserts metadata, a series of TLVs which describe attributes of the session, into the payload of the packet. Likewise, in the reverse direction, the first reverse packet will include metadata in the form of a different set of TLVs associated with decisions made on the egress SSR."><meta data-react-helmet="true" property="og:description" content="As part of the SSR&#x27;s operation, it performs functions such as flow classification, route selection, load balancing, etc., upon receipt of a first packet from a new five tuple source. Before sending this packet to another SSR, it inserts metadata, a series of TLVs which describe attributes of the session, into the payload of the packet. Likewise, in the reverse direction, the first reverse packet will include metadata in the form of a different set of TLVs associated with decisions made on the egress SSR."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.128technology.com/docs/concepts_metadata"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/concepts_metadata" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.128technology.com/docs/concepts_metadata" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.21b25f22.css">
<link rel="preload" href="/assets/js/runtime~main.f6d81078.js" as="script">
<link rel="preload" href="/assets/js/main.5cd46198.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Juniper Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo_dark.png" alt="Juniper Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Session Smart</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro_getting_started">Docs</a><a href="https://community.juniper.net/answers/communities/community-home?CommunityKey=310d1a41-12fa-4627-9a99-880145a7c87c" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Session Smart Community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.juniper.net/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Company<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/about_128t">About</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_getting_started">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_system_reqs">Deployment Considerations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation">Installation Process</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_image">Image-Based Installation</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_quickstart_aws">Cloud Installations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_upgrade_considerations">Upgrades and Rollback</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_installation_installer">Supporting Install Information - Appendix</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/concepts_application_discovery">Concepts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_application_discovery">Application Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_appid">Application Identification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_EthOverSVR">Ethernet Over Secure Vector Routing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_ha_theoryofoperation">HA - Theory of Operation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_interface_types">Interface Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_kni">Kernel Network Interfaces</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_linux_host_networking">Linux Host Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_learning_VRF_routes">Learning VRF Routes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_network_planes">Forwarding Planes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/concepts_metadata">SSR Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_machine_communication">Machine Communication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_pcli">PCLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_session_timer">Session Timers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_STEP">Service and Topology Exchange Protocol (STEP)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_waypoint_ports">Waypoints</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concepts_glossary">Glossary</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/intro_wa_quickstart_1_networks">WAN Assurance Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/wan_overview">WAN Assurance</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/config_basics">Administration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/events_overview">Events</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/bcp_att_avpn_configuration">Best Practices</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/cli_reference">CLI and Element Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/installer_cli_reference">Installer/Initializer Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/plugin_intro">Plugins</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/release_notes_128t_6.0">Release Notes</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SSR Metadata</h1></header><p>As part of the SSR&#x27;s operation, it performs functions such as flow classification, route selection, load balancing, etc., upon receipt of a first packet from a new five tuple source. Before sending this packet to another SSR, it inserts metadata, a series of <a href="https://en.wikipedia.org/wiki/Type-length-value" target="_blank" rel="noopener noreferrer">TLVs</a> which describe attributes of the session, into the payload of the packet. Likewise, in the reverse direction, the first reverse packet will include metadata in the form of a different set of TLVs associated with decisions made on the egress SSR.</p><p>These metadata inclusions are supplied by and exchanged between nodes within a router when deployed as a HA pair; this is frequently referred to as <em>inter-node</em> metadata.</p><p>In a similar way, the SSR uses metadata when exchanging packets between SSR instances. In these <em>inter-router</em> applications, an SSR will insert metadata (on egress) to another SSR.</p><p>Irrespective of whether it is being used between nodes or between routers, the function of the metadata is to convey information between these two nodes; the ingress node sends information about the originator of the packet, authentication information about itself, the tenant that the endpoint has been determined to be in, the destination service, and a growing list of feature-specific parameters. In turn, the egress node supplies information back to the ingress node to provide real-time utilization information about the service, any downstream load balancing decisions it has employed, etc.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-types">Metadata Types<a class="hash-link" href="#metadata-types" title="Direct link to heading">​</a></h2><p>There are three main types of metadata in use within the SSR:</p><ol><li>Session metadata. This is the ‘signaling exchange’ sent between routers. It occurs at the outset of a session, during a metadata handshake, and will reoccur when properties of the session change and need to be re-signaled.</li><li>Per-packet metadata. This type of metadata is mostly associated with changes made to packets regardless of what session they are associated with. An example of this is when an SSR needs to fragment packets destined for another SSR; in this case, it adds &quot;fabric fragmentation&quot; metadata to each of the pieces, telling the egress node how to reassemble them.</li><li>BFD metadata. In a unique category unto itself, BFD metadata appears in every BFD packet exchanged between routers. It is a lightweight payload used to communicate service changes (e.g., when an active node fails and activity is resumed by a highly available counterpart), used as part of the BFD application to measure link quality.</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-insertion">Metadata Insertion<a class="hash-link" href="#metadata-insertion" title="Direct link to heading">​</a></h2><p>The SSR inserts metadata only when transmitting a packet between two routers, and under the following circumstances:</p><ol><li>It is a “forward” packet representing a new session and the ingress node has not yet received any reverse metadata from the recipient egress node.</li><li>It is a “reverse” packet from the recipient egress node to the initiating ingress node and the recipient egress node has not received forward packets from this session without metadata.</li></ol><p>These two comprise what is known as the “metadata handshake” -- that is, the initiating router sends packets with metadata to the recipient router until it receives a reverse packet with metadata from that recipient. Likewise, the recipient continues to send metadata to the initiating router until it receives a packet without metadata. This is how two routers acknowledge receipt of metadata from their counterparts: the absence of metadata in a packet indicates that it has received metadata from its counterpart.</p><ol start="3"><li>Fragmented packets are being sent from an SSR to another SSR.</li><li>Packets are being transformed to UDP between nodes because the original protocol has no support for L4 port numbers (and hence, SVR waypoint logic cannot be used. i.e. ICMP).</li><li>Packets are being transformed to UDP from TCP between routers due to the detection of a protocol-strict firewall between them.</li><li>A NAT exists between two routers and a router detects that the NAT’s address has changed.  Detection is done using a BFD exchange (not described in this document).</li><li>BFD Metadata.</li></ol><p>Metadata is always inserted directly after the L4 header of a packet.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>All packets between routers will have an L4 header, since the initiating router will insert one if one did not exist in the original packet.</p></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="retriggering-metadata">Retriggering Metadata<a class="hash-link" href="#retriggering-metadata" title="Direct link to heading">​</a></h3><p>There are a variety of reasons why metadata may need to be retriggered after the initial handshake has been successfully completed. Additionally the retriggering itself can serve different purposes depending on the catalyst. The two main scenarios for retriggering of metadata are existing flow recognition as well as existing flow modification</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="existing-flow-recognition">Existing Flow Recognition<a class="hash-link" href="#existing-flow-recognition" title="Direct link to heading">​</a></h4><p>This method of retriggering metadata is intended to reopen the session on the next hop due to a variety of reasons such as detecting a source NAT change from a device in the middle via BFD, or the session for some reason no longer exists on the next hop router and needs to be reopened. Ultimately the next hop router is missing a flow entry associated with the flow table key (device interface, VLAN, source IP, destination IP, source L4 port, destination L4 port, and protocol). Retriggering metadata in this scenario aims to recreate a session which should have existed or is currently in a stale state on the next-hop node.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="existing-flow-modification">Existing Flow Modification<a class="hash-link" href="#existing-flow-modification" title="Direct link to heading">​</a></h4><p>This form of metadata retriggering is a result of a router deciding that something about the existing session needs to change on the fly.</p><p>This could be a result of:</p><ul><li>Switching waypoints for an existing session due to a change in security actions of the session.</li><li>The load balancer within the ingress router decided that there is a better SVR path to traverse for the session.</li><li>Existing characteristics of a session (such as its traffic classification) have changed which must be communicated to the next hop router.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-versioning">Metadata Versioning<a class="hash-link" href="#metadata-versioning" title="Direct link to heading">​</a></h2><p>Metadata header contains a version field which dictates the version of the header format. Presently there is only version 1 which is associated with the initial format of the header.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-application-load-balancing">Metadata Application: Load Balancing<a class="hash-link" href="#metadata-application-load-balancing" title="Direct link to heading">​</a></h2><p>Each router maintains local information about the utilization of all services which it contacts. This information is used to inform a router’s session forwarding logic, which determines the most appropriate egress router for a given ingress session. There are three main inputs into a router’s session forwarding algorithm:</p><ul><li>The configuration of the fabric. This is where administrators define their preferences and requirements for session traffic. This includes application-based thresholds for the minimum viable link quality requirements (packet loss, jitter, latency), as well as the administrative preference for which path to use.</li><li>Path (or link) data, as learned through BFD. This includes real-time path measurement for latency and jitter, as well as real-time reporting of observed packet loss.</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="service-feedback">Service Feedback<a class="hash-link" href="#service-feedback" title="Direct link to heading">​</a></h3><p>With each new session that is established between two routers, the metadata from the egress router includes load information to describe that service’s current occupancy. This is based strictly on a count of the number of active sessions, but could be extended to use other attributes as metric data (e.g., bandwidth). These metrics are collectively referred to as “capacity criteria”.</p><p>By inserting capacity criteria in metadata, the egress router can send real-time information back, in band, to the ingress router. This information can (and should) be time sensitive – after a period of time the information, if it is not refreshed by another session assignment (and hence more metadata from the egress router), is considered obsolete. With frequent exchanges between two specific routers, the ingress router will have nearly perfect load information on the egress router – even if that ingress router is not the only source of traffic to that egress router.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-application-high-availability">Metadata Application: High Availability<a class="hash-link" href="#metadata-application-high-availability" title="Direct link to heading">​</a></h2><p>At its essence, metadata represents state information that is exchanged between routers. In its most primitive use case, an ingress router sends pre-transform packet information to the egress router for it to “reconstitute” the original source and destination addresses and ports of the original inbound packet. This is performed with the first packet for every new session entering into the SSR fabric. This same technique is also employed on non-first packets for existing sessions if a router has determined that its counterpart is no longer reachable (due to network issues or system failure).</p><p>After a router (which could have originally been the ingress or egress router of a session) detects that the adjacent peer it has been talking with has failed over or rebooted, an event is triggered for all flows destined to the newly active peer to restart metadata generation.  When BFD notices a state change with a connected peer indicative of a failover or reboot, it triggers an event to reevaluate path selection for active sessions. This event tells all flows generating metadata to do a one time check (when going through action processing) to see if their relevant peer has had a state change and is in need of metadata. If the event is relevant to the flow, metadata is enabled, otherwise the event is marked as observed and the existing metadata action state is unchanged.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-application-workload-mobility">Metadata Application: Workload Mobility<a class="hash-link" href="#metadata-application-workload-mobility" title="Direct link to heading">​</a></h2><p>Similar to the high availability scenario, network events may sometimes require session state to be moved among routers in an SSR fabric. The term workload mobility refers to the migration of a workload (virtual machine, container, etc.) from one location in a network to another; the challenge this presents to the SSR is that not only does the configuration need to account for the change (i.e., a service-route’s egress interface moves), but sessions in progress may also need to move as a result.</p><p>As with high availability, the use of metadata is critical to migrating a session from one router to another. In much the same way, when a (terminating) workload is moved to a new location, the ingress router will send packets for in-progress sessions to a new location, including brand new metadata to a new recipient.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-composition">Metadata Composition<a class="hash-link" href="#metadata-composition" title="Direct link to heading">​</a></h2><p>Metadata that the SSR system can generate is an accumulation of attributes associated with a session being established, or in certain circumstances per-packet attributes. Below is an example of the format of metadata that will sit between the layer 4 header of a packet and its payload.  There exist both <em>Header attributes</em> as well as <em>Payload attributes</em>. Header attributes are always guaranteed to be unencrypted. Payload attributes may be encrypted depending on the configuration of a security policy.  Each attribute listed below will indicate whether it is a header attribute (unencrypted) or payload attribute (optionally encrypted).  Attributes can not exist in both sections.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0                   1                   2                   3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|                                                               |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+                             Cookie                            +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|                                                               |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|Version|     Header Length     |         Payload Length        |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|        Header TLVs ...        |         Payload TLVs ...      |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="metadata-header">Metadata Header<a class="hash-link" href="#metadata-header" title="Direct link to heading">​</a></h3><p>The metadata header is the base structure for which all session and packet attributes are built upon. A well known “cookie” (<code>0x4c48dbc6ddf6670c</code> in network byte order or <code>0x0c67f6ddc6db484c</code> in host byte order) is built into the header which is used in concert with contextual awareness of the packet itself to determine the presence of metadata within a packet. This is an eight byte pattern that immediately follows the L4 header, and is an indicator to a receiving router that a packet contains metadata.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0                   1                   2                   3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|                                                               |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+                             Cookie                            +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|                                                               |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">|Version|     Header Length     |         Payload Length        |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_y2LR" id="cookie-8-bytes">Cookie (8 bytes)<a class="hash-link" href="#cookie-8-bytes" title="Direct link to heading">​</a></h5><p>The fingerprint of metadata. This value is used to determine the existence of metadata within a packet.</p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="version-4-bits">Version (4 bits)<a class="hash-link" href="#version-4-bits" title="Direct link to heading">​</a></h5><p>Field representing the version of the metadata header. The current version of metadata is 0x1.</p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="header-length-12-bits">Header Length (12 bits)<a class="hash-link" href="#header-length-12-bits" title="Direct link to heading">​</a></h5><p>Length of the metadata header including any added optional attributes that are guaranteed to be unencrypted. The value of this field is the number of bytes in the header.</p><h5 class="anchor anchorWithStickyNavbar_y2LR" id="payload-length-2-bytes">Payload Length (2 bytes)<a class="hash-link" href="#payload-length-2-bytes" title="Direct link to heading">​</a></h5><p>Length of data following the metadata header, not including the size of the header. This data could be encrypted. The value of this field is the number of bytes in the payload.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="false-positive-metadata">False Positive Metadata<a class="hash-link" href="#false-positive-metadata" title="Direct link to heading">​</a></h3><p>Given that no byte sequence is truly unique in the payload of a packet, in the scenario where the original payload after the L4 header contains the same byte sequence as the cookie, false positive logic is enacted on the packet. If no metadata header has already been added to the packet, a false positive metadata header is added to the packet to indicate that the first eight bytes of the payload matches the cookie. The structure of a false positive metadata packet is one which has a metadata header length that is the same as the base header size as well as having zero payload length. The receiving side of a packet with false positive metadata will strip out the metadata header if the next hop of the packet is not expecting a metadata header.</p><p>In the scenario where a router receives a false positive metadata header but intends to add metadata to the packet, the false positive metadata header is modified to contain the newly added attributes. Once attributes are added, the metadata header is no longer considered to be false positive.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="guaranteed-unencrypted-attributes">Guaranteed Unencrypted Attributes<a class="hash-link" href="#guaranteed-unencrypted-attributes" title="Direct link to heading">​</a></h3><p>The metadata header contains a 12 bit field associated with the header length of the metadata header. The field represents the overall length of the header. Its base value is <code>0xC</code> which is the initial length of the metadata header.
The value <code>0xC</code> is derived from:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  64 bits  Cookie Length</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   4 bits  Metadata Version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  12 bits  Header Length</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">+ 16 bits  Payload Length</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">96 bits = 12 bytes decimal = 0xC hex</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Any value greater than <code>0xC</code> indicates additional attributes associated with this metadata header which are guaranteed to be unencrypted.</p><p>An example of an optional attribute which would reside in the guaranteed unencrypted section of metadata would be per-packet fabric fragment attribute. This attribute is not associated with any session or encryption schema and as such, must not be encrypted.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="contextually-encrypted-attributes-payload-attributes">Contextually Encrypted Attributes (Payload attributes)<a class="hash-link" href="#contextually-encrypted-attributes-payload-attributes" title="Direct link to heading">​</a></h3><p>The metadata header contains a two byte payload length field which is associated with attributes that could be encrypted.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="attributes">Attributes<a class="hash-link" href="#attributes" title="Direct link to heading">​</a></h2><p>Attributes are optionally included TLVs that are added to the metadata header. They can be added to either the guaranteed unencrypted section, or in the contextually encrypted section of the metadata header.  Each attribute will be marked with <!-- -->[header]<!-- --> or <!-- -->[payload]<!-- --> respectively to indicate in which metadata section it belongs.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-08-22T15:49:36.000Z">8/22/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/concepts_network_planes"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Forwarding Planes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/concepts_metrics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Metrics</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#metadata-types" class="table-of-contents__link toc-highlight">Metadata Types</a></li><li><a href="#metadata-insertion" class="table-of-contents__link toc-highlight">Metadata Insertion</a><ul><li><a href="#retriggering-metadata" class="table-of-contents__link toc-highlight">Retriggering Metadata</a></li></ul></li><li><a href="#metadata-versioning" class="table-of-contents__link toc-highlight">Metadata Versioning</a></li><li><a href="#metadata-application-load-balancing" class="table-of-contents__link toc-highlight">Metadata Application: Load Balancing</a><ul><li><a href="#service-feedback" class="table-of-contents__link toc-highlight">Service Feedback</a></li></ul></li><li><a href="#metadata-application-high-availability" class="table-of-contents__link toc-highlight">Metadata Application: High Availability</a></li><li><a href="#metadata-application-workload-mobility" class="table-of-contents__link toc-highlight">Metadata Application: Workload Mobility</a></li><li><a href="#metadata-composition" class="table-of-contents__link toc-highlight">Metadata Composition</a><ul><li><a href="#metadata-header" class="table-of-contents__link toc-highlight">Metadata Header</a></li><li><a href="#false-positive-metadata" class="table-of-contents__link toc-highlight">False Positive Metadata</a></li><li><a href="#guaranteed-unencrypted-attributes" class="table-of-contents__link toc-highlight">Guaranteed Unencrypted Attributes</a></li><li><a href="#contextually-encrypted-attributes-payload-attributes" class="table-of-contents__link toc-highlight">Contextually Encrypted Attributes (Payload attributes)</a></li></ul></li><li><a href="#attributes" class="table-of-contents__link toc-highlight">Attributes</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Juniper Networks, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f6d81078.js"></script>
<script src="/assets/js/main.5cd46198.js"></script>
</body>
</html>