---
title: Deprecate support for dh2 (modp1024) and dh22 IPSec algorithms
date: 2024-12-12
tags: ['ipsce-client']
hide_table_of_contents: false
---

To implement IPsec, SSR leverages a third-party client called `libreswan`. The client periodically deprecates weak algorithms from its code base such as dh2 (a.k.a `modp1024`) and dh22. While SSR still supports these algorithms, there is a desire to deprecate these algorithms in the near future. The article is meant to provide awareness of this upcoming change and provide ways to remediate the config.

<!-- truncate -->

**Issue ID:** PLUGIN-2835.

**Last Updated:** 2024-12-12

### Problem

When upgrading to a version of IPsec plugin with the weak ciphers removed, SSR will stop offering these ciphers in its IPsec negotiation with the far end. As a result, the tunnel connection will break and will not be able to be formed again. When this happens, the problem can be detected in the following ways

1. Check the output of the `show plugin state` command to inspect the status of the tunnel
```
========================================
 combo-west:rem1
========================================
 Type:                host
 Forwarding:          true
 Mode:                host
 MAC Address:         76:78:79:fc:eb:69

 Admin Status:        up
 Operational Status:  down
 Redundancy Status:   non-redundant
 Speed:               0
 Duplex:              unknown

 in-octets:                     1962932
 in-unicast-pkts:                 32710
 in-errors:                           0
 out-octets:                    1373442
 out-unicast-pkts:                32701
 out-errors:                          6

 IPSec:
     rem1:
         Tunnel Status:Down
         Tunnel Details:
             Name:    ipsec-client-tunnel-primary-rem1
             Remote Host:172.16.4.3
         Down Reason: Tunnel settings mismatch
```

The above output shows that the `Tunnel settings mismatch` since the SSR no longer uses these weak ciphers if found in the configuration.

2. In the `128t-ipsec@*` service, the following log indicates that the following

```received unauthenticated v2N_NO_PROPOSAL_CHOSEN - ignored```

Please see the [solution](#solution) for steps to plan for the eventual remediation.

### Severity
<details>
The potential impact of a software defect if encountered. Severity levels are:

* Critical: Could severely affect service, capacity/traffic, and maintenance capabilities. May have a prolonged impact to the entire system.
* Major: Could seriously affect system operation, maintenance, administration and related tasks.
* Minor: Would not significantly impair the functioning or affect service.
</details>
Minor

### Status
In Progress

### Resolved In
128T-ipsce-client-4.1.0

### Product
SSR Routers

### Functional Area
IPsec

### Solution
<details>
Juniper may provide a method to temporarily circumvent a problem; workarounds do not exist for all issues.
</details>

Starting with 128T-ipsec-client-4.1.0 version of the plugin, two changes are being made to support this remediation effort

1. A new warning message is being added for conifgurations that rely on `dh2` and `dh22` algorithms. The warning message would be visible when doing a `validate` or `commit` on the conductor

2. Existing versions of IPsec plugin only support configuration to specify a single combination of IKE and IPsec algorithms. As of `128T-ipsec-client-4.1.0` version, the product will add support for multiple ciphers to be configured for IKE and IPsec. Here's an example configuration with multiple ciphers configured

```
<insert-snippet-here>
```

The two solutions to remediate the weak algorithms would be to

1. While running the existing plugin version, replace the weak cipher with a stronger one from the supported list.

    a. Chose a new stronger cipher supported by the server

    b. Replace the weak cipher with the new strong chosen cipher

    This config change will need a restart of the tunnels for new connections to be formed.

2. Upgrade to the IPsec plugin version `4.1.0` and configure additional supported ciphers on the server side.

    SSR will offer all the supported ciphers and would aid in the process of identifying which ciphers are supported on the server. It is still recommended to remove the weak ciphers from the configuration once this determination has been made.

By remediating the config of the weak ciphers ahead of their deprecation would allow for a seamless transition when upgrading to new software version in the future.


