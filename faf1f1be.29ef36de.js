(window.webpackJsonp=window.webpackJsonp||[]).push([[138],{197:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return r})),a.d(n,"metadata",(function(){return s})),a.d(n,"rightToc",(function(){return c})),a.d(n,"default",(function(){return p}));var t=a(2),i=a(6),o=(a(0),a(205)),r={title:"SIP ALG Plugin",sidebar_label:"SIP ALG"},s={unversionedId:"plugin_sip_alg",id:"plugin_sip_alg",isDocsHomePage:!1,title:"SIP ALG Plugin",description:"The Session Initiation Protocol (SIP) is a signaling protocol used for initiating, maintaining, and terminating real-time sessions that include voice, video and messaging applications. SIP is a text based protocol and exchanges IP address information within its messages as a means to establish signaling and media sessions between endpoints. When the SIP clients are behind NAT this poses a particular challenge since the addresses in the SIP messages for such clients will be private IPs which are not reachable beyond the NAT boundaries.",source:"@site/docs/plugin_sip_alg.md",slug:"/plugin_sip_alg",permalink:"/docs/plugin_sip_alg",version:"current",lastUpdatedAt:1615852208,sidebar_label:"SIP ALG",sidebar:"docs",previous:{title:"Set Hostname",permalink:"/docs/plugin_set_hostname"},next:{title:"Wireguard Plugin",permalink:"/docs/plugin_wireguard"}},c=[{value:"Configuration",id:"configuration",children:[{value:"Proxy IP and IP Mappings",id:"proxy-ip-and-ip-mappings",children:[]},{value:"Inbound and Outbound Services",id:"inbound-and-outbound-services",children:[]},{value:"Remove SDP Prefixes",id:"remove-sdp-prefixes",children:[]}]},{value:"SIP Message Changes",id:"sip-message-changes",children:[]},{value:"Troubleshooting",id:"troubleshooting",children:[{value:"Inspecting Kamailio",id:"inspecting-kamailio",children:[]},{value:"Inspecting the sip-alg Namespace",id:"inspecting-the-sip-alg-namespace",children:[]}]}],l={rightToc:c};function p(e){var n=e.components,r=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(t.a)({},l,r,{components:n,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The Session Initiation Protocol (SIP)",Object(o.b)("sup",Object(t.a)({parentName:"p"},{id:"fnref-1"}),Object(o.b)("a",Object(t.a)({parentName:"sup"},{href:"#fn-1",className:"footnote-ref"}),"1"))," is a signaling protocol used for initiating, maintaining, and terminating real-time sessions that include voice, video and messaging applications. SIP is a text based protocol and exchanges IP address information within its messages as a means to establish signaling and media sessions between endpoints. When the SIP clients are behind NAT this poses a particular challenge since the addresses in the SIP messages for such clients will be private IPs which are not reachable beyond the NAT boundaries."),Object(o.b)("p",null,"When 128T router is present at the edge of the NAT boundary, it is capable of performing a Application Layer Gateway (ALG) function for SIP protocol by doing packet inspection and re-writing the private IP address information in the SIP messages for both SIP headers and Session Description Protocol (SDP)",Object(o.b)("sup",Object(t.a)({parentName:"p"},{id:"fnref-2"}),Object(o.b)("a",Object(t.a)({parentName:"sup"},{href:"#fn-2",className:"footnote-ref"}),"2")),". This enables both signaling and media traffic to traverse the NAT and makes the communication possible between the client behind the NAT and the remote SIP endpoint(s). The SIP ALG function can be enabled by installing and configuring the ",Object(o.b)("inlineCode",{parentName:"p"},"128T-sip-alg")," plugin."),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"The instructions for installing and managing the plugin can be found ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/plugin_intro#installation-and-management"}),"here"),"."))),Object(o.b)("h2",{id:"configuration"},"Configuration"),Object(o.b)("p",null,"The sip-alg configuration can be enabled on a router. In order to configure ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg"),", it is important to consider the following:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Static IP mappings"),Object(o.b)("li",{parentName:"ul"},"Services for making inbound and outbound calls"),Object(o.b)("li",{parentName:"ul"},"Additional changes to the SDP to enable SIP interworking")),Object(o.b)("div",{className:"admonition admonition-important alert alert--info"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"important")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"The 128T sip-alg function only supports a scenario whereby all the SIP endpoints on the private network communicate via a SIP enabled PBX device."))),Object(o.b)("p",null,"The following configuration shows an example of what the configuration for a single PBX device would look like:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{className:"language-config"}),"authority\n    router router1\n        sip-alg                   PBX\n            name                        PBX\n            enabled                     true\n            proxy-ip                    172.16.2.128\n\n            ip-mappings                 192.168.2.128\n                private-ip  192.168.2.128\n                public-ip   172.16.2.128\n            exit\n\n            sip-service                 outbound\n                direction       outbound\n\n                egress-service  sip-outbound-dc1\n                    name           sip-inbound\n\n                    access-policy  lan\n                        source      lan\n                        permission  allow\n                    exit\n                exit\n\n                egress-service  sip-outbound-dc2\n                    name           sip-outbound\n\n                    access-policy  lan\n                        source      lan\n                        permission  allow\n                    exit\n                exit\n            exit\n\n            sip-service                 inbound\n                direction       inbound\n\n                egress-service  sip-inbound-pbx\n                    name           sip-inbound-pbx\n\n                    access-policy  datacenter\n                        source      datacenter\n                        permission  allow\n                    exit\n\n                    additional-address   192.168.2.128\n                    ingress-service-policy  custom\n                exit\n            exit\n\n            remove-sdp-lines-by-prefix  a=candidate\n        exit\n    exit\nexit\n")),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"The ",Object(o.b)("inlineCode",{parentName:"p"},"128T-sip-alg")," plugin supports multiple branch PBXs by letting the user configure multiple ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," instances on the router. There is a limit of 10 sip-alg configurations per router."))),Object(o.b)("h3",{id:"proxy-ip-and-ip-mappings"},"Proxy IP and IP Mappings"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"proxy-ip")," represents a non-private address for the branch PBX that the remote endpoint (such as a data center server) can use for all inbound and outbound calls. The ",Object(o.b)("inlineCode",{parentName:"p"},"ip-mappings")," on the other hand provide the translation to the private IP address that can be used to reach the branch PBX. In the above example, the mappings are a way to indicate that any inbound calls on the ",Object(o.b)("inlineCode",{parentName:"p"},"172.16.2.128")," from the remote endpoint will be routed to the ",Object(o.b)("inlineCode",{parentName:"p"},"192.168.2.128")," address. This information is also useful for ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"#sip-message-changes"}),"fixing")," all the relevant IP addresses in the SIP messages. For the outbound calls, the ",Object(o.b)("inlineCode",{parentName:"p"},"proxy-ip")," is used to replace the private branch PBX IP address with a non-private address that represents the branch from the perspective of the data center."),Object(o.b)("h3",{id:"inbound-and-outbound-services"},"Inbound and Outbound Services"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," plugin operates on the concept of ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/plugin_intro#service-function-chaining"}),"SFC")," where all traffic is routed using KNIs to and from Linux. The 128T router uses ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio"),Object(o.b)("sup",Object(t.a)({parentName:"p"},{id:"fnref-3"}),Object(o.b)("a",Object(t.a)({parentName:"sup"},{href:"#fn-3",className:"footnote-ref"}),"3"))," to then ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"#sip-message-changes"}),"fix all SIP messages")," and perform additional routing to manage both inbound and outbound calls. For each of the ",Object(o.b)("inlineCode",{parentName:"p"},"inbound")," and ",Object(o.b)("inlineCode",{parentName:"p"},"outbound")," calls the plugin requires two services - an ",Object(o.b)("inlineCode",{parentName:"p"},"ingress service")," to route the traffic to the KNI and an ",Object(o.b)("inlineCode",{parentName:"p"},"egress service")," to route the traffic to the other SIP endpoint. The user is responsible for configuring the ",Object(o.b)("inlineCode",{parentName:"p"},"egress service")," and corresponding routes. The plugin automatically generates the ",Object(o.b)("inlineCode",{parentName:"p"},"ingress service")," and associated routes using the egress service and plugin configuration."),Object(o.b)("h4",{id:"outbound-service-and-config-auto-generation"},"Outbound Service and Config Auto Generation"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"outbound")," service is used for initial registration between the branch PBX and the SIP server as well as making all outbound calls to remote endpoints. A typical call flow originates from the private LAN network, routed via the 128T sip-alg function that transforms the SIP messages, which are then routed over the WAN interface to the remote endpoint. Consider the following example:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{className:"language-config"}),'authority\n    service  sip-outbound-dc1\n        name           sip-outbound-dc1\n        service-group  all\n        description    "outbound service for sip towards data center 1"\n        enabled        true\n        scope          private\n\n        transport      udp\n            protocol    udp\n\n            port-range  5060\n                start-port  5060\n            exit\n        exit\n        address        172.16.2.102/32\n\n        access-policy  _internal_\n            source      _internal_\n            permission  allow\n        exit\n    exit\nexit\n')),Object(o.b)("p",null,"The service ",Object(o.b)("inlineCode",{parentName:"p"},"sip-outbound-dc1")," captures all SIP UDP traffic towards port 5060 originating from the ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/bcp_tenants#the-internal-tenant"}),Object(o.b)("inlineCode",{parentName:"a"},"_internal_")," tenant"),". This is a special tenant associated with the SFC KNIs. The ",Object(o.b)("inlineCode",{parentName:"p"},"sip-service > outbound")," for the sip-alg configuration refers to this user configured service in the above example. In this process, the plugin will inherit all the address and transport configuration from this ",Object(o.b)("em",{parentName:"p"},"service"),", combined with the defined ",Object(o.b)("em",{parentName:"p"},"access-policy")," on the plugin, will generate the configuration for SIP traffic received on the lan tenant. The ",Object(o.b)("inlineCode",{parentName:"p"},"ingress-service-policy")," can be used to provide a custom policy to be applied to the generated service. More details on service policy design can be found ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/bcp_service_and_service_policy_design#service-policy"}),"here")),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"If the egress service has no transport configured, the plugin assumes the default SIP port of ",Object(o.b)("inlineCode",{parentName:"p"},"5060")," for both TCP and UDP."))),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Custom SIP ports are supported by configuring the appropriate ports for the inbound and outbound services"))),Object(o.b)("p",null,Object(o.b)("img",{alt:"SIP ALG outbound call",src:a(800).default})),Object(o.b)("p",null,"The overall sessions for an outbound SIP call will appear as follows:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"admin@node1.router1# show sessions\nTue 2020-07-07 21:37:11 UTC\n\nNode: node1\n\n====================================== ===== =================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========\n Session Id                             Dir   Service                                             Tenant       Dev Name       VLAN   Proto   Src IP         Src Port   Dest IP        Dest Port   NAT IP    NAT Port   Payload     Timeout   Uptime\n                                                                                                                                                                                                                       Encrypted\n====================================== ===== =================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========\n 1fe41d38-9385-4e4d-a801-19204ddde325   fwd   outbound-ingress_router1_PBX-                       lan          lan               0   udp     192.168.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3590   0 days\n                                              outbound-dc1                                                                                                                                                                                   0:00:16\n 1fe41d38-9385-4e4d-a801-19204ddde325   rev   outbound-ingress_router1_PBX-                       lan          sip-private0      0   udp     172.16.2.102       5060   192.168.2.128        5060   0.0.0.0          0   false          3590   0 days\n                                              outbound-dc1                                                                                                                                                                                   0:00:16\n 0b70b390-0704-4504-911a-08cc93306e59   fwd   sip-outbound-dc1                                    _internal_   sip-public0       0   udp     172.16.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3590   0 days\n                                                                                                                                                                                                                                             0:00:16\n 0b70b390-0704-4504-911a-08cc93306e59   rev   sip-outbound-dc1                                    _internal_   wan               0   udp     172.16.2.102       5060   172.16.2.128        5060   0.0.0.0          0   false          3590   0 days\n                                                                                                                                                                                                                                             0:00:16\n\nCompleted in 0.04 seconds\nadmin@node1.router1#\n\n")),Object(o.b)("h4",{id:"inbound-service-and-config-auto-generation"},"Inbound Service and Config Auto Generation"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"inbound")," service is used for processing all incoming calls to the branch PBX from the remote server. A typical call flow originates from the public WAN network, routed via the 128T sip-alg function that transforms the SIP messages, which are then routed over the LAN interface to the branch PBX. The user is responsible for configuring the ingress service and the associated service-routes. Consider the following example:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{className:"language-config"}),'authority\n    service  sip-inbound-pbx\n        name           sip-inbound-pbx\n        service-group  all\n        description    "inbound service for sip towards branch PBX"\n        enabled        true\n        scope          private\n        security       aes1\n\n        transport      udp\n            protocol    udp\n\n            port-range  5060\n                start-port  5060\n            exit\n        exit\n        address        172.16.2.128\n\n        access-policy  _internal_\n            source      _internal_\n            permission  allow\n        exit\n    exit\nexit\n')),Object(o.b)("p",null,"The service ",Object(o.b)("inlineCode",{parentName:"p"},"sip-inbound-pbx")," captures all SIP UDP traffic towards port 5060 originating from the ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/bcp_tenants#the-internal-tenant"}),Object(o.b)("inlineCode",{parentName:"a"},"_internal_")," tenant"),". This is a special tenant associated with the SFC KNIs. The ",Object(o.b)("inlineCode",{parentName:"p"},"sip-service > inbound")," for the sip-alg configuration refers to this user configured service in the above example. In this process, the plugin will inherit all the address and transport configuration from this ",Object(o.b)("em",{parentName:"p"},"service"),", combined with the defined ",Object(o.b)("em",{parentName:"p"},"access-policy")," on the plugin, will generate the configuration for SIP traffic received on the ",Object(o.b)("inlineCode",{parentName:"p"},"datacenter")," tenant. The ",Object(o.b)("inlineCode",{parentName:"p"},"ingress-service-policy")," can be used to provide a custom policy to be applied to the generated service. More details on service policy design can be found ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/bcp_service_and_service_policy_design#service-policy"}),"here")),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"If the ingress service has no transport configured, the plugin assumes the default SIP port of ",Object(o.b)("inlineCode",{parentName:"p"},"5060")," for both TCP and UDP."))),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"The ",Object(o.b)("inlineCode",{parentName:"p"},"additional-address")," configuration can be used to add the ",Object(o.b)("inlineCode",{parentName:"p"},"proxy-ip")," address to the generated service."))),Object(o.b)("p",null,Object(o.b)("img",{alt:"SIP ALG inbound call",src:a(801).default})),Object(o.b)("p",null,"The overall sessions for an inbound SIP call will appear as follows:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"admin@node1.router1# show sessions\nTue 2020-07-07 21:42:32 UTC\n\nNode: node1\n\n====================================== ===== ================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========\n Session Id                             Dir   Service                                            Tenant       Dev Name       VLAN   Proto   Src IP         Src Port   Dest IP        Dest Port   NAT IP    NAT Port   Payload     Timeout   Uptime\n                                                                                                                                                                                                                      Encrypted\n====================================== ===== ================================================== ============ ============== ====== ======= ============== ========== ============== =========== ========= ========== =========== ========= =========\n 6997aaf4-8d20-40bc-827e-494bb881563c   fwd   inbound-ingress_router1_PBX-                        wan          wan               0   udp     172.16.2.102       5060   172.16.2.128        5060   0.0.0.0          0   false          3538   0 days\n                                              inbound-pbx                                                                                                                                                                                   0:01:07\n 6997aaf4-8d20-40bc-827e-494bb881563c   rev   inbound-ingress_router1_PBX-                        wan          sip-public0       0   udp     172.16.2.128       5060   172.16.2.102        5060   0.0.0.0          0   false          3538   0 days\n                                              inbound-pbx                                                                                                                                                                                   0:01:07\n f62248d7-a003-4e6b-b586-d196c4b23d3d   fwd   sip-inbound-pbx                                    _internal_   sip-private0      0   udp     172.16.2.128       5060   192.168.2.128        5060   0.0.0.0          0   false          3538   0 days\n                                                                                                                                                                                                                                            0:01:07\n f62248d7-a003-4e6b-b586-d196c4b23d3d   rev   sip-inbound-pbx                                    _internal_   lan               0   udp     192.168.2.128       5060   172.16.2.128        5060   0.0.0.0          0   false          3538   0 days\n                                                                                                                                                                                                                                            0:01:07\n\nCompleted in 0.05 seconds\nadmin@node1.router1#\n")),Object(o.b)("h3",{id:"remove-sdp-prefixes"},"Remove SDP Prefixes"),Object(o.b)("p",null,"Some of the SDP options can include private IP addresses and pose additional challenges with the SIP NAT inter-working. The ",Object(o.b)("inlineCode",{parentName:"p"},"remove-sdp-lines-by-prefix")," can be used to remove such lines from the SIP messages. As shown in the ",Object(o.b)("a",Object(t.a)({parentName:"p"},{href:"#configuration"}),"above example"),", the ",Object(o.b)("inlineCode",{parentName:"p"},"a=candidate")," line is configured to be removed from all SIP messages."),Object(o.b)("h2",{id:"sip-message-changes"},"SIP Message Changes"),Object(o.b)("p",null,"The 128T ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," functionality is completely stateless and works by applying NAT rules to every SIP message sent and received. The SIP stack, however, is aware of directionality and uses this information to fix the messages with the correct set of IP addresses."),Object(o.b)("h4",{id:"outbound-call-changes"},"Outbound Call Changes"),Object(o.b)("p",null,"Consider an outbound ",Object(o.b)("inlineCode",{parentName:"p"},"SIP INVITE")," message received from the PBX destined towards a remote endpoint."),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"INVITE sip:service@172.16.2.102:5060 SIP/2.0\nVia: SIP/2.0/UDP 192.168.2.128:5060;branch=z9hG4bK-4178-1-0\nFrom: sipp <sip:sipp@192.168.2.128:5060>;tag=4178SIPpTag001\nTo: service <sip:service@172.16.2.102:5060>\nCall-ID: 1-4178@192.168.2.128\nCSeq: 1 INVITE\nContact: sip:sipp@192.168.2.128:5060\nMax-Forwards: 70\nSubject: Performance Test\nContent-Type: application/sdp\nContent-Length:   135\n\nv=0\no=user1 53655765 2353687637 IN IP4 192.168.2.128\ns=-\nc=IN IP4 192.168.2.128\nt=0 0\nm=audio 6000 RTP/AVP 0\na=rtpmap:0 PCMU/8000\n")),Object(o.b)("p",null,"The above message, contains the private address ",Object(o.b)("inlineCode",{parentName:"p"},"192.168.2.128")," in several key places such as ",Object(o.b)("inlineCode",{parentName:"p"},"Contact")," header and the ",Object(o.b)("inlineCode",{parentName:"p"},"c=")," line in the SDP. These fields are typically used by the remote server to communicate with the endpoint and establish a call. In the scenario where the endpoint is behind a NAT, these addresses are not reachable. After passing through the ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," function, the above SIP INVITE message is fixed up as shown below:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"INVITE sip:service@172.16.2.102:5060 SIP/2.0\nRecord-Route: <sip:172.16.2.128;lr;ftag=4178SIPpTag001>\nVia: SIP/2.0/UDP 172.16.2.128:5060;branch=z9hG4bK9d03.16530dac338af7723b8b1d42857c6b6d.0\nVia: SIP/2.0/UDP 192.168.2.128:5060;branch=z9hG4bK-4178-1-0\nFrom: sipp <sip:sipp@172.16.2.128:5060>;tag=4178SIPpTag001\nTo: service <sip:service@172.16.2.102:5060>\nCall-ID: 1-4178@192.168.2.128\nCSeq: 1 INVITE\nContact: sip:sipp@172.16.2.128:5060\nMax-Forwards: 70\nSubject: Performance Test\nContent-Type: application/sdp\nContent-Length:   135\n\nv=0\no=user1 53655765 2353687637 IN IP4 172.16.2.128\ns=-\nc=IN IP4 172.16.2.128\nt=0 0\nm=audio 6000 RTP/AVP 0\na=rtpmap:0 PCMU/8000\n\n")),Object(o.b)("p",null,"A few important aspects of the changes made to the original SIP INVITE are as follows:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"A SIP ",Object(o.b)("inlineCode",{parentName:"li"},"Record-Route")," header is added to the ",Object(o.b)("inlineCode",{parentName:"li"},"INVITE")," to ensure that the router stays in path of all requests associates with this call-id."),Object(o.b)("li",{parentName:"ul"},"A new ",Object(o.b)("inlineCode",{parentName:"li"},"Via")," header is added to insert the router in paths of all responses associated with this call-id. The information related to the client is encoded in the ",Object(o.b)("inlineCode",{parentName:"li"},"branch")," cookie within the ",Object(o.b)("inlineCode",{parentName:"li"},"Via")," header."),Object(o.b)("li",{parentName:"ul"},"The ",Object(o.b)("inlineCode",{parentName:"li"},"Contact"),", ",Object(o.b)("inlineCode",{parentName:"li"},"Call-ID"),", ",Object(o.b)("inlineCode",{parentName:"li"},"SDP")," and any other header that referenced the private address of ",Object(o.b)("inlineCode",{parentName:"li"},"192.168.2.128")," has been replaced with the corresponding proxy address of ",Object(o.b)("inlineCode",{parentName:"li"},"172.16.2.128"),".")),Object(o.b)("h4",{id:"inbound-call-changes"},"Inbound Call Changes"),Object(o.b)("p",null,"Consider an inbound SIP call received from the server ",Object(o.b)("inlineCode",{parentName:"p"},"172.16.2.102")," on the ",Object(o.b)("inlineCode",{parentName:"p"},"proxy-ip")," representing the PBX."),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"INVITE sip:phone3@172.16.2.128:5060 SIP/2.0\nVia: SIP/2.0/UDP 172.16.2.102:5060;branch=z9hG4bK-3585-1-0\nFrom: sipp <sip:sipp@172.16.2.102:5060>;tag=3585SIPpTag001\nTo: phone3 <sip:phone3@172.16.2.128:5060>\nCall-ID: 1-3585@172.16.2.102\nCSeq: 1 INVITE\nContact: sip:sipp@172.16.2.102:5060\nMax-Forwards: 70\nSubject: Performance Test\nContent-Type: application/sdp\nContent-Length:   135\n\nv=0\no=user1 53655765 2353687637 IN IP4 172.16.2.102\ns=-\nc=IN IP4 172.16.2.102\nt=0 0\nm=audio 6000 RTP/AVP 0\na=rtpmap:0 PCMU/8000\n")),Object(o.b)("p",null,"The above message is sent to ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio")," which in turn converts the public IPs to private addresses and forwards the message to the branch PBX. The new message will look as follows:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"INVITE sip:phone3@192.168.2.128:5060 SIP/2.0\nRecord-Route: <sip:172.16.2.128;lr;ftag=3585SIPpTag001>\nVia: SIP/2.0/UDP 172.16.2.128:5060;branch=z9hG4bK626e.01bb9cb7cd546e70477186f224a898da.0\nVia: SIP/2.0/UDP 172.16.2.102:5060;branch=z9hG4bK-3585-1-0\nFrom: sipp <sip:sipp@172.16.2.102:5060>;tag=3585SIPpTag001\nTo: phone3 <sip:phone3@192.168.2.128:5060>\nCall-ID: 1-3585@172.16.2.102\nCSeq: 1 INVITE\nContact: sip:sipp@172.16.2.102:5060\nMax-Forwards: 70\nSubject: Performance Test\nContent-Type: application/sdp\nContent-Length:   135\n\nv=0\no=user1 53655765 2353687637 IN IP4 172.16.2.102\ns=-\nc=IN IP4 172.16.2.102\nt=0 0\nm=audio 6000 RTP/AVP 0\na=rtpmap:0 PCMU/8000\n")),Object(o.b)("p",null,"In the inbound case, the following modifications were performed:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"The ",Object(o.b)("inlineCode",{parentName:"li"},"Record-Route")," header was added to ensure that the proxy is in the path for all future requests for the call."),Object(o.b)("li",{parentName:"ul"},"The ",Object(o.b)("inlineCode",{parentName:"li"},"Via")," header is added to ensure the proxy remains in path for all response messages."),Object(o.b)("li",{parentName:"ul"},"The Request URI and the ",Object(o.b)("inlineCode",{parentName:"li"},"To")," headers are fixed to point to the PBX private address instead of the ",Object(o.b)("inlineCode",{parentName:"li"},"proxy-ip"),".")),Object(o.b)("h2",{id:"troubleshooting"},"Troubleshooting"),Object(o.b)("h3",{id:"inspecting-kamailio"},"Inspecting Kamailio"),Object(o.b)("p",null,"The 128T ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," function launches a ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio")," service which is responsible for fixing up all the SIP messages. The operation of the process can be inspected via querying the systemd service for the appropriate ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," instance. For example:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"# systemctl status t128-sip-alg@PBX.service\n\u25cf t128-sip-alg@PBX.service - Kamailio service running in PBX\n   Loaded: loaded (/etc/systemd/system/t128-sip-alg@.service; disabled; vendor preset: disabled)\n   Active: active (running) since Wed 2020-07-08 18:52:33 UTC; 10h ago\n Main PID: 22261 (kamailio)\n   CGroup: /system.slice/system-t128\\x2dsip\\x2dalg.slice/t128-sip-alg@PBX.service\n           \u251c\u250022261 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022264 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022265 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022266 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022267 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022268 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022269 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022270 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022271 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022272 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022273 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022274 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022275 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022276 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022277 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022278 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022279 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022280 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022281 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u251c\u250022282 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n           \u2514\u250022283 /usr/sbin/kamailio -DD -P /var/run/kamailio/kamailio.pid -f /etc/kamailio/kamailio.PBX.cfg -m 64 -M 4\n\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ TO service <sip:service@172.16.2.102:5061>;tag=11336SIPpTag015 ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ CONTACT <sip:172.16.2.102:5061;transport=UDP> ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: It is a response to an outbound request\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: Reverse natting From header\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: Sending natted reply as:\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ STATUS 200 OK ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ VIA SIP/2.0/UDP 172.16.2.128:5061;branch=z9hG4bK4911.716b96ecc6684d3543e468d8454f285e.0, SIP/2.0/UDP 172.16.1.1...hG4bK-12741-5-7 ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ FROM sipp <sip:sipp@192.168.2.128:5060>;tag=12741SIPpTag005 ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ TO service <sip:service@172.16.2.102:5061>;tag=11336SIPpTag015 ]\nJul 08 18:57:36 t190-dut2.openstacklocal PBX[22278]: INFO: {2 Cseq: 2 BYE CId: 5-12741@192.168.2.128} <script>: [ CONTACT <sip:172.16.2.102:5061;transport=UDP> ]\nHint: Some lines were ellipsized, use -l to show in full.\n#\n")),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio")," configuration can be found under ",Object(o.b)("inlineCode",{parentName:"p"},"/etc/kamailio/kamailio.PBX.cfg")," and should reflect the ip-mappings and other configuration from the plugin configuration."),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Users should not make any manual changes to the ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio")," config as it would get overwritten from the 128T conductor."))),Object(o.b)("h3",{id:"inspecting-the-sip-alg-namespace"},"Inspecting the sip-alg Namespace"),Object(o.b)("p",null,"All of the ",Object(o.b)("inlineCode",{parentName:"p"},"sip-alg")," function, including ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio"),", operate from within a network namespace. Some of the common commands and the expected outputs are shown below."),Object(o.b)("p",null,"The following example shows the KNI configuration and the default route on a running system"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"# ip netns exec PBX ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host\n       valid_lft forever preferred_lft forever\n62: sip-private0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 66:2e:6e:54:ac:cb brd ff:ff:ff:ff:ff:ff\n    inet 169.254.129.18/30 scope global sip-private0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::642e:6eff:fe54:accb/64 scope link\n       valid_lft forever preferred_lft forever\n63: sip-public0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 3e:01:42:65:a9:fc brd ff:ff:ff:ff:ff:ff\n    inet 169.254.129.22/30 scope global sip-public0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::3c01:42ff:fe65:a9fc/64 scope link\n       valid_lft forever preferred_lft forever\n#\n# ip netns exec PBX ip route\ndefault via 169.254.129.21 dev sip-public0\n169.254.129.16/30 dev sip-private0 proto kernel scope link src 169.254.129.18\n169.254.129.20/30 dev sip-public0 proto kernel scope link src 169.254.129.22\n192.168.2.128 via 169.254.129.17 dev sip-private0\n#\n")),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"kamailio")," process would be listening on the configured SIP port to intercept and fix the SIP messages. The behavior can be validated by running the following command:"),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"# ip netns exec PBX netstat -pant\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        0      0 169.254.129.22:5060     0.0.0.0:*               LISTEN      19098/kamailio\ntcp        0      0 169.254.129.18:5060     0.0.0.0:*               LISTEN      19098/kamailio\n")),Object(o.b)("p",null,"Finally, the namespace is configured with a set of ",Object(o.b)("inlineCode",{parentName:"p"},"iptables")," rules to enable the static mapping from public to private. A typical set of rules can be seen below."),Object(o.b)("pre",null,Object(o.b)("code",Object(t.a)({parentName:"pre"},{}),"# ip netns exec PBX iptables -t nat -nvL\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    4  1776 DNAT       all  --  sip-private0 *       0.0.0.0/0            0.0.0.0/0            to:169.254.129.18\n    5  2558 DNAT       all  --  sip-public0 *       0.0.0.0/0            0.0.0.0/0            to:169.254.129.22\n\nChain INPUT (policy ACCEPT 9 packets, 4334 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 10 packets, 5485 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n   10  5485 SNAT       all  --  *      *       0.0.0.0/0            0.0.0.0/0            to:172.16.2.128\n")),Object(o.b)("div",{className:"footnotes"},Object(o.b)("hr",{parentName:"div"}),Object(o.b)("ol",{parentName:"div"},Object(o.b)("li",Object(t.a)({parentName:"ol"},{id:"fn-1"}),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Session_Initiation_Protocol"}),"https://en.wikipedia.org/wiki/Session_Initiation_Protocol"),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"#fnref-1",className:"footnote-backref"}),"\u21a9")),Object(o.b)("li",Object(t.a)({parentName:"ol"},{id:"fn-2"}),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Session_Description_Protocol"}),"https://en.wikipedia.org/wiki/Session_Description_Protocol"),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"#fnref-2",className:"footnote-backref"}),"\u21a9")),Object(o.b)("li",Object(t.a)({parentName:"ol"},{id:"fn-3"}),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"https://www.kamailio.org/"}),"https://www.kamailio.org/"),Object(o.b)("a",Object(t.a)({parentName:"li"},{href:"#fnref-3",className:"footnote-backref"}),"\u21a9")))))}p.isMDXComponent=!0},205:function(e,n,a){"use strict";a.d(n,"a",(function(){return d})),a.d(n,"b",(function(){return u}));var t=a(0),i=a.n(t);function o(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function r(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?r(Object(a),!0).forEach((function(n){o(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function c(e,n){if(null==e)return{};var a,t,i=function(e,n){if(null==e)return{};var a,t,i={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(i[a]=e[a]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=i.a.createContext({}),p=function(e){var n=i.a.useContext(l),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},d=function(e){var n=p(e.components);return i.a.createElement(l.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},m=i.a.forwardRef((function(e,n){var a=e.components,t=e.mdxType,o=e.originalType,r=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=p(a),m=t,u=d["".concat(r,".").concat(m)]||d[m]||b[m]||o;return a?i.a.createElement(u,s(s({ref:n},l),{},{components:a})):i.a.createElement(u,s({ref:n},l))}));function u(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var o=a.length,r=new Array(o);r[0]=m;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s.mdxType="string"==typeof e?e:t,r[1]=s;for(var l=2;l<o;l++)r[l]=a[l];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"},800:function(e,n,a){"use strict";a.r(n),n.default=a.p+"assets/images/sip_alg_outbound_call-76a5c94b7d79c612ef794eda5362613d.png"},801:function(e,n,a){"use strict";a.r(n),n.default=a.p+"assets/images/sip_alg_inbound_call-7c8c0d0fe0b66e6e2992bd10de3b4cb8.png"}}]);