"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[1471],{60869:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var n=i(74848),r=i(28453);const s={title:"Packet Capture",sidebar_label:"Packet Capture"},o=void 0,a={id:"ts_packet_capture",title:"Packet Capture",description:"PCAPs are one of the most useful tools to debug traffic issues on the SSR, as well as wider networking issues. The nature of troubleshooting is that it is transitory; once the problem has been identified, the system state should be restored to its previous state (or possibly with necessary modifications as a result of the troubleshooting exercise). This guide walks through the approaches for applying dynamic capture filters to the SSR Networking Platform.",source:"@site/docs/ts_packet_capture.md",sourceDirName:".",slug:"/ts_packet_capture",permalink:"/docs/ts_packet_capture",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1710187342,formattedLastUpdatedAt:"Mar 11, 2024",frontMatter:{title:"Packet Capture",sidebar_label:"Packet Capture"},sidebar:"docs",previous:{title:"MAC Address Uniqueness",permalink:"/docs/ts_mac_uniqueness"},next:{title:"Serial Console Troubleshooting",permalink:"/docs/ts_serial_console_tsing"}},c={},l=[{value:"PCLI Packet Capture per Device Interface",id:"pcli-packet-capture-per-device-interface",level:2},{value:"create capture-filter",id:"create-capture-filter",level:3},{value:"delete capture-filter",id:"delete-capture-filter",level:3},{value:"show capture-filter",id:"show-capture-filter",level:3},{value:"Selective Packet Capture",id:"selective-packet-capture",level:2},{value:"Default Mode",id:"default-mode",level:3},{value:"Local Mode",id:"local-mode",level:4},{value:"Creating Selective Packet Capture",id:"creating-selective-packet-capture",level:3},{value:"Removing Selective Packet Capture",id:"removing-selective-packet-capture",level:3},{value:"Showing Selective Packet Captures",id:"showing-selective-packet-captures",level:3},{value:"Session Capture in the GUI",id:"session-capture-in-the-gui",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"PCAPs are one of the most useful tools to debug traffic issues on the SSR, as well as wider networking issues. The nature of troubleshooting is that it is transitory; once the problem has been identified, the system state should be restored to its previous state (or possibly with necessary modifications as a result of the troubleshooting exercise). This guide walks through the approaches for applying dynamic capture filters to the SSR Networking Platform."}),"\n",(0,n.jsxs)(t.p,{children:["Packet capture information can be viewed and configured from both the PCLI and the ",(0,n.jsx)(t.a,{href:"#session-capture-in-the-gui",children:"user interface"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"pcli-packet-capture-per-device-interface",children:"PCLI Packet Capture per Device Interface"}),"\n",(0,n.jsx)(t.p,{children:"Enabling packet capture through configuration, while useful for defining filters that will survive a reboot, can pose challenges while debugging. Pending configuration changes may exist, requiring reverting the configuration so as to apply a capture filter. Thankfully there exists a dynamic way to apply capture filters to a device interface that does not require making configuration changes."}),"\n",(0,n.jsx)(t.p,{children:"When using dynamic capture filters, the following rules apply:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Creating or removing a dynamic capture filter does not persist and will not survive a restart of the SSR software"}),"\n",(0,n.jsxs)(t.li,{children:["Interactions exist with configured capture filters","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"If capture filters exist within the configuration and a configuration change happens that does not impact static capture filters, the configuration change will not affect dynamic capture filters"}),"\n",(0,n.jsx)(t.li,{children:"If static capture filters exist within the configuration, and if a configuration change modifies the static capture filters, all dynamic capture filters will be removed"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Three commands provide the capabilities to manage dynamic capture filters."}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/docs/cli_reference#create-capture-filter",children:"create capture-filter"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/docs/cli_reference#delete-capture-filter",children:"delete capture-filter"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/docs/cli_reference#show-capture-filters",children:"show capture-filter"})}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"create-capture-filter",children:"create capture-filter"}),"\n",(0,n.jsxs)(t.p,{children:["Dynamic capture filters use Berkeley Packet Filter (BPF) syntax, the same as statically configured capture filters. If the syntax is not correct, the filter will be rejected. Please refer to ",(0,n.jsx)(t.a,{href:"https://biot.com/capstats/bpf.html",children:"online BPF documentation"})," for syntax help. If a capture filter already exists, the create operation will be ignored."]}),"\n",(0,n.jsx)(t.p,{children:"The syntax for creating a capture filter can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> create capture-filter\n  usage: capture-filter [force] [router <router>] [node <node>]\n                         device-interface <device-interface> <capture-filter>\n  Creates capture-filter from highway at the specified node\n  keyword arguments:\n  device-interface    The device interface on which to create the capture\n                      filter\n  force               Skip confirmation prompt\n  node                The node on which to create the capture filter\n  router              The router on which to create the capture filter\n  positional arguments:\n  capture-filter      The capture-filter to create (Uses BPF syntax)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"delete-capture-filter",children:"delete capture-filter"}),"\n",(0,n.jsx)(t.p,{children:"This command can be used to remove dynamic capture filters as well as temporarily removing any static capture filtered added through configuration.  The command will return an error if the capture filter is not present."}),"\n",(0,n.jsx)(t.p,{children:"The syntax for removing a capture filter can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> delete capture-filter\n  usage: capture-filter [force] [router <router>] [node <node>]\n                        device-interface <device-interface> <capture-filter>\n  Deletes capture-filter from highway at the specified node\n  keyword arguments:\n  device-interface    The device interface on which to delete the capture\n                      filter\n  force               Skip confirmation prompt\n  node                The node on which to remove the capture filter\n  router              The router on which to remove the capture filter\n\n  positional arguments:\n  capture-filter    The capture-filter to remove (Uses BPF syntax)\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The keyword ",(0,n.jsx)(t.code,{children:"all"})," can be used as an argument to ",(0,n.jsx)(t.code,{children:"device-interface"})," to remove all capture filters on a particular node and router.  Omitting ",(0,n.jsx)(t.code,{children:"capture-filter"})," from the command will remove all capture filters for a specified device interface."]}),"\n",(0,n.jsx)(t.h3,{id:"show-capture-filter",children:"show capture-filter"}),"\n",(0,n.jsxs)(t.p,{children:["In order to display both static and dynamic capture filters, the ",(0,n.jsx)(t.em,{children:"show capture-filters"})," PCLI command will reflect the current state capture filters."]}),"\n",(0,n.jsx)(t.p,{children:"The syntax for displaying static and dynamic capture filters can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> show capture-filters\n  usage: capture-filters [device-interface <device-interface>]\n                         [force] [router <router>] [node <node>]\n  Show active capture-filters\n  keyword arguments:\n  device-interface    Device interface on which to show capture-filters\n  force               Skip confirmation prompt\n  node                The node on which to show capture-filters\n  router              The router on which to show capture-filters\n"})}),"\n",(0,n.jsx)(t.h2,{id:"selective-packet-capture",children:"Selective Packet Capture"}),"\n",(0,n.jsx)(t.p,{children:"While a powerful tool, it can be difficult to isolate a particular set of packets pertaining to a service using device-interface packet captures; especially if the session that is being tracked is an SVR session, where the IPs and L4 ports will be NATed. To simplify the troubleshooting effort, selective packet captures provides filtering controls beyond what is capable with BPF, and affords the administrator the ability to match traffic by service. A powerful capability of this feature is to apply a trace not only on the ingress node where the capture is defined, but also triggering traces on every subsequent SSR node the session traverses."}),"\n",(0,n.jsx)(t.p,{children:"Selective capture can operate in one of two modes:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.em,{children:"local-only"})," mode will trigger a capture only on the node to which the command is issued"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.em,{children:"default"})," mode will propagate the capture to all subsequent SSR nodes the session traverses"]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"Much like per device interface packet captures, selective packet captures will not survive a restart of the SSR."})}),"\n",(0,n.jsx)(t.h3,{id:"default-mode",children:"Default Mode"}),"\n",(0,n.jsx)(t.p,{children:"There are four locations within the SSR wherein capturing packets will provide full visibility into the behavior of a packet."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Forward flow of a session arriving on the ingress interface (before any NATing has been applied)"}),"\n",(0,n.jsx)(t.li,{children:"Forward flow of a session leaving the egress interface (post NAT with decrypted metadata)"}),"\n",(0,n.jsx)(t.li,{children:"Reverse flow of a session arriving on the egress interface"}),"\n",(0,n.jsx)(t.li,{children:"Reverse flow of a session leaving the ingress interface"}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["When creating a selective capture filter on the LAN interface, sessions will be tagged with an action that will capture all packets for the session at each of the four points listed above. Additionally, ",(0,n.jsx)(t.a,{href:"/docs/concepts_metadata",children:"metadata"})," will indicate to subsequent SSR nodes/routers to enable the packet capture for this session. Each SSR node will install capture filters in each of the four capture points for the same session. A ",(0,n.jsx)(t.a,{href:"https://www.tcpdump.org/pcap.html",children:"PCAP"})," file will be created on each node, containing the name of the service captured."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Typical Network Diagram",src:i(54524).A+"",width:"1305",height:"486"})}),"\n",(0,n.jsx)(t.p,{children:"Referencing the above diagram, a capture on node1.routerA will create PCAPs for a single session on each of the 12 points shown."}),"\n",(0,n.jsx)(t.h4,{id:"local-mode",children:"Local Mode"}),"\n",(0,n.jsxs)(t.p,{children:["When creating selective packet captures in ",(0,n.jsx)(t.em,{children:"local-mode"}),', a user can initiate a capture filter, targeting a particular node. No other "downstream" nodes will capture this session.']}),"\n",(0,n.jsx)(t.h3,{id:"creating-selective-packet-capture",children:"Creating Selective Packet Capture"}),"\n",(0,n.jsxs)(t.p,{children:["Executing ",(0,n.jsx)(t.code,{children:"create session-capture"})," will create a file with the name ",(0,n.jsx)(t.code,{children:"128T_service_<service-name>.pcap"})," on each node the session traverses. Additionally, ",(0,n.jsx)(t.code,{children:"INFO"})," level logging for session setup and tear down will be added to the ",(0,n.jsx)(t.code,{children:"serviceArea.log"}),". All sessions captured for the same service, even if they match more than one filter will be added to the same file and the \u201c.pcap\u201d file."]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"There is no mechanism to stop a capture for an existing session once the capture is in progress. Each session defaults to capturing 100 packets."})}),"\n",(0,n.jsx)(t.p,{children:"The syntax for creating a selective capture filter can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> create session-capture\nusage: session-capture [source-ip <source-ip>] [source-port <source-port>] [destination-ip <destination-ip>] [destination-port <destination-port>] [protocol <protocol>] [session-count\n                       <session-count>] [packet-count <packet-count>] [local-only] [force] [router <router>] [node <node>] service <service>\n\nCreates a session capture at the specified node for service\n\nWhen destination or source IPs are not specified, any IP will be matched.\nWhen destination or source port is not provided, port range of 0-65535 is used.\nWhen protocol is not provided, all protocols will be matched.\nWhen session-count is not specified, default will be unlimited.\nWhen packet-count is not specified, default is 100 packets in each direction for each session matched.\n\nkeyword arguments:\ndestination-ip      The destination IP address/prefix to match\ndestination-port    The destination port to match (can be a range)\nforce               Skip confirmation prompt\nlocal-only          Session capture is local to the node\nnode                The ingress node on which to create the session capture\npacket-count        The number of packets to capture per session, in each direction\nprotocol            The protocol to match (in decimal or by name, eg 'tcp')\nrouter              The router on which to create the session capture\nservice             The service on which to create the session capture\nsession-count       The number of sessions to capture\nsource-ip           The source IP address/prefix to match\nsource-port         The source port to match (can be a range)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"removing-selective-packet-capture",children:"Removing Selective Packet Capture"}),"\n",(0,n.jsxs)(t.p,{children:["The selective packet capture can be removed by specifying the filter or by the uniquely generated capture id which is displayed in the ",(0,n.jsx)(t.a,{href:"#showing-selective-packet-captures",children:"show command"}),":"]}),"\n",(0,n.jsx)(t.p,{children:"The syntax for removing a selective capture filter can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> delete session-capture\nusage: session-capture [source-ip <source-ip>] [source-port <source-port>] [destination-ip <destination-ip>] [destination-port <destination-port>] [protocol <protocol>] [session-count\n                       <session-count>] [packet-count <packet-count>] [local-only] [force] [router <router>] [node <node>] service <service>\n\nDeletes session-capture from selected service\n\nkeyword arguments:\ndestination-ip      The destination IP address/prefix to match\ndestination-port    The destination port to match (can be a range)\nforce               Skip confirmation prompt\nlocal-only          Session capture is local to the node\nnode                The node on which to remove the session-capture filter\npacket-count        The number of packets to capture per session, in each direction\nprotocol            The protocol to match (in decimal or by name, eg 'tcp')\nrouter              The router on which to remove the session-capture filter\nservice             The service on which to create the session capture\nsession-count       The number of sessions to capture\nsource-ip           The source IP address/prefix to match\nsource-port         The source port to match (can be a range)\n\nsubcommands:\nby-id    Deletes session-capture from selected service\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> delete session-capture by-id\nusage: by-id [force] [router <router>] [node <node>] service <service> <capture-id>\n\nDeletes session-capture from selected service\n\nkeyword arguments:\nforce      Skip confirmation prompt\nnode       The node on which to remove the session-capture filter\nrouter     The router on which to remove the session-capture filter\nservice    The service on which to create the session capture\n\npositional arguments:\ncapture-id    The session-capture to remove.\n"})}),"\n",(0,n.jsx)(t.p,{children:"If the selective capture is created for a limited number of sessions, once all the sessions have been captured, the capture will remove itself. Issuing a command to remove the capture will stop any new captures for new sessions on that service and any session that is still active will continue capturing until the packet count reaches the specified or default termination count."}),"\n",(0,n.jsx)(t.h3,{id:"showing-selective-packet-captures",children:"Showing Selective Packet Captures"}),"\n",(0,n.jsx)(t.p,{children:"The syntax for displaying selective packet capture filters can be seen below:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> show session-captures\nusage: session-captures [{id <id> | detail}] [service <service>] [force] [router <router>] [node <node>]\n\nShow active session-captures\n\nkeyword arguments:\ndetail     display session-captures in detail\nforce      Skip confirmation prompt\nid         The session-capture to show in detail\nnode       The node on which to show session-captures\nrouter     The router on which to show session-captures\nservice    Service for which to show session-captures\n"})}),"\n",(0,n.jsx)(t.p,{children:"The output from the show command will display currently enabled capture filters as well as the session IDs for those sessions that were captured.  With no parameters, the command will display a summary of all captures for all services.  Below is a sample output, with two captures for service \u201cwest\u201d, and one capture for service \u201ceast\u201d, with one active session being captured."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"========= ==== =================== =================== ========== ==================== =================\n Service   Id   Source              Destination         Protocol   Remaining Sessions   Active Sessions\n========= ==== =================== =================== ========== ==================== =================\n west       2   0.0.0.0/0:0-65535   0.0.0.0/0:0-65535   tcp        unlimited                          0\n west       5   0.0.0.0/0:0-65535   0.0.0.0/0:0-65535   icmp       unlimited                          1\n east       1   0.0.0.0/0:0-65535   0.0.0.0/0:0-65535   icmp       unlimited                          0\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If you specify the service and capture ID via arguments, you will see details of the sessions being captured.  In the above example you can see that service \u201cwest\u201d has an active session on capture ",(0,n.jsx)(t.code,{children:"5"}),".  The detailed view can be seen below, where it shows session \u201c1640858e-fe6a-44cd-b38a-7d479a68418\u201d is actively being captured:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:">> show session-captures service west id 5\nMon 2020-06-08 11:32:57 EDT\n\n\n=============================================\n Router: Novigrad\n=============================================\n ===========================================\n  Service: west\n  Id:      5\n ===========================================\n  Filter:\n    source-ip:        0.0.0.0/0\n    source-port:      0-65535\n    destination-ip:   0.0.0.0/0\n    destination-port: 0-65535\n    protocol:         icmp\n    packet-count:     100\n    session-count:    unlimited\n\n  Sessions:\n    active:           1\n      1640858e-fe6a-44cd-b38a-7d479a68418\n    remaining:        unlimited\n"})}),"\n",(0,n.jsx)(t.h2,{id:"session-capture-in-the-gui",children:"Session Capture in the GUI"}),"\n",(0,n.jsxs)(t.p,{children:["Packet capture in the GUI is labelled ",(0,n.jsx)(t.strong,{children:"Session Capture"})," and is accessed from the Tools menu."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Session Capture Window",src:i(39505).A+"",width:"576",height:"235"})}),"\n",(0,n.jsx)(t.p,{children:"Select a row to display the Details window for the capture. Selecting the PCAP FILE button brings you to the Logs page and displays the PCAP file, allowing you to select and download data. The capture can also be deleted from the Session Capture Details window."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Session Capture Details",src:i(59707).A+"",width:"576",height:"253"})}),"\n",(0,n.jsx)(t.p,{children:"To configure Session Capture, click the CREATE button to open the Create Session Capture window. Enter or select a router, and specify the information to capture."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Create Session Capture",src:i(89381).A+"",width:"432",height:"352"})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},89381:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/ts_create_session_capture-8a8115bbaa3716a7425a55c1e6cd0160.png"},54524:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/ts_packet_capture_selective_capture-a7d0ffc17c76e290192dabd14883ee9c.png"},59707:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/ts_session_capture_details-c72ed3a8181d1468f348d9c4933c22c9.png"},39505:(e,t,i)=>{i.d(t,{A:()=>n});const n=i.p+"assets/images/ts_session_capture_window-19f9edd46c3518c7221e57dcfc0f009d.png"},28453:(e,t,i)=>{i.d(t,{R:()=>o,x:()=>a});var n=i(96540);const r={},s=n.createContext(r);function o(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);