"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[5545],{8205:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var t=r(74848),s=r(28453);const i={title:"DNS Proxy",sidebar_label:"DNS Proxy"},o=void 0,a={id:"config_dns_proxy",title:"DNS Proxy",description:"In a typical hub/spoke deployment, its very common for the WAN interfaces to have some sort of dynamic interface such as DHCP, PPPoE, LTE, etc. The SSR can dynamically learn the DNS server address for these interfaces and can load balance DNS requests across the learned servers. The dns-proxy feature aims to provide a simple way to proxy all DNS requests originating on the LAN side to the learned server address(es) on the WAN side without having to re-configure or update client endpoints. This allows the network to better adapt to failures on the WAN interfaces while minimizing loss of connectivity from client side applications as clients can utilize the LAN address of the SSR to resolve DNS requests.",source:"@site/docs/config_dns_proxy.md",sourceDirName:".",slug:"/config_dns_proxy",permalink:"/docs/config_dns_proxy",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1711024380,formattedLastUpdatedAt:"Mar 21, 2024",frontMatter:{title:"DNS Proxy",sidebar_label:"DNS Proxy"},sidebar:"docs",previous:{title:"Audit Events",permalink:"/docs/config_audit_event"},next:{title:"Configuring Forward Error Correction",permalink:"/docs/config_forward_error_correction"}},d={},c=[{value:"Overview",id:"overview",level:2},{value:"Advertise Interface Address as DNS Server",id:"advertise-interface-address-as-dns-server",level:2},{value:"Configuring a DNS proxy service",id:"configuring-a-dns-proxy-service",level:2},{value:"How to proxy DNS requests originating from the linux host of the SSR",id:"how-to-proxy-dns-requests-originating-from-the-linux-host-of-the-ssr",level:3},{value:"Configuring Service Route(s)",id:"configuring-service-routes",level:2},{value:"Multiple learned DNS addresses",id:"multiple-learned-dns-addresses",level:3},{value:"Manually configured <code>target-address</code>",id:"manually-configured-target-address",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"In a typical hub/spoke deployment, its very common for the WAN interfaces to have some sort of dynamic interface such as DHCP, PPPoE, LTE, etc. The SSR can dynamically learn the DNS server address for these interfaces and can load balance DNS requests across the learned servers. The dns-proxy feature aims to provide a simple way to proxy all DNS requests originating on the LAN side to the learned server address(es) on the WAN side without having to re-configure or update client endpoints. This allows the network to better adapt to failures on the WAN interfaces while minimizing loss of connectivity from client side applications as clients can utilize the LAN address of the SSR to resolve DNS requests."}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"The common workflow for using this feature is as follows:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Configure a DNS server for the LAN network(s)"}),"\n",(0,t.jsx)(n.li,{children:"Configure a DNS proxy service to match the advertisement"}),"\n",(0,t.jsx)(n.li,{children:"Configure a service-route to indicate the WAN interface(s) to be used for proxying DNS requests"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"advertise-interface-address-as-dns-server",children:"Advertise Interface Address as DNS Server"}),"\n",(0,t.jsx)(n.p,{children:"A key component for DNS proxy is the ability to configure a fixed address as the DNS address for the clients on the LAN. A typical choice is to use the LAN-facing SSR interface address as the DNS server address, though the feature is not limited to this choice. The selected address can either be statically configured on the clients or configured via DHCP server (either external or SSR acting as the DHCP server)."}),"\n",(0,t.jsxs)(n.p,{children:["On a linux system representing a client, its ",(0,t.jsx)(n.code,{children:"/etc/resolv.conf"})," file would contain similar contents:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"; generated by /usr/sbin/dhclient-script\nsearch openstacklocal\nnameserver 10.10.10.1\n"})}),"\n",(0,t.jsx)(n.h2,{id:"configuring-a-dns-proxy-service",children:"Configuring a DNS proxy service"}),"\n",(0,t.jsxs)(n.p,{children:["The special ",(0,t.jsx)(n.code,{children:"dns-proxy"})," application-type is used for creating a DNS proxy service. All other service attributes such as access-policies, service-policies, etc., are also applicable to this service. The ",(0,t.jsx)(n.code,{children:"dns-proxy"})," application-type indicates to the SSR to perform a destination NAT on the traffic when the session is created for the service."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"admin@node1.conductor# show config running authority service lan-dns-proxy\n\nconfig\n\n    authority\n\n        service  lan-dns-proxy\n            name              lan-dns-proxy\n\n            transport         udp\n                protocol    udp\n\n                port-range  53\n                    start-port  53\n                exit\n            exit\n            address           10.10.10.1\n\n            access-policy     lan\n                source      lan\n                permission  allow\n            exit\n\n            access-policy     _internal_\n                source      _internal_\n                permission  allow\n            exit\n            application-type  dns-proxy\n        exit\n    exit\nexit\n\nadmin@node1.conductor#\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The example configuration captures all DNS traffic sent to address ",(0,t.jsx)(n.code,{children:"10.10.10.1"})," interface as configured on the test client in the previous step."]}),"\n",(0,t.jsx)(n.h3,{id:"how-to-proxy-dns-requests-originating-from-the-linux-host-of-the-ssr",children:"How to proxy DNS requests originating from the linux host of the SSR"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"_internal_"})," tenant has a special meaning on the SSRs as it represents the traffic originating from the host OS of the router. When the service allows the ",(0,t.jsx)(n.code,{children:"_internal_"})," tenant and a ",(0,t.jsx)(n.code,{children:"service-route"})," is created for this service, the target router linux environment is automatically configured for use with the DNS proxy. The ",(0,t.jsx)(n.code,{children:"/etc/resolv.conf"})," on the SSR is modified to point to a loopback address within the SSR."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"; This file has been automatically updated by SSR - DO NOT EDIT\nnameserver 169.254.127.126\n"})}),"\n",(0,t.jsx)(n.p,{children:"This allows all DNS queries (for example, as a result of dnf lookups, etc.) to be intercepted by SSR and create sessions appropriately."}),"\n",(0,t.jsxs)(n.p,{children:["Additionally, this loopback address needs to be added to ",(0,t.jsx)(n.code,{children:"dns-proxy"})," service."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"config\n    authority\n        service  lan-dns-proxy\n            name              lan-dns-proxy\n            ...\n            address           10.10.10.1\n            address           169.254.127.126\n            ...\n            application-type  dns-proxy\n        exit\n    exit\nexit\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"/etc/resolv.conf"})," file can also be configured to point to the LAN interface address to achieve the same results."]})}),"\n",(0,t.jsx)(n.h2,{id:"configuring-service-routes",children:"Configuring Service Route(s)"}),"\n",(0,t.jsxs)(n.p,{children:["When the service route's next hop for the dns-proxy service points to a dynamic interface such as DHCP based interface, any learned DNS address(es) will be automatically used as destination nat target for sessions for that service. This is accomplished by populating the ",(0,t.jsx)(n.code,{children:"next-hop"})," > ",(0,t.jsx)(n.code,{children:"target-address"})," configuration internally upon address resolution. An example of the service-route configuration is as follows:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"admin@node1.conductor# show config running authority router router1 node node1 device-interface inband-mgmt\n\nconfig\n\n    authority\n\n        router  router1\n            name  router1\n\n            node  node1\n                name              node1\n\n                device-interface  inband-mgmt\n                    name               inband-mgmt\n                    pci-address        0000:00:03.0\n\n                    network-interface  inband-mgmt-intf\n                        name          inband-mgmt-intf\n                        global-id     1\n                        conductor     true\n                        tenant        wan\n                        source-nat    true\n\n                        host-service  ssh\n                            service-type  ssh\n                        exit\n\n                        host-service  web\n                            service-type  web\n                        exit\n\n                        dhcp          v4\n                    exit\n                exit\n            exit\n        exit\n    exit\nexit\n\nadmin@node1.conductor# show config running authority router router1 service-route dns-proxy-route\n\nconfig\n\n    authority\n\n        router  router1\n            name           router1\n\n            service-route  dns-proxy-route\n                name          dns-proxy-route\n                service-name  lan-dns-proxy\n\n                next-hop      node1 inband-mgmt-intf\n                    node-name  node1\n                    interface  inband-mgmt-intf\n                    target-address 8.8.8.8\n                exit\n            exit\n        exit\n    exit\nexit\n\nadmin@node1.conductor#\n"})}),"\n",(0,t.jsx)(n.p,{children:"A few key points about the service-route for a dns-proxy service type:"}),"\n",(0,t.jsx)(n.h3,{id:"multiple-learned-dns-addresses",children:"Multiple learned DNS addresses"}),"\n",(0,t.jsx)(n.p,{children:"If the dynamic interface learns multiple IP addresses, the SSR will apply a round-robin load-balancing strategy amongst these IP address. Here's how you can check the details on the learned DNS addresses."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"admin@node1.conductor# show dhcp v4 router router1 name inband-mgmt-intf detail\nSat 2020-02-22 04:43:12 UTC\n\n============================================================\n Router\n============================================================\n  Node:                            node1\n    Device Interface:              inband-mgmt\n      Network Interface:           inband-mgmt-intf\n        Dhcp State:                Resolved\n          State Machine State:     Bound\n          Lease Start Time:        Sat Feb 22 00:28:30 2020\n          Lease Renewal Time:      Sat Feb 22 12:28:30 2020\n          Lease Rebinding Time:    Sat Feb 22 18:28:30 2020\n          Lease Expiration Time:   Sun Feb 23 00:28:30 2020\n          Learned MTU:             0 bytes\n          Server Address:          192.168.1.2\n          Dns Server Address:\n            - 172.20.0.100\n            - 172.20.0.101\n          Addresses:\n            Address:               192.168.1.10\n            Prefix Length:         24\n            Gateway:               192.168.1.1\n\nCompleted in 0.14 seconds\nadmin@node1.conductor#\n"})}),"\n",(0,t.jsx)(n.p,{children:"The following example illustrates how the round-robin strategy gets applied for load-balancing the data across multiple learned addresses for two back-to-back queries."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"admin@node1.conductor# show sessions router router1 | grep dns-proxy\n\u2714 Piping output...\n 745809ea-7ada-4225-a379-4159c1e226a2   fwd   lan-dns-proxy                                     lan          dpdk2            0   udp     10.10.10.11          52513   10.10.10.1               53   192.168.1.10         16398   false                     4   0 days  0:00:03\n 745809ea-7ada-4225-a379-4159c1e226a2   rev   lan-dns-proxy                                     lan          inband-mgmt      0   udp     172.20.0.100            53   192.168.1.10          16398   0.0.0.0                  0   false                     4   0 days  0:00:03\n\nadmin@node1.conductor# show sessions router router1 | grep dns-proxy\n\u2714 Piping output...\n 801d9495-66a4-44cf-9eea-e22731389a95   fwd   lan-dns-proxy                                     lan          dpdk2            0   udp     10.10.10.11          44426   10.10.10.1               53   192.168.1.10         16399   false                     5   0 days  0:00:03\n 801d9495-66a4-44cf-9eea-e22731389a95   rev   lan-dns-proxy                                     lan          inband-mgmt      0   udp     172.20.0.101            53   192.168.1.10          16399   0.0.0.0                  0   false                     5   0 days  0:00:03\n"})}),"\n",(0,t.jsxs)(n.h3,{id:"manually-configured-target-address",children:["Manually configured ",(0,t.jsx)(n.code,{children:"target-address"})]}),"\n",(0,t.jsxs)(n.p,{children:["As seen in the example ",(0,t.jsx)(n.a,{href:"#configuring-service-routes",children:"above"})," the ",(0,t.jsx)(n.code,{children:"service-route"})," > ",(0,t.jsx)(n.code,{children:"next-hop"})," points to a DHCP interface and also specifies ",(0,t.jsx)(n.code,{children:"8.8.8.8"})," as the target-address. When this configuration is present, the learned address are combined with the statically configured address(es). Based on the previous example, this means that there will be three DNS server targes (8.8.8.8, 172.20.0.100, 172.20.0.101). This configuration also allow the user to configure a failsafe DNS server address in case the DHCP server did not provide any valid DNS server addresses."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var t=r(96540);const s={},i=t.createContext(s);function o(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);