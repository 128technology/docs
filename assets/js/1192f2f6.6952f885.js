"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[1745],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return u}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),h=c(n),u=r,m=h["".concat(s,".").concat(u)]||h[u]||p[u]||i;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},18777:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},toc:function(){return d},default:function(){return h}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),o=["components"],l={title:"Service Health Learning and Fault Avoidance",sidebar_label:"Service Health Learning and Fault Avoidance"},s=void 0,c={unversionedId:"config_service_health",id:"config_service_health",title:"Service Health Learning and Fault Avoidance",description:"When an interface is operationally down, or ARP requests to the next-hop gateway are not consistently returned, the path in question will be removed from routing decisions. In concert with dynamic routing protocols such as BGP, network software is able to determine the best path to the destination. However in some deployments, routers can be pre-configured with all potentially available transports, or lacking in dynamic routing protocols to determine if the path to the final destination is available on a given route. As a result, the path selected by the router might effectively black-hole traffic.",source:"@site/docs/config_service_health.md",sourceDirName:".",slug:"/config_service_health",permalink:"/docs/config_service_health",tags:[],version:"current",lastUpdatedAt:1643309659,formattedLastUpdatedAt:"1/27/2022",frontMatter:{title:"Service Health Learning and Fault Avoidance",sidebar_label:"Service Health Learning and Fault Avoidance"},sidebar:"docs",previous:{title:"Configuring Role-Based Access Control",permalink:"/docs/config_RBAC"},next:{title:"SNMP",permalink:"/docs/config_snmp"}},d=[{value:"Detection Mode",id:"detection-mode",children:[{value:"Configure Detection Mode",id:"configure-detection-mode",children:[],level:3}],level:2},{value:"Enforcement Mode",id:"enforcement-mode",children:[{value:"Configure Enforcement Mode",id:"configure-enforcement-mode",children:[{value:"Creating a Reachability Detection Profile",id:"creating-a-reachability-detection-profile",children:[],level:4}],level:3},{value:"Traffic Profile",id:"traffic-profile",children:[],level:3},{value:"Health Probes",id:"health-probes",children:[{value:"Health Probes REST API",id:"health-probes-rest-api",children:[],level:4}],level:3},{value:"ICMP Probe",id:"icmp-probe",children:[{value:"Troubleshooting the ICMP Probe Profile",id:"troubleshooting-the-icmp-probe-profile",children:[],level:4}],level:3},{value:"Custom Health Probe Plugins",id:"custom-health-probe-plugins",children:[],level:3},{value:"Tracking Behavior",id:"tracking-behavior",children:[],level:3},{value:"Load Balancer Behavior",id:"load-balancer-behavior",children:[],level:3}],level:2},{value:"Troubleshooting",id:"troubleshooting",children:[],level:2}],p={toc:d};function h(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"When an interface is operationally down, or ARP requests to the next-hop gateway are not consistently returned, the path in question will be removed from routing decisions. In concert with dynamic routing protocols such as BGP, network software is able to determine the best path to the destination. However in some deployments, routers can be pre-configured with all potentially available transports, or lacking in dynamic routing protocols to determine if the path to the final destination is available on a given route. As a result, the path selected by the router might effectively black-hole traffic."),(0,i.kt)("p",null,"A unique advantage of Session Smart Routing is that it can understand patterns and characteristics of the underlying traffic passing through the system. These heuristics can then be leveraged on a number of different parameters in order to make more intelligent routing and load balancing decisions."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Per Service"),(0,i.kt)("li",{parentName:"ul"},"Per Path"),(0,i.kt)("li",{parentName:"ul"},"Per transport and application such as TCP, UDP, TLS etc"),(0,i.kt)("li",{parentName:"ul"},"Per destination (/32 address only)"),(0,i.kt)("li",{parentName:"ul"},"Per traffic-class (high, medium, low, best-effort)")),(0,i.kt)("p",null,"The Session Smart Router (SSR) collects key performance metrics to assist in making load balancing decisions, such as:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Number of TCP connection errors"),(0,i.kt)("li",{parentName:"ul"},"Number of UDP failures due to ICMP unreachable"),(0,i.kt)("li",{parentName:"ul"},"Time to first data packet for TCP and TLS")),(0,i.kt)("p",null,"Service Health Learning can operate in a detection mode to gather the metrics listed above, and then enforce path selection based on the experienced values."),(0,i.kt)("h2",{id:"detection-mode"},"Detection Mode"),(0,i.kt)("p",null,"Detection Mode is configured on the service-route, and allows you to gather statistics based on the traffic profiles as described in ",(0,i.kt)("a",{parentName:"p",href:"/docs/concepts_metrics#session-establishment-metrics"},"Session Establishment Metrics"),". This mode defines the criteria the 128T router uses to apply load balancing decisions. Detection mode allows you to visualize the current network and understand the necessary configuration for enforcement."),(0,i.kt)("h3",{id:"configure-detection-mode"},"Configure Detection Mode"),(0,i.kt)("p",null,"Detection Mode is configured per service-route, and gathers statistics using ",(0,i.kt)("a",{parentName:"p",href:"/docs/concepts_metrics#session-establishment-metrics"},"Session Establishment Metrics"),"."),(0,i.kt)("p",null,"To enable Detection Mode:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Under Authority, select a router."),(0,i.kt)("li",{parentName:"ol"},"Scroll down to Service Routes."),(0,i.kt)("li",{parentName:"ol"},"Click ADD."),(0,i.kt)("li",{parentName:"ol"},"Enter a Name for the new Service Route, and click SAVE."),(0,i.kt)("li",{parentName:"ol"},"Choose the Service Name."),(0,i.kt)("li",{parentName:"ol"},"Choose the Service Route Type and the Peer (if necessary).")),(0,i.kt)("p",null,"The following is an example configuration from the PCLI."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"authority\n\n    router  Fabric128\n        name           Fabric128\n\n        service-route  test-1_intf13_route-0\n            name                    test-1_intf13_route-0\n            service-name            east-0\n\n            next-hop                test-1 intf13\n                node-name   test-1\n                interface   intf13\n                gateway-ip  172.16.4.4\n            exit\n\n            reachability-detection\n                enabled           true\n                enforcement       false\n            exit\n        exit\n    exit\nexit\n")),(0,i.kt)("p",null,"Reachability Detection is now enabled and will gather service route information. Configure as many detection settings as necessary to gather information about the network connectivity.\nThe next step is to set Enforcement Mode parameters for load balancing."),(0,i.kt)("h2",{id:"enforcement-mode"},"Enforcement Mode"),(0,i.kt)("p",null,"In Enforcement Mode, you define a traffic profile using the parameters from Detection Mode to apply criteria that determines the health of a path and subsequent selection by the load balancer."),(0,i.kt)("h3",{id:"configure-enforcement-mode"},"Configure Enforcement Mode"),(0,i.kt)("p",null,"It is easiest to use the Service Routes configured in Detection Mode and simply enable Reachability Detection Enforcement."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Under Authority, select a Router."),(0,i.kt)("li",{parentName:"ol"},"Scroll down to Service Routes."),(0,i.kt)("li",{parentName:"ol"},"Select the Service Route."),(0,i.kt)("li",{parentName:"ol"},"Under Reachability Detection Settings, enable Reachability Detection Enforcement."),(0,i.kt)("li",{parentName:"ol"},"Define the Enforcement Detection Window (time). The ",(0,i.kt)("inlineCode",{parentName:"li"},"detection-window")," (default 5s) determines how often the stats will be aggregated in terms of min, max, and median."),(0,i.kt)("li",{parentName:"ol"},"Define an Enforcement Hold-Down time. This determines how long the path stays down upon determining it is unusable."),(0,i.kt)("li",{parentName:"ol"},"To use a probe to determine service health, configure the ",(0,i.kt)("inlineCode",{parentName:"li"},"probe-type")," as ",(0,i.kt)("inlineCode",{parentName:"li"},"always"),". To use only organic traffic to determine service health, set the ",(0,i.kt)("inlineCode",{parentName:"li"},"probe-type")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"disabled"),"."),(0,i.kt)("li",{parentName:"ol"},"If you have previously configured a Reachability Profile, select the appropriate profile. If there is no existing Reachability Detection Profile, use the procedure below."),(0,i.kt)("li",{parentName:"ol"},"Scroll to Reachability Detection Enforcement Probes and click ADD."),(0,i.kt)("li",{parentName:"ol"},"Enter a name for the probe and click SAVE."),(0,i.kt)("li",{parentName:"ol"},"In the Probe Type window, select a probe type from the drop-down. The default probe type is an ICMP probe."),(0,i.kt)("li",{parentName:"ol"},"Click Validate, and then Commit.")),(0,i.kt)("h4",{id:"creating-a-reachability-detection-profile"},"Creating a Reachability Detection Profile"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Go to the Router level (up one level)."),(0,i.kt)("li",{parentName:"ol"},"Scroll down to Reachability Profile, and click ADD."),(0,i.kt)("li",{parentName:"ol"},"Under Protocol, click ADD."),(0,i.kt)("li",{parentName:"ol"},"Select the Protocol type from the drop-down (tcp, tls, udp) and click SAVE."),(0,i.kt)("li",{parentName:"ol"},"Under the protocol class label, click ADD."),(0,i.kt)("li",{parentName:"ol"},"Select a traffic class ID and click SAVE. The traffic-class configuration allows you to configure different treatments for different classes of traffic for the same service."),(0,i.kt)("li",{parentName:"ol"},"In the Acceptable Error Threshold field, set the threshold."),(0,i.kt)("li",{parentName:"ol"},"In the ",(0,i.kt)("inlineCode",{parentName:"li"},"time-to-establishment.label")," field, set Enabled to true. Define the max and mean times as necessary. This configures the time allowed to establish a session for the protocol."),(0,i.kt)("li",{parentName:"ol"},"Return to the Router level."),(0,i.kt)("li",{parentName:"ol"},"Select the Service Route where the Enforcement settings will be in affect."),(0,i.kt)("li",{parentName:"ol"},"Scroll down to Reachability Detection settings. In the Reachability Detection Enforcement Profile select the Reachability Profile you just created."),(0,i.kt)("li",{parentName:"ol"},"Click Validate, and then Commit.")),(0,i.kt)("p",null,"The following is an example Enforcement configuration with a Reachability Profile entered from the PCLI."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"authority\n\n    router  Fabric128\n        name                  Fabric128\n\n        reachability-profile  profile-1\n            name      profile-1\n\n            protocol  tcp\n                protocol-type  tcp\n\n                traffic-class  high\n                    traffic-class-id            high\n                    enabled                     true\n                    acceptable-error-threshold  50\n\n                    time-to-establishment\n                        enabled  true\n                        max      500\n                        mean     250\n                    exit\n                exit\n            exit\n\n            protocol  udp\n                protocol-type  udp\n\n                traffic-class  high\n                    traffic-class-id            high\n                    enabled                     true\n                    acceptable-error-threshold  50\n\n                    time-to-establishment\n                        enabled  true\n                        max      500\n                        mean     250\n                    exit\n                exit\n            exit\n        exit\n\n        service-route  test-1_intf13_route-0\n            name                    test-1_intf13_route-0\n            service-name            east-0\n\n            next-hop                test-1 intf13\n                node-name   test-1\n                interface   intf13\n                gateway-ip  172.16.4.4\n            exit\n\n            reachability-detection\n                enabled               true\n                enforcement           true\n                detection-window      10\n                hold-down             60\n                reachability-profile  profile-1\n                probe-type            always\n\n                probe                 foo\n                    name                foo\n                    enabled             true\n                    icmp-probe-profile  icmp-profile-0\n                exit\n            exit\n        exit\n    exit\nexit\n")),(0,i.kt)("h3",{id:"traffic-profile"},"Traffic Profile"),(0,i.kt)("p",null,"When a traffic profile is configured, it allows for the enforcement of path characteristics."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"router > traffic-profile\n    name    profile1\n    protocol tcp\n          protocol tcp\n          traffic-class high\n              traffic-class high\n              enabled true\n              acceptable-error-threshold    5\n              time-to-establishment\n                    enabled true\n                max       100\n                mean          50\n          traffic-class best-effort\n              traffic-class best-effort\n              enabled true\n              acceptable-error-threshold    10\n              time-to-establishment\n                    enabled true\n                max       500\n                mean          250\n    protocol udp\n          protocol udp\n          acceptable-error-threshold    20\n          time-to-establishment\n         enabled    false\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"traffic-profile")," allows the user to configure enforcement parameters for tcp, udp and tls."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"traffic-class")," allows the user to configure different treatments for different classes of traffic for the same service. The same default values (as described below) apply to all the classes."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"acceptable-error-threshold")," (expressed in percentage) is the amount of errors acceptable on the path before taking it offline. For TCP, this includes the session closed before establishment, any ICMP error that constitutes destination unreachable, and session timeout before establishment. For UDP, this includes the destination unreachable class of ICMP errors."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"time-to-establishment")," allows the user to configure a max and a mean time for a session to be established as defined for the protocol within the configured detection-window. The following table describes the default values.")),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Config"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Default Value"),(0,i.kt)("th",{parentName:"tr",align:null},"How to disable?"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"acceptable-error-threshold"),(0,i.kt)("td",{parentName:"tr",align:null},"percentage"),(0,i.kt)("td",{parentName:"tr",align:null},"25%"),(0,i.kt)("td",{parentName:"tr",align:null},"0%")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"traffic-class"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"enabled"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"true"),(0,i.kt)("td",{parentName:"tr",align:null},"false")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"time-to-establishment"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"- enabled"),(0,i.kt)("td",{parentName:"tr",align:null},"boolean"),(0,i.kt)("td",{parentName:"tr",align:null},"true"),(0,i.kt)("td",{parentName:"tr",align:null},"false")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"- max"),(0,i.kt)("td",{parentName:"tr",align:null},"milliseconds"),(0,i.kt)("td",{parentName:"tr",align:null},"500 ms"),(0,i.kt)("td",{parentName:"tr",align:null},"0 ms")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"- mean"),(0,i.kt)("td",{parentName:"tr",align:null},"milliseconds"),(0,i.kt)("td",{parentName:"tr",align:null},"250 ms"),(0,i.kt)("td",{parentName:"tr",align:null},"0 ms")))),(0,i.kt)("p",null,"Once a profile is configured, the above defaults are enforced. To turn off the specific enforcement, configure an appropriate value as listed above."),(0,i.kt)("h3",{id:"health-probes"},"Health Probes"),(0,i.kt)("p",null,"An ICMP probe, as described below is built into the system, providing the health probe method. Other application specific probes (",(0,i.kt)("a",{parentName:"p",href:"/docs/plugin_http_probe"},"HTTP, TLS"),", SIP, etc.) are made possible with external plugins utilizing the REST API added for this feature. The two main aspects are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Load-balancer API to declare select paths as down"),(0,i.kt)("li",{parentName:"ul"},"Mechanism to report activity or inactivity over a path to an external application")),(0,i.kt)("h4",{id:"health-probes-rest-api"},"Health Probes REST API"),(0,i.kt)("p",null,"The reachability manager provides a REST API for setting, getting, and deleting probe state. Note that the state is cleared when the probe-type becomes disabled."),(0,i.kt)("p",null,"If any probe sets state to down for the service-path, the path is marked as down. The path may still periodically become up to allow organic traffic for one interval as it exits the hold-down period. This can be seen through the ",(0,i.kt)("inlineCode",{parentName:"p"},"show service-path")," command."),(0,i.kt)("p",null,"For the REST API, either (service-route + service) or (network-interface) must be given. Network-interface may map to more than one service-route. One service-route may map to multiple service-paths."),(0,i.kt)("h3",{id:"icmp-probe"},"ICMP Probe"),(0,i.kt)("p",null,"The default probe is an ICMP based health probe to detect the liveliness of the remote endpoint. Below is a sample config:"),(0,i.kt)("p",null,"The probe-name for the REST API is ",(0,i.kt)("inlineCode",{parentName:"p"},"128T-icmp-probe"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"icmp-probe-profile\n    name                     icmp-profile1\n    probe-interval      10s\n    number-of-attempts      5\n    probe-duration      1s\n    probe-address             8.8.8.8\n    probe-address             9.9.9.9\n    sla-metrics\n        max-loss    10%\n        latency\n            max 200ms\n            mean    50ms\n\n")),(0,i.kt)("p",null,"The following table describes the configuration values above:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Config"),(0,i.kt)("th",{parentName:"tr",align:null},"Type"),(0,i.kt)("th",{parentName:"tr",align:null},"Constraints"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"router > icmp-probe-profile"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"name"),(0,i.kt)("td",{parentName:"tr",align:null},"string"),(0,i.kt)("td",{parentName:"tr",align:null},"key"),(0,i.kt)("td",{parentName:"tr",align:null},"Unique name to identify an ICMP probe profile")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"probe-interval"),(0,i.kt)("td",{parentName:"tr",align:null},"uint32 (seconds) range: 1-3600"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 10"),(0,i.kt)("td",{parentName:"tr",align:null},"Duration (in seconds) of how often to perform a link test to the destination.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"number-of-attempts"),(0,i.kt)("td",{parentName:"tr",align:null},"uint8 range: 1-20"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 4"),(0,i.kt)("td",{parentName:"tr",align:null},"Number of consecutive ICMP ping requests to be sent within the probe-duration before deciding that destination is unreachable.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"probe-duration"),(0,i.kt)("td",{parentName:"tr",align:null},"uint8 (seconds) range: 1-10"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 1"),(0,i.kt)("td",{parentName:"tr",align:null},"Duration (in seconds) within which to reach the destination. Each attempt will be made in probe-duration / number-of-attempts interval.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"sla-metrics"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null})),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"max-loss"),(0,i.kt)("td",{parentName:"tr",align:null},"uint8 (percent)"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 10%"),(0,i.kt)("td",{parentName:"tr",align:null},"The amount of acceptable loss on the link. The loss will be determined by sending number-of-attempts ICMP requests and waiting the probe-duration to get the replies back.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"latency > max"),(0,i.kt)("td",{parentName:"tr",align:null},"milliseconds"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 250"),(0,i.kt)("td",{parentName:"tr",align:null},"Maximum acceptable latency based on the ping test.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"latency > mean"),(0,i.kt)("td",{parentName:"tr",align:null},"milliseconds"),(0,i.kt)("td",{parentName:"tr",align:null},"default: 100"),(0,i.kt)("td",{parentName:"tr",align:null},"The average latency on a path based on the ping test.")))),(0,i.kt)("h4",{id:"troubleshooting-the-icmp-probe-profile"},"Troubleshooting the ICMP Probe Profile"),(0,i.kt)("p",null,"If any of the addresses listed in the profile do not meet the SLA requirements, all service-routes referencing this profile are marked as down."),(0,i.kt)("p",null,"Stats are available for number of failed-to-send, response-timeout, and ping success in total, and for ping exceeded-by-max-loss, exceeded-by-max-latency, and exceeded-by-mean-latency."),(0,i.kt)("p",null,"Ping state will be detected for each unique combination of probe-profile, service-name, and tenant."),(0,i.kt)("p",null,"If an ICMP probe fails to send requests, the PCLI ping command and highway logs can be used to debug. If ",(0,i.kt)("inlineCode",{parentName:"p"},"ping node <node-name> egress-interface <intf-name> gateway <gateway-ip> <address>")," succeeds where the node and egress-interface match the service-route next-hop and the gateway is from the routing FIB or the interface gateway, then the ICMP probe will be able to send a ping."),(0,i.kt)("p",null,"Probe-interval and probe-duration should be tuned so that probe-interval + probe-duration is less than the detection-window, allowing the ping to run to completion within the detection window. If the ping interval is longer, when the path is declared down, is held-down, and is brought up for one window, the probe may say the path is down and the service-path will be brought down again, bouncing the path repeatedly."),(0,i.kt)("h3",{id:"custom-health-probe-plugins"},"Custom Health Probe Plugins"),(0,i.kt)("p",null,"The extensibility APIs described above enable plugins to be developed for performing additional probes using TCP, ",(0,i.kt)("a",{parentName:"p",href:"/docs/plugin_http_probe"},"TLS, HTTP"),", SIP etc. The plugin workflow for these types of probes would be as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Augment the service-route > reachability-detection > probe choice statement to plugin specific probe configuration. In general, there is no restriction enforced on what and how many plugins run a reachability check in parallel."),(0,i.kt)("li",{parentName:"ul"},"The probe plugin operates independently to determine if the path is up or down. Based on the specific business logic, the plugin triggers the path down using the load balancer APIs."),(0,i.kt)("li",{parentName:"ul"},"The probe plugin uses the probe-status REST API to set service-paths up or down.")),(0,i.kt)("h3",{id:"tracking-behavior"},"Tracking Behavior"),(0,i.kt)("p",null,"The algorithm for tracking errors, establishment times, etc. is run on a per-service, per-path and per-traffic-class basis. In addition, the following destination address are also tracked:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Any fully qualified address (/32 for IPv4 and /128 for IPv6) configured in service > address is tracked for the above metrics."),(0,i.kt)("li",{parentName:"ul"},"When there is a service-route > nat-target or service-route > next-hop > target-address configured, they are tracked for the metrics above.")),(0,i.kt)("h3",{id:"load-balancer-behavior"},"Load Balancer Behavior"),(0,i.kt)("p",null,"An algorithm is used to flag and recover path failures."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The enforcement algorithm calculates the health of each path based on the profile at the configured detection interval."),(0,i.kt)("li",{parentName:"ul"},"When any of the configured thresholds are exceeded, the path is flagged as unusable. The first test to fail causes the path to be taken out of consideration from the load balancer."),(0,i.kt)("li",{parentName:"ul"},"Once the path is deemed to be not healthy: The subsequent sessions are used for routing. In the event that none of the paths are healthy, the best-effort algorithm picks one of the paths for routing sessions. This can be disabled by turning off best-effort configuration in the service-policy.")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"When a path becomes unavailable, all the existing sessions continue to be routed over this path. Since this is non-SVR, changing a destination or path might have unintended consequences."))),(0,i.kt)("p",null,"The path is kept down for the configured hold-down time before being put back in service. At that time, the tracking and enforcement algorithm restarts."),(0,i.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,i.kt)("p",null,"If the value of the threshold or window is too small, the link will go in and out of service. If this is the case, adjust the threshold value in the configuration."),(0,i.kt)("p",null,"Alarms and events:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"During enforcement mode, if a path is taken out of service for a given service, protocol, or traffic class, an alarm is generated to indicate the event. The alarm is cleared when the path is put back in service.")),(0,i.kt)("p",null,"Show commands:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"show stats")," command can be used for capturing the \u201ccurrent\u201d snapshot of the relevant stats.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"For the icmp-probe use ",(0,i.kt)("inlineCode",{parentName:"li"},"show stats icmp reachability-probe")))),(0,i.kt)("li",{parentName:"ul"},"The Meets-SLA field has been added to the ",(0,i.kt)("inlineCode",{parentName:"li"},"show load-balancer")," command to indicate the result of the reachability detection.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"======== ========= ====== ======= ====== ========= ======== ===== ===========\n   Type   Quality   Cost   State   Loss   Latency   Jitter   Mos   Meets-SLA\n======== ========= ====== ======= ====== ========= ======== ===== ===========\n router         0    N/A      up   0.7%     250ms    100ms   2.0         Yes\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"show service-path detail")," output indicates when a non-SVR path is no longer in-service and why.\nTwo fields have been added to the show command: Meets-SLA and Reachability-Probes. Meets-SLA indicates if a service agent meets or satisfies SLA as a result of reachability detection. Reachability-Probes shows the probes status from reachability detection.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"show service-path\n\n==============\n Service: web\n==============\n  Service-Route:    web-route1\n  Type:                    service-agent\n  Destination:         4.4.4.4\n  Next-Hop:            1.1.1.3, Lan(Down)[Gateway Arp unresolved)\n  Peer:                    unavailable\n  Path-Metrics:\n     High\n         TCP:  latency [0ms] loss [0] jitter [0ms]\n         TLS:  latency [0ms] loss [0] jitter [0ms]\n         UDP:  latency [0ms] loss [0] jitter [0ms]\n         ICMP: latency [0ms] loss [0] jitter [0ms]\n     Medium\n         TCP:  latency [0ms] loss [0] jitter [0ms]\n         TLS:  latency [0ms] loss [0] jitter [0ms]\n         UDP:  latency [0ms] loss [0] jitter [0ms]\n         ICMP: latency [0ms] loss [0] jitter [0ms]\n     Low\n         TCP:  latency [0ms] loss [0] jitter [0ms]\n         TLS:  latency [0ms] loss [0] jitter [0ms]\n         UDP:  latency [0ms] loss [0] jitter [0ms]\n         ICMP: latency [0ms] loss [0] jitter [0ms]\n     Best-Effort\n         TCP:  latency [0ms] loss [0] jitter [0ms]\n         TLS:  latency [0ms] loss [0] jitter [0ms]\n         UDP:  latency [0ms] loss [0] jitter [0ms]\n         ICMP: latency [0ms] loss [0] jitter [0ms]\n  Vector:                   Red\n  Cost:                      10\n  Rate:                      1\n  Capacity:               200/3000\n  Index:                    18\n  Meets-SLA:           Yes\n  Reachability-Probes:\n               TestProbe1: Up\n               TestProbe2: Down\n")))}h.isMDXComponent=!0}}]);