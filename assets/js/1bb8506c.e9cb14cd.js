"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[5090],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return d}});var o=t(67294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,o,s=function(e,n){if(null==e)return{};var t,o,s={},r=Object.keys(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)t=r[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var l=o.createContext({}),c=function(e){var n=o.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return o.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},m=o.forwardRef((function(e,n){var t=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),m=c(t),d=s,h=m["".concat(l,".").concat(d)]||m[d]||u[d]||r;return t?o.createElement(h,i(i({ref:n},p),{},{components:t})):o.createElement(h,i({ref:n},p))}));function d(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var r=t.length,i=new Array(r);i[0]=m;var a={};for(var l in n)hasOwnProperty.call(n,l)&&(a[l]=n[l]);a.originalType=e,a.mdxType="string"==typeof e?e:s,i[1]=a;for(var c=2;c<r;c++)i[c]=t[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},69491:function(e,n,t){t.r(n),t.d(n,{assets:function(){return p},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return a},metadata:function(){return c},toc:function(){return u}});var o=t(87462),s=t(63366),r=(t(67294),t(3905)),i=["components"],a={title:"Automated Provisioner: Salt Minion",sidebar_label:"AP: Salt Minion"},l=void 0,c={unversionedId:"ts_ap_salt_minion",id:"ts_ap_salt_minion",title:"Automated Provisioner: Salt Minion",description:"This document describes the process for troubleshooting issues with Automated Provisioning (AP) using Salt.",source:"@site/docs/ts_ap_salt_minion.md",sourceDirName:".",slug:"/ts_ap_salt_minion",permalink:"/docs/ts_ap_salt_minion",draft:!1,tags:[],version:"current",lastUpdatedAt:1680630116,formattedLastUpdatedAt:"Apr 4, 2023",frontMatter:{title:"Automated Provisioner: Salt Minion",sidebar_label:"AP: Salt Minion"},sidebar:"docs",previous:{title:"AP: Duplicate Asset ID Error",permalink:"/docs/ts_ap_duplicate_assets"},next:{title:"CPU Spikes",permalink:"/docs/ts_cpu_spikes"}},p={},u=[{value:"Symptoms",id:"symptoms",level:2},{value:"Root Cause",id:"root-cause",level:2},{value:"Steps to Rectify",id:"steps-to-rectify",level:2},{value:"Diagnosing the issues",id:"diagnosing-the-issues",level:3}],m={toc:u};function d(e){var n=e.components,t=(0,s.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This document describes the process for troubleshooting issues with Automated Provisioning (AP) using Salt."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},'The terms "salt-master" and "conductor" are used interchangeably throughout this document. "Salt-master" refers to the salt-master process running on the conductor, which orchestrates tasks for AP.  Also the terms "minion", "salt-minion" and "asset" are used interchangeably throughout this document. "Minion" runs on an "asset", or system hosting a 128T router. Minions are responsible for carrying out tasks on the host, given to it by the salt-master.')),(0,r.kt)("h2",{id:"symptoms"},"Symptoms"),(0,r.kt)("p",null,"There are several conditions which are symptomatic of issues which may be affecting AP, such as asset disconnected from conductor and general asset errors. These can be seen from conductor CLI using the ",(0,r.kt)("inlineCode",{parentName:"p"},"show assets")," command with a provided asset-id. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"admin@node1.conductor# show assets asset-id\nMon 2019-08-21 19:45:35 EDT\n\n=======================================\n asset-id\n=======================================\n Router:                  my-router\n Node:                    node1\n Current Version:         None\n Status:                  disconnected\n\n -----------------------------\n Software Versions Information\n -----------------------------\n Refresh In Progress:     False\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"admin@node1.conductor# show assets asset-id\nMon 2019-08-26 19:45:12 EDT\n\n=============================================================================\n asset-id\n=============================================================================\n Router:                  my-router\n Node:                    node1\n Current Version:         4.1.4-1.el7.centos\n Status:                  running\n Failed Status:           running\n\n ------\n Errors\n ------\n reverse-ssh_conductor1_login_unit: Unable to manage file: Message timed out\n")),(0,r.kt)("h2",{id:"root-cause"},"Root Cause"),(0,r.kt)("p",null,"At certain times some errors that are seen may be transient during periods of intermittent connectivity, or while the salt-master corrects things found in the incorrect state on the minion. Errors that persist are often the result of issues with connectivity between the minion and conductor, or the minion timing out tying to complete tasks given to it by the salt-master."),(0,r.kt)("h2",{id:"steps-to-rectify"},"Steps to Rectify"),(0,r.kt)("p",null,"Throughout the lifecycle of a 128T asset, some errors are normal and will clear on their own over time. The first steps are to ensure there is working connectivity between the minion and the salt-master."),(0,r.kt)("h3",{id:"diagnosing-the-issues"},"Diagnosing the issues"),(0,r.kt)("p",null,"The following steps can help diagnose issues with salt-minion which may be affecting AP:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ensure that the ",(0,r.kt)("inlineCode",{parentName:"li"},"salt-minion")," process is running:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[t128@host ~]$ sudo systemctl status salt-minion\n\u25cf salt-minion.service - The Salt Minion\n   Loaded: loaded (/usr/lib/systemd/system/salt-minion.service; enabled; vendor preset: disabled)\n  Drop-In: /usr/lib/systemd/system/salt-minion.service.d\n           \u2514\u2500restartAlways.conf\n   Active: active (running) since Wed 2019-08-28 09:23:19 PDT; 6min ago\n     Docs: man:salt-minion(1)\n           file:///usr/share/doc/salt/html/contents.html\n           https://docs.saltstack.com/en/latest/contents.html\n Main PID: 5036 (salt-minion)\n    Tasks: 14\n   Memory: 92.0M\n   CGroup: /system.slice/salt-minion.service\n           \u251c\u25005036 /usr/bin/python /usr/bin/salt-minion\n           \u251c\u25005039 /usr/bin/python /usr/bin/salt-minion\n           \u2514\u25005058 /usr/bin/python /usr/bin/salt-minion\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ensure the host has a working route to conductor by inspecting the route table. For example the following host has a default route via the ",(0,r.kt)("inlineCode",{parentName:"li"},"kni254")," data interface:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[t128@host ~]$ ip r l\ndefault via 169.254.127.126 dev kni254\n169.254.0.0/16 dev kni254 scope link metric 1009\n169.254.127.126/31 dev kni254 proto kernel scope link src 169.254.127.127\n169.254.253.128/30 dev habr proto kernel scope link src 169.254.253.130 metric 425\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Verify that the minion is successfully opening connections to the salt-master on TCP port 4505 and 4506. For example, you can use the ",(0,r.kt)("inlineCode",{parentName:"li"},"ss")," Linux utility to look for active sockets:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[t128@host ~]$ sudo ss -ptn | grep -E \'(4505|4506)\'\nESTAB      0      162    169.254.127.127:39308              128.128.128.128:4506                users:(("salt-minion",pid=5234,fd=24))\nESTAB      0      0      169.254.127.127:35024              128.128.128.128:4505                users:(("salt-minion",pid=5234,fd=19),("salt-minion",pid=5039,fd=19))\n')),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Connections on TCP port 4506 are transient, and only exist when the minion needs to report information back to the salt-master. Seeing a none, or a varying number of connections being opened on TCP port 4506 is normal.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If you suspect network issues are impacting the minion's ability to function, you can further diagnose by verifying packets are flowing as expected on the wire using ",(0,r.kt)("inlineCode",{parentName:"li"},"tcpdump"),". For example:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[t128@host ~]$ sudo tcpdump -i any 'tcp port 4505 or tcp port 4506' -nnN\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes\n09:34:55.380670 IP 128.128.128.128.4505 > 169.254.127.127.35024: Flags [.], ack 1309158047, win 219, options [nop,nop,TS val 2905329152 ecr 1874888070], length 0\n09:34:55.380703 IP 169.254.127.127.35024 > 128.128.128.128.4505: Flags [.], ack 1, win 544, options [nop,nop,TS val 1874908102 ecr 2905322513], length 0\n09:34:56.892259 IP 169.254.127.127.39500 > 128.128.128.128.4506: Flags [S], seq 1973885769, win 29200, options [mss 1460,sackOK,TS val 1874909613 ecr 0,nop,wscale 7], length 0\n09:34:56.982670 IP 128.128.128.128.4506 > 169.254.127.127.39500: Flags [S.], seq 2047989050, ack 1973885770, win 26847, options [mss 1460,sackOK,TS val 2905330754 ecr 1874909613,nop,wscale 7], length 0\n09:34:56.982752 IP 169.254.127.127.39500 > 128.128.128.128.4506: Flags [.], ack 1, win 229, options [nop,nop,TS val 1874909704 ecr 2905330754], length 0\n09:34:56.983720 IP 169.254.127.127.39500 > 128.128.128.128.4506: Flags [P.], seq 1:499, ack 1, win 229, options [nop,nop,TS val 1874909705 ecr 2905330754], length 498\n09:34:57.073622 IP 128.128.128.128.4506 > 169.254.127.127.39500: Flags [.], ack 499, win 219, options [nop,nop,TS val 2905330844 ecr 1874909705], length 0\n09:34:57.075619 IP 128.128.128.128.4506 > 169.254.127.127.39500: Flags [P.], seq 1:85, ack 499, win 219, options [nop,nop,TS val 2905330847 ecr 1874909705], length 84\n09:34:57.075648 IP 169.254.127.127.39500 > 128.128.128.128.4506: Flags [.], ack 85, win 229, options [nop,nop,TS val 1874909797 ecr 2905330847], length 0\n09:34:57.077239 IP 169.254.127.127.39500 > 128.128.128.128.4506: Flags [F.], seq 499, ack 85, win 229, options [nop,nop,TS val 1874909798 ecr 2905330847], length 0\n09:34:57.168641 IP 128.128.128.128.4506 > 169.254.127.127.39500: Flags [F.], seq 85, ack 500, win 219, options [nop,nop,TS val 2905330940 ecr 1874909798], length 0\n")),(0,r.kt)("p",null,"If the ",(0,r.kt)("inlineCode",{parentName:"p"},"salt-minion")," does not appear to be attempting connections to salt-master, or has healthy connections to conductor but continues to have persistent errors, you can try restarting ",(0,r.kt)("inlineCode",{parentName:"p"},"salt-minion"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"sudo systemctl restart salt-minion\n")),(0,r.kt)("p",null,"If it appears there are connectivity issues that are preventing AP from functioning, correct any networking issues that exist."))}d.isMDXComponent=!0}}]);