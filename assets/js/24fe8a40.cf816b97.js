"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[4024],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(n),h=i,m=u["".concat(l,".").concat(h)]||u[h]||c[h]||o;return n?a.createElement(m,r(r({ref:t},p),{},{components:n})):a.createElement(m,r({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var d=2;d<o;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},70846:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return c}});var a=n(87462),i=n(63366),o=(n(67294),n(3905)),r=["components"],s={title:"Network Address Translation (NAT)",sidebar_label:"NAT"},l=void 0,d={unversionedId:"config_nat",id:"config_nat",title:"Network Address Translation (NAT)",description:"Source NAT",source:"@site/docs/config_nat.md",sourceDirName:".",slug:"/config_nat",permalink:"/docs/config_nat",draft:!1,tags:[],version:"current",lastUpdatedAt:1700509826,formattedLastUpdatedAt:"Nov 20, 2023",frontMatter:{title:"Network Address Translation (NAT)",sidebar_label:"NAT"},sidebar:"docs",previous:{title:"In-Memory Metrics",permalink:"/docs/config_in-memory_metrics"},next:{title:"Rate Limiting",permalink:"/docs/config_rate_limiting"}},p={},c=[{value:"Source NAT",id:"source-nat",level:2},{value:"Destination NAT",id:"destination-nat",level:2},{value:"Static NAT",id:"static-nat",level:2},{value:"Example",id:"example",level:4},{value:"Using the GUI",id:"using-the-gui",level:3},{value:"Show Commands",id:"show-commands",level:3},{value:"Source NAT",id:"source-nat-1",level:4},{value:"Destination NAT",id:"destination-nat-1",level:4},{value:"Version History",id:"version-history",level:4},{value:"NAT Pools",id:"nat-pools",level:2},{value:"Static NAT bindings",id:"static-nat-bindings",level:3},{value:"Shared NAT pools",id:"shared-nat-pools",level:3},{value:"Tenant filtering",id:"tenant-filtering",level:3}],u={toc:c};function h(e){var t=e.components,s=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"source-nat"},"Source NAT"),(0,o.kt)("p",null,"Source NAT can be enabled on ",(0,o.kt)("inlineCode",{parentName:"p"},"authority > router > node > network-interface"),". When enabling ",(0,o.kt)("inlineCode",{parentName:"p"},"source-nat")," on a network-interface, all traffic egressing the interface will be network address and port translated (NAPT) to that of the address on the interface."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"The port range is not configurable and ranges between 16384 to 65534, allowing for 49,150 concurrent sessions per interface.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"admin@gouda.novigrad# show config running authority router novigrad node gouda device-interface wan network-interface wan-interface \n\nconfig\n\n    authority\n\n        router  novigrad\n            name  novigrad\n\n            node  gouda\n                name              gouda\n\n                device-interface  wan\n                    name               wan\n\n                    network-interface  wan-interface\n                        name                    wan-interface\n                        global-id               1\n                        vlan                    0\n                        type                    external\n                        conductor               false\n\n                        neighborhood            internet\n                            name  internet\n                        exit\n                        inter-router-security   interfabric\n                        prioritization-mode     local\n                        source-nat              true\n                        mtu                     1500\n                        enforced-mss            disabled\n                        icmp                    allow\n                        hostname                gouda.novigrad.net\n                        multicast-listeners     automatic\n                        multicast-report-proxy  false\n                        dhcp                    v4\n                    exit\n                exit\n            exit\n        exit\n    exit\nexit\n")),(0,o.kt)("p",null,"If support for more than 49,150 concurrent sessions per interface is needed, you can configure a ",(0,o.kt)("em",{parentName:"p"},"NAT Pool")," or add additional ",(0,o.kt)("inlineCode",{parentName:"p"},"address"),"es to the network-interface, expanding the source NAT capacity."),(0,o.kt)("p",null,"When multiple addresses are configured, utilizing ",(0,o.kt)("inlineCode",{parentName:"p"},"source-nat"),", the second address configured will only be utilized once the first is fully exhausted; so on and so forth.  Once the next configured address starts being utilized, it will remain in use until exhausted."),(0,o.kt)("h2",{id:"destination-nat"},"Destination NAT"),(0,o.kt)("p",null,"Static desination network address translation can be performed by configuring a ",(0,o.kt)("inlineCode",{parentName:"p"},"service-route > nat-target"),". It is common to leverage the public address of the router for internal services, such as VPN. Traffic destined to the SSR, configured as a ",(0,o.kt)("em",{parentName:"p"},"service")," with an ",(0,o.kt)("em",{parentName:"p"},"address")," that matches that of the public-facing network-interface is then NATed to an internal private address on the LAN for the application. This setting only performs address translation and does not modify the port."),(0,o.kt)("h2",{id:"static-nat"},"Static NAT"),(0,o.kt)("p",null,"SSR supports source NAT pool configurations at interface and service-route level as described in ",(0,o.kt)("a",{parentName:"p",href:"#static-nat-bindings"},"Static NAT Bindings"),". However, this is not always sufficient to enable simple configuration for static bidirectional NAT between two same-sized subnets."),(0,o.kt)("p",null,"Static NAT defines a one-to-one mapping from one IP subnet to another IP subnet. The mapping includes source IP address translation in one direction and destination IP address translation in the reverse direction. In cases where IP address overlapping is found, such as when merging networks (for example, a corporate acquisition and merger) this simple configuration change is significantly less work than changing all the local IP addresses. The diagram below illustrates this example. "),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Static Nat Diagram",src:n(77132).Z,width:"488",height:"948"})),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan2")," network-interface is not routable (cannot send or receive traffic) in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Corp")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Internet")," networks. The client in ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan2")," has a local IP within the ",(0,o.kt)("inlineCode",{parentName:"p"},"192.168.1.0/24")," subnet and overlaps with another client from ",(0,o.kt)("inlineCode",{parentName:"p"},"Corp")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan1"),". This will cause problems for any sessions between ",(0,o.kt)("inlineCode",{parentName:"p"},"hub-lan1")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan1")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan2"),". By configuring ",(0,o.kt)("inlineCode",{parentName:"p"},"bidirectional-nat")," on ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"spk-lan2"),", the two ",(0,o.kt)("inlineCode",{parentName:"p"},"192.168.1.0/24")," subnets are mapped to ",(0,o.kt)("inlineCode",{parentName:"p"},"172.16.128.0/24")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"172.16.129.0/24")," respectively and differentiate themselves on the hub router."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"bidirectional-nat")," provides value in two ways:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"NAT an unroutable private IP to a routable public IP"),(0,o.kt)("li",{parentName:"ul"},"NAT duplicate private IPs (on different routers/networks) to different public IPs to provide differentiation on the receiving end")),(0,o.kt)("h4",{id:"example"},"Example"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"config\n    authority\n        router      spoke\n            node       node1-spoke\n                device-interface    spk-lan2\n                    network-interface    spk-lan2\n                        bidirectional-nat    192.168.1.0/24\n                            local-ip         192.168.1.0/24\n                            remote-ip        172.16.128.0/24\n                        exit \n                    exit\n                exit\n                \n                device-interface    spk-lan1\n                    network-interface   spk-lan1\n                        bidirectional-nat    192.168.1.0/24\n                            local-ip         192.168.1.0/24\n                            remote-ip        172.16.129.0/24\n                        exit \n                    exit\n                exit\n            exit\n        exit\n    exit\nexit \n\n")),(0,o.kt)("h3",{id:"using-the-gui"},"Using the GUI"),(0,o.kt)("p",null,"Set the local and remote IP addresses under Authority > Router > Node > Device Interface > Network Interface."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Network Interface",src:n(95342).Z,width:"944",height:"230"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Bidirectional NAT Config",src:n(68414).Z,width:"942",height:"250"})),(0,o.kt)("h3",{id:"show-commands"},"Show Commands"),(0,o.kt)("p",null,"For details about command output, refer to the ",(0,o.kt)("a",{parentName:"p",href:"/docs/cli_reference#show-sessions"},(0,o.kt)("inlineCode",{parentName:"a"},"show sessions"))," and ",(0,o.kt)("a",{parentName:"p",href:"/docs/cli_reference#show-sessions-by-id"},(0,o.kt)("inlineCode",{parentName:"a"},"show sessions by-id"))," commands."),(0,o.kt)("h4",{id:"source-nat-1"},"Source NAT"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"On the session ingress node, the ",(0,o.kt)("inlineCode",{parentName:"li"},"show sessions by-id")," output has an Ingress Source NAT field where the source-nat type, NAT\u2019d source address, NAT\u2019d port, and protocol are displayed.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Session Ingress",src:n(20052).Z,width:"1642",height:"484"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"On the session egress node the ",(0,o.kt)("inlineCode",{parentName:"li"},"show sessions by-id")," output has an Ingress Source NAT field where the source-nat type, NAT\u2019d source address, NAT\u2019d port, and protocol are displayed. ")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Session Egress",src:n(25057).Z,width:"1602",height:"546"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"show sessions")," output has ",(0,o.kt)("inlineCode",{parentName:"li"},"NAT IP")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"NAT Port")," columns where the NAT\u2019d source address and NAT\u2019d source port are displayed. ")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"NAT IP and Port",src:n(92619).Z,width:"1284",height:"302"})),(0,o.kt)("h4",{id:"destination-nat-1"},"Destination NAT"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"On the session egress node the ",(0,o.kt)("inlineCode",{parentName:"li"},"show sessions by-id")," output shows the NAT\u2019d destination address in the Forward Flow ",(0,o.kt)("inlineCode",{parentName:"li"},"NextHop")," and Reverse Flow ",(0,o.kt)("inlineCode",{parentName:"li"},"src ip")," fields. ")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Destination forward flow",src:n(61040).Z,width:"1940",height:"726"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"show sessions")," output reverse flow ",(0,o.kt)("inlineCode",{parentName:"li"},"src ip "),"column also shows the NAT\u2019d destination address.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Destination Reverse Flow Source IP",src:n(2254).Z,width:"1290",height:"308"})),(0,o.kt)("h4",{id:"version-history"},"Version History"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Release"),(0,o.kt)("th",{parentName:"tr",align:null},"Modification"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"6.2.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Static NAT Feature Introduced")))),(0,o.kt)("h2",{id:"nat-pools"},"NAT Pools"),(0,o.kt)("p",null,"NAT pools are a construct that allow for the use of IP and port ranges to be shared across one or more network-interfaces for either source or destination NATing capabilies."),(0,o.kt)("h3",{id:"static-nat-bindings"},"Static NAT bindings"),(0,o.kt)("p",null,"A static NAT binding can be configured by creating an ",(0,o.kt)("inlineCode",{parentName:"p"},"authority > router > nat-pool")," object and assigning it to a network-interface.  The following rules and constraints will apply to this configuration:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("em",{parentName:"li"},"nat-pool")," prefix is used to create a N:M mapping. Where each source IP (from ingress interface) is hashed to an IP address in the nat pool."),(0,o.kt)("li",{parentName:"ul"},"The static ",(0,o.kt)("em",{parentName:"li"},"nat-pool")," can only be configured as:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},"ingress-nat-pool")," on a ",(0,o.kt)("em",{parentName:"li"},"network-interface")," when peering with another SSR"),(0,o.kt)("li",{parentName:"ul"},"egress-nat-pool on a ",(0,o.kt)("em",{parentName:"li"},"network-interface")," when not performing SVR"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},"source-nat-pool")," on a ",(0,o.kt)("em",{parentName:"li"},"service-route / next-hop")))),(0,o.kt)("li",{parentName:"ul"},"SSR software will not reply to ARP requests on the pool prefix on the associated interface.  Therefore the SSR relies on the pool to be routed to the SSR gateway interface by another mechanism (e.g. static-routes, BGP, etc.) by the ",(0,o.kt)("em",{parentName:"li"},"next-hop")," in the network."),(0,o.kt)("li",{parentName:"ul"},"Changes to the pool configuration will not affect the existing sessions as it has the potential of cascading effect on the network. These changes will resolve over time as the existing sessions naturally expire.")),(0,o.kt)("p",null,"The static NAT pool will simply hash the source IP address of incoming packets to the corresponding IP address in the pool."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"nat-pool\n    name static-pool-1\n    type static\n    address-pool\n        address 10.10.10.10/31\n\nnetwork-interface\n    name    test-lan\n    address\n        ip-address 192.168.10.1\n        prefix-length 24\n    ingress-source-nat-pool static-pool-1\n")),(0,o.kt)("p",null,"In the configuration snippet above, the ",(0,o.kt)("em",{parentName:"p"},"192.168.10.0/24")," network for the ",(0,o.kt)("inlineCode",{parentName:"p"},"test-lan")," will be source NAT\u2019d to ",(0,o.kt)("inlineCode",{parentName:"p"},"10.10.10.10/31"),". Traffic from an endpoint of source address 192.168.10.10 will be source NAT\u2019d to 10.10.10.10; 192.168.10.11 will be source NAT\u2019d to 10.10.10.11 and so on. Since the NAT in the model relies on a N:M mapping this can only be configured as an ",(0,o.kt)("em",{parentName:"p"},"ingress-source-nat-pool")," (on ",(0,o.kt)("em",{parentName:"p"},"network-interface"),") or as a destination-nat-pool (on ",(0,o.kt)("em",{parentName:"p"},"service-route / next-hop"),")."),(0,o.kt)("h3",{id:"shared-nat-pools"},"Shared NAT pools"),(0,o.kt)("p",null,"In some scenarios, it is desirable to share the same NAT pool across services and interfaces. This feature accommodates the same NAT pool to be configured on different interfaces. There are some considerations that should be noted for failure and recovery."),(0,o.kt)("u",null,"Flow Move Considerations"),(0,o.kt)("p",null,"Currently session migration is only supported for SVR sessions. This restriction exists because session migration of a non-SVR session is not guaranteed to terminate on the same server. As a result, the remote server might receive mid flow packets from a different source, resulting in undefined behavior."),(0,o.kt)("u",null,"Session Recovery Considerations"),(0,o.kt)("p",null,"For shared NAT pools provisioned on an HA interface that encounters a failover, the SSR software will put the interface into recovery mode to recover all sessions. At the end of the recovery period all non-discovered ports designed as free are returned to the NAT pool."),(0,o.kt)("h3",{id:"tenant-filtering"},"Tenant filtering"),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},"nat-pool")," configuration can optionally be provisioned with a list of tenants. When the configuration has ",(0,o.kt)("em",{parentName:"p"},"multiple")," IP pools available, the ",(0,o.kt)("em",{parentName:"p"},"tenant")," can be used to determine which IP pool will be selected for the source NAT. Absence of a tenant implies that the IP pool is valid for all traffic. The following rules will be applied in order to determine the selection of the NAT pool:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The packet has a source tenant associated with it",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If more than one IP pool has a matching tenant, only the first IP pool is used and the hash is applied to create a session. The remainder of the matches are discarded"),(0,o.kt)("li",{parentName:"ul"},"If a pool with no tenant is configured",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Same as above"))),(0,o.kt)("li",{parentName:"ul"},"All IP pools have tenant configured but none of them match the source tenant",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Log the failure, increment stat and drop the packet"))))),(0,o.kt)("li",{parentName:"ul"},"The packet has no source tenant associated with it",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"At least one IP pool has no tenant configured to do the source NAT otherwise this will result in the session being dropped")))),(0,o.kt)("p",null,"The tenant matching rules will apply to sub-tenants as well. For example, if an IP pool allows tenant engineering, then traffic with source tenant lab.engineering will also match the pool."))}h.isMDXComponent=!0},61040:function(e,t,n){t.Z=n.p+"assets/images/dest-nat1-164a3dad3c58b299aae2cd7fc7c0b3f2.png"},2254:function(e,t,n){t.Z=n.p+"assets/images/dest-nat2-16fc36a4fdfcf8b924bb42df74b0c7e9.png"},20052:function(e,t,n){t.Z=n.p+"assets/images/source-nat1-49193d54a10ca5d36f982863be15715b.png"},25057:function(e,t,n){t.Z=n.p+"assets/images/source-nat2-cb12fc356f5609cef7db9b2c584ddbb8.png"},92619:function(e,t,n){t.Z=n.p+"assets/images/source-nat3-2eae8ac297dce5b61bff6ec37de7ebdb.png"},77132:function(e,t,n){t.Z=n.p+"assets/images/static_nat_example-29a76f18237ff4aaafc180c1ca333294.png"},68414:function(e,t,n){t.Z=n.p+"assets/images/static_nat_gui_nat-config-20fa526292c727c7ca77445a1969e57d.png"},95342:function(e,t,n){t.Z=n.p+"assets/images/static_nat_gui_net-intf-1138f11e436b3bb0872570b8172b945e.png"}}]);