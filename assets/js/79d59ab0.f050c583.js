"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[8238],{15419:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var s=t(74848),r=t(28453);const o={title:"How the FIB is Constructed",sidebar_label:"How the FIB is Constructed"},i=void 0,c={id:"concepts_fib_construction",title:"How the FIB is Constructed",description:"The FIB is constructed using a combination of user configured services, with routes from the RIB (connected, static, kernel, and routing protocols OSPF and BGP). Each address configured in a service creates at least one FIB entry per access-policy (unique tenant) in that service. A simple service with two addresses and an access-policy for two tenants will result in four FIB entries, as shown below.",source:"@site/docs/concepts_fib_construction.md",sourceDirName:".",slug:"/concepts_fib_construction",permalink:"/docs/concepts_fib_construction",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"How the FIB is Constructed",sidebar_label:"How the FIB is Constructed"},sidebar:"docs",previous:{title:"FIB Concepts",permalink:"/docs/concepts_fib"},next:{title:"FIB Design Considerations",permalink:"/docs/concepts_fib_design"}},a={},d=[{value:"How Transports on Services Affect the FIB",id:"how-transports-on-services-affect-the-fib",level:3},{value:"FIB Next-Hops",id:"fib-next-hops",level:3}];function l(e){const n={a:"a",code:"code",em:"em",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"The FIB is constructed using a combination of user configured services, with routes from the RIB (connected, static, kernel, and routing protocols OSPF and BGP). Each address configured in a service creates at least one FIB entry per access-policy (unique tenant) in that service. A simple service with two addresses and an access-policy for two tenants will result in four FIB entries, as shown below."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        service  s0\n            name           s0\n            address        10.0.0.0/8\n            address        172.16.0.0/16\n\n            access-policy  t0\n                source  t0\n            exit\n\n            access-policy  t1\n                source  t1\n            exit\n        exit\n\nFIB:\n================ ====== ======= ======== ===== ========= =========== ======== ======\n IP Prefix        Port   Proto   Tenant   VRF   Service   Next Hops   Vector   Cost\n================ ====== ======= ======== ===== ========= =========== ======== ======\n 10.0.0.0/8          0   None    t0       -     s0        None        -        -\n                                 t1       -     s0        None        -        -\n 172.16.0.0/16       0   None    t0       -     s0        None        -        -\n                                 t1       -     s0        None        -        -\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each transport configured on the service will result in at least one FIB entry per address, per tenant configured as an access-policy. If there are port ranges configured along with any transports, each port range will result in unique entries. Shown below is a more complicated configuration example and the resulting FIB entries."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"service  s6\n            name           s6\n\n            transport      udp\n                protocol    udp\n\n                port-range  1000\n                    start-port  1000\n                    end-port    2000\n                exit\n\n                port-range  3000\n                    start-port  3000\n                    end-port    4000\n                exit\n            exit\n\n            transport      tcp\n                protocol  tcp\n            exit\n            address        10.1.1.0/24\n            address        10.1.2.0/24\n\n            access-policy  t0\n                source  t0\n            exit\n\n            access-policy  t1\n                source  t1\n            exit\n\n            access-policy  t2\n                source  t2\n            exit\n        exit\n\nFIB:\n============= =========== ======= ======== ===== ========= =========== ======== ======\n IP Prefix          Port   Proto   Tenant   VRF   Service   Next Hops   Vector   Cost\n============= =========== ======= ======== ===== ========= =========== ======== ======\n 10.1.1.0/24           0   TCP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n               1000-2000   UDP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n               3000-4000   UDP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n 10.1.2.0/24           0   TCP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n               1000-2000   UDP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n               3000-4000   UDP     t0       -     s6        None        -        -\n                                   t1       -     s6        None        -        -\n                                   t2       -     s6        None        -        -\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"The above examples do not take the RIB into account. A change in the configuration or a change in the RIB will cause the policy to be reapplied."}),"\n",(0,s.jsxs)(n.p,{children:["Each selected route in the RIB produces a route update that ",(0,s.jsx)(n.em,{children:"may"})," influence the FIB. The route update is compared to all addresses for configured services. If a route update is more specific than a service address, this will result in multiple FIB entries for the service. An example of this is shown below. The service is configured with address 10.0.0.0/8, which automatically receives an entry. There is also a more specific BGP route in the RIB for 10.1.1.0/24. This results in a FIB entry for the configured service address (10.0.0.0/8), and a FIB entry for the more specific RIB route (10.1.1.0/24)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        service            s0\n            name           s0\n            address        10.0.0.0/8\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\nRIB:\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n Vrf       Prefix               Protocol    Selected   Distance   Metric   Uptime   Ip            Interface name   Directly connected   Fib\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n default   10.1.1.0/24          bgp         true             20        0       19   192.168.1.2   g1               unavailable          true\n           169.254.127.126/31   connected   true              0        0    10323   unavailable   g4294967294      true                 true\n           192.168.1.0/30       connected   true              0        0    10334   unavailable   g1               true                 true\n\nFIB:\n============= ====== ======= ======== ===== ========= ============= ======== ======\n IP Prefix     Port   Proto   Tenant   VRF   Service   Next Hops     Vector   Cost\n============= ====== ======= ======== ===== ========= ============= ======== ======\n 10.0.0.0/8       0   None    t0       -     s0        None          -        -\n 10.1.1.0/24      0   None    t0       -     s0        192.168.1.2   -        0\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"This behavior potentially results in FIB conflicts. In these cases, the more specific service address by LPM is used for the FIB entry."}),"\n",(0,s.jsx)(n.p,{children:"In the example below, the route update for 10.1.0.0/20 matches both service addresses 10.0.0.0/8 and 10.1.0.0/16. This potentially creates an entry for 10.1.0.0/20 for services s0 and s1 for tenant t0, which would be conflicting. Therefore, the service address with the LPM wins the conflict, and the entry for service s1 is created."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        service            s0\n            name           s0\n            address        10.0.0.0/8\n\n            access-policy  t0\n                source  t0\n            exit\n\n            access-policy  t1\n                source  t1\n            exit\n        exit\n\n        service            s1\n            name           s1\n            address        10.1.0.0/16\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\nRIB:\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n Vrf       Prefix               Protocol    Selected   Distance   Metric   Uptime   Ip            Interface name   Directly connected   Fib\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n default   10.1.0.0/20          bgp         true             20        0       13   192.168.1.2   g1               unavailable          true\n           169.254.127.126/31   connected   true              0        0    10323   unavailable   g4294967294      true                 true\n           192.168.1.0/30       connected   true              0        0    10334   unavailable   g1               true                 true\n\nFIB:\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n IP Prefix                 Port   Proto   Tenant     VRF   Service                   Next Hops     Vector   Cost\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n 10.0.0.0/8                   0   None    t0         -     s0                        None          -        -\n                                          t1         -     s0                        None          -        -\n 10.1.0.0/16                  0   None    t0         -     s1                        None          -        -\n 10.1.0.0/20                  0   None    t1         -     s0                        192.168.1.2   -        0\n                                  None    t0         -     s1                        192.168.1.2   -        0\n\n"})}),"\n",(0,s.jsx)(n.h3,{id:"how-transports-on-services-affect-the-fib",children:"How Transports on Services Affect the FIB"}),"\n",(0,s.jsx)(n.p,{children:"If transports are configured on services, route updates may add complexity to the above scenarios. To avoid colliding FIB entries, transport and port range configuration must be compared among services that share a prefix. The default behavior for this process continues from the procedure above. The prefix from the route update is used to find the most specific prefix configured in a service address. This address may be configured on multiple services that share the same tenant but have different transport and port range configurations. Only services that share this address will be considered for transport overlap. In case there is transport overlap between services, the service names will be used, and the first name lexicographically will be the service that gets the FIB entries. The way transport overlap scenarios are handled can have implications that may seem unintuitive. Take the example shown below:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        service  s0\n            name           s0\n            address        10.0.0.0/8\n\n            access-policy  t0\n                source  t0\n            exit\n\n            access-policy  t1\n                source  t1\n            exit\n        exit\n\n        service  s1\n            name           s1\n\n            transport      icmp\n                protocol  icmp\n            exit\n\n            transport      tcp\n                protocol  tcp\n            exit\n\n            transport      udp\n                protocol  udp\n            exit\n            address        10.1.0.0/16\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\n        service  s6\n            name           s6\n\n            transport      udp\n                protocol    udp\n\n                port-range  1000\n                    start-port  1000\n                    end-port    2000\n                exit\n\n                port-range  3000\n                    start-port  3000\n                    end-port    4000\n                exit\n            exit\n            address        10.1.1.0/24\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\nRIB:\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n Vrf       Prefix               Protocol    Selected   Distance   Metric   Uptime   Ip            Interface name   Directly connected   Fib\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n default   10.1.1.0/24          bgp         true             20        0       28   192.168.1.2   g1               unavailable          true\n           169.254.127.126/31   connected   true              0        0    10323   unavailable   g4294967294      true                 true\n           192.168.1.0/30       connected   true              0        0    10334   unavailable   g1               true                 true\n\nFIB:\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n IP Prefix                 Port   Proto   Tenant     VRF   Service                   Next Hops     Vector   Cost\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n 10.0.0.0/8                   0   None    t0         -     s0                        None          -        -\n                                          t1         -     s0                        None          -        -\n 10.1.0.0/16                  0   ICMP    t0         -     s1                        None          -        -\n                                  TCP     t0         -     s1                        None          -        -\n                                  UDP     t0         -     s1                        None          -        -\n 10.1.1.0/24                  0   None    t1         -     s0                        192.168.1.2   -        0\n                      1000-2000   UDP     t0         -     s6                        192.168.1.2   -        0\n                      3000-4000   UDP     t0         -     s6                        192.168.1.2   -        0\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this scenario, the route update for 10.1.1.0/24 finds the best match for a service address for tenant ",(0,s.jsx)(n.code,{children:"t0"}),", which is 10.1.1.0/24. This is configured in service ",(0,s.jsx)(n.code,{children:"s0"})," and therefore only service ",(0,s.jsx)(n.code,{children:"s0"})," is considered for transport overlap. Service ",(0,s.jsx)(n.code,{children:"s1"})," is not considered. If a packet classified as source tenant ",(0,s.jsx)(n.code,{children:"t0"})," comes into the router destined for 10.1.1.10 TCP/443, it will match the FIB entry for 10.1.0.0/16 TCP/0 for service ",(0,s.jsx)(n.code,{children:"s1"}),", which has no next-hop. A session will not be installed in the session table, and no traffic will be forwarded. A network operator may think this traffic should reach its destination based on the intent of this configuration."]}),"\n",(0,s.jsxs)(n.p,{children:["Due to the confusion of the above scenario, the configuration parameter ",(0,s.jsx)(n.a,{href:"/docs/config_command_guide#configure-authority-fib-service-match",children:(0,s.jsx)(n.code,{children:"fib-service-match"})}),"has been added. The default value for this parameter, ",(0,s.jsx)(n.code,{children:"best-match-only"}),", preserves the default functionality. Changing this to ",(0,s.jsx)(n.code,{children:"any-match"})," will enhance the functionality. When ",(0,s.jsx)(n.code,{children:"any-match"})," is configured, a route update visits other, less-specific service addresses. These addresses will be considered for transport overlap in the same manner as the best match is in the default behavior. Configuring ",(0,s.jsx)(n.code,{children:"fib-service-match any-match"}),"  changes the way the FIB is built from the above example to what is shown below."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"==================== =========== ======= ========== ===== ========================= ============= ======== ======\n IP Prefix                 Port   Proto   Tenant     VRF   Service                   Next Hops     Vector   Cost\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n 10.0.0.0/8                   0   None    t0         -     s0                        None          -        -\n                                          t1         -     s0                        None          -        -\n 10.1.0.0/16                  0   ICMP    t0         -     s1                        None          -        -\n                                  TCP     t0         -     s1                        None          -        -\n                                  UDP     t0         -     s1                        None          -        -\n 10.1.1.0/24                  0   None    t0         -     s0                        192.168.1.2   -        0\n                                          t1         -     s0                        192.168.1.2   -        0\n                                  ICMP    t0         -     s1                        192.168.1.2   -        0\n                                  TCP     t0         -     s1                        192.168.1.2   -        0\n                                  UDP     t0         -     s1                        192.168.1.2   -        0\n                      1000-2000   UDP     t0         -     s6                        192.168.1.2   -        0\n                      3000-4000   UDP     t0         -     s6                        192.168.1.2   -        0\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this case, if a packet classified as source tenant ",(0,s.jsx)(n.code,{children:"t0"})," comes into the router destined for 10.1.1.10 TCP/443, it will match the FIB entry for 10.1.1.0/24 TCP/0 for service ",(0,s.jsx)(n.code,{children:"s1"}),". This entry has a next-hop from the route update and therefore a session will be installed and traffic forwarded to next-hop 192.168.1.2."]}),"\n",(0,s.jsxs)(n.p,{children:["Be aware, though, that even with this behavior, when there is any transport conflict between two services for entries of a particular prefix, the service declared as the winner (alphabetically) will create FIB entries for all of its transports and the losing service or services will create ",(0,s.jsx)(n.strong,{children:"no"})," FIB entries for this prefix. This is illustrated below:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        service            s0\n            name           s0\n            address        10.0.0.0/8\n\n            access-policy  t0\n                source  t0\n            exit\n\n            access-policy  t1\n                source  t1\n            exit\n        exit\n\n        service            s1\n            name           s1\n            enabled        true\n\n            transport      icmp\n                protocol  icmp\n            exit\n\n            transport      tcp\n                protocol  tcp\n            exit\n\n            transport      udp\n                protocol  udp\n            exit\n            address        10.1.0.0/16\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\n        service            s6\n            name           s6\n\n            transport      udp\n                protocol    udp\n\n                port-range  1000\n                    start-port  1000\n                    end-port    2000\n                exit\n\n                port-range  3000\n                    start-port  3000\n                    end-port    4000\n                exit\n            exit\n            address        10.1.1.0/24\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n\n        service            s7\n            name           s7\n\n            transport      udp\n                protocol    udp\n\n                port-range  3500\n                    start-port  3500\n                    end-port    4500\n                exit\n            exit\n\n            transport      tcp\n                protocol    tcp\n\n                port-range  1000\n                    start-port  1000\n                    end-port    2000\n                exit\n            exit\n            address        10.1.0.0/16\n\n            access-policy  t0\n                source  t0\n            exit\n        exit\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"RIB:\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n Vrf       Prefix               Protocol    Selected   Distance   Metric   Uptime   Ip            Interface name   Directly connected   Fib\n========= ==================== =========== ========== ========== ======== ======== ============= ================ ==================== ======\n default   10.1.1.0/24          bgp         true             20        0      440   192.168.1.2   g1               unavailable          true\n           169.254.127.126/31   connected   true              0        0    10323   unavailable   g4294967294      true                 true\n           192.168.1.0/30       connected   true              0        0    10334   unavailable   g1               true                 true\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"FIB:\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n IP Prefix                 Port   Proto   Tenant     VRF   Service                   Next Hops     Vector   Cost\n==================== =========== ======= ========== ===== ========================= ============= ======== ======\n 10.0.0.0/8                   0   None    t0         -     s0                        None          -        -\n                                          t1         -     s0                        None          -        -\n 10.1.0.0/16                  0   ICMP    t0         -     s1                        None          -        -\n                                  TCP     t0         -     s1                        None          -        -\n                                  UDP     t0         -     s1                        None          -        -\n                      1000-2000   TCP     t0         -     s7                        None          -        -\n                      3500-4500   UDP     t0         -     s7                        None          -        -\n 10.1.1.0/24                  0   None    t0         -     s0                        192.168.1.2   -        0\n                                          t1         -     s0                        192.168.1.2   -        0\n                                  ICMP    t0         -     s1                        192.168.1.2   -        0\n                                  TCP     t0         -     s1                        192.168.1.2   -        0\n                                  UDP     t0         -     s1                        192.168.1.2   -        0\n                      1000-2000   UDP     t0         -     s6                        192.168.1.2   -        0\n                      3000-4000   UDP     t0         -     s6                        192.168.1.2   -        0\n                           5000   UDP     t0         -     s8                        192.168.1.2   -        0\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this example, service ",(0,s.jsx)(n.code,{children:"s7"})," has a port-range overlap with service ",(0,s.jsx)(n.code,{children:"s6"})," because both contain entries for UDP ports 3500-4000. When the route update for 10.1.1.0/24 is applied, this address range is valid for both services. Due to this conflict, they cannot both create FIB entries for prefix 10.1.1.0/24. Even though there is no overlap for service ",(0,s.jsx)(n.code,{children:"s7"}),"\u2019s TCP port range configuration, this entry is not installed for address 10.1.1.0/24. In this case, service ",(0,s.jsx)(n.code,{children:"s6"})," has a more specific LPM for the route update address, so those entries are created first. When the behavior of ",(0,s.jsx)(n.code,{children:"fib-service-match any-match"})," continues to look for less specific service addresses that match the route update and finds service ",(0,s.jsx)(n.code,{children:"s7"}),", it is unable to create those entries due to the conflict with existing entries from service ",(0,s.jsx)(n.code,{children:"s6"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"fib-next-hops",children:"FIB Next-Hops"}),"\n",(0,s.jsxs)(n.p,{children:["The default behavior when creating FIB entries is to use the next-hop from the RIB obtained from the route update. This could be a connected interface, a next-hop address for a standard L3 hop, or the routing interface address of another SSR as learned from ",(0,s.jsx)(n.a,{href:"/docs/concepts_fib_design#bgp-over-svr",children:"BGP over SVR"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>c});var s=t(96540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);