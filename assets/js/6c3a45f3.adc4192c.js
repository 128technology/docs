"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[8846],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=l(n),h=a,m=d["".concat(c,".").concat(h)]||d[h]||u[h]||o;return n?r.createElement(m,i(i({ref:t},p),{},{components:n})):r.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},74324:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return c},default:function(){return h},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return u}});var r=n(87462),a=n(63366),o=(n(67294),n(3905)),i=["components"],s={title:"Using SSR as an NTP Server",sidebar_label:"Branch NTP Service"},c=void 0,l={unversionedId:"bcp_using_128T_as_ntp_server",id:"bcp_using_128T_as_ntp_server",title:"Using SSR as an NTP Server",description:"In many hub-and-spoke deployments, devices at the spoke locations are accustomed to using either public services (such as time.nist.gov or pool.ntp.org) or self-hosted NTP services as their clock source. Rather than carry this traffic on the WAN, this document demonstrates how an SSR can provide NTP services for devices at the branch, avoiding unnecessary WAN traffic, and ensuring that all branch devices use a consistent clock source.",source:"@site/docs/bcp_using_128T_as_ntp_server.md",sourceDirName:".",slug:"/bcp_using_128T_as_ntp_server",permalink:"/docs/bcp_using_128T_as_ntp_server",draft:!1,tags:[],version:"current",lastUpdatedAt:1693508171,formattedLastUpdatedAt:"Aug 31, 2023",frontMatter:{title:"Using SSR as an NTP Server",sidebar_label:"Branch NTP Service"},sidebar:"docs",previous:{title:"AT&T AVPN Configuration",permalink:"/docs/bcp_att_avpn_configuration"},next:{title:"DHCP Relay Best Practices",permalink:"/docs/bcp_dhcp_relay_overview"}},p={},u=[{value:"Overview",id:"overview",level:2},{value:"Configuring Devices to use the SSR as an NTP Server",id:"configuring-devices-to-use-the-ssr-as-an-ntp-server",level:3},{value:"Capturing all Inbound NTP",id:"capturing-all-inbound-ntp",level:3},{value:"Conclusion",id:"conclusion",level:2}],d={toc:u};function h(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In many hub-and-spoke deployments, devices at the spoke locations are accustomed to using either public services (such as ",(0,o.kt)("inlineCode",{parentName:"p"},"time.nist.gov")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"pool.ntp.org"),") or self-hosted NTP services as their clock source. Rather than carry this traffic on the WAN, this document demonstrates how an SSR can provide NTP services for devices at the branch, avoiding unnecessary WAN traffic, and ensuring that all branch devices use a consistent clock source."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"All of the recommendations in this document presume that the administrator has already set up the SSR to clock off of an upstream source.")),(0,o.kt)("h2",{id:"overview"},"Overview"),(0,o.kt)("p",null,"There are two, somewhat complementary approaches to using a branch SSR as an NTP server:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Issuing the SSR's address as the NTP server in DHCP repsonses and/or configuring devices to use the SSR's LAN interface as an NTP server"),(0,o.kt)("li",{parentName:"ul"},"Capturing all inbound NTP (using a service that captures 123/UDP), and handling that traffic locally")),(0,o.kt)("h3",{id:"configuring-devices-to-use-the-ssr-as-an-ntp-server"},"Configuring Devices to use the SSR as an NTP Server"),(0,o.kt)("p",null,"This is straightforward configuration for both the end devices as well as for the SSR itself. In the example below, we will assume that the SSR's LAN IP address is ",(0,o.kt)("inlineCode",{parentName:"p"},"192.168.1.1"),". Consider the following configuration excerpt:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-config",metastring:"{19,24-29}","{19,24-29}":!0},'node  node1\n    name              node1\n    device-interface  lan\n        name               lan\n        network-interface  lan0\n            name                   lan0\n            description            "Branch LAN"\n            address                192.168.1.1\n                ip-address     192.168.1.1\n                prefix-length  24\n                host-service   dhcp-server\n                    service-type  dhcp-server\n                    address-pool  192.168.1.100\n                        start-address      192.168.1.100\n                        end-address        192.168.1.199\n                        router             192.168.1.1\n                        domain-server      1.1.1.1\n                        domain-server      1.0.0.1\n                        ntp-server         192.168.1.1\n                    exit\n                exit\n                host-service   custom\n                    service-type   custom\n                    transport      udp\n                        protocol    udp\n                        port-range  123\n                            start-port  123\n                        exit\n                    exit\n                    access-policy  trusted\n                        source  trusted\n                    exit\n                    access-policy  guest\n                        source  guest\n                    exit\n                    access-policy  corporate\n                        source  corporate\n                    exit\n                exit\n            exit\n        exit\n    exit\nexit\n')),(0,o.kt)("p",null,"There are two principle components to this configuration excerpt, with respect to NTP treatment: the ",(0,o.kt)("inlineCode",{parentName:"p"},"host-service")," specifying NTP (using 123/UDP), and the ",(0,o.kt)("inlineCode",{parentName:"p"},"ntp-server")," configuration within the ",(0,o.kt)("inlineCode",{parentName:"p"},"address-pool"),"."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"ntp-server")," configuration will offer the SSR's LAN interface (192.168.1.1) as the NTP server to use when issuing DHCP leases."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Any devices that have static IP assignments will need to have the NTP server configured accordingly.")),(0,o.kt)("p",null,"The custom ",(0,o.kt)("inlineCode",{parentName:"p"},"host-service")," configuration shown here will direct any traffic sent to 192.168.1.1:123/UDP to the Linux host subsystem on the SSR device, where the ",(0,o.kt)("inlineCode",{parentName:"p"},"ntpd")," running on the host platform will reply. As seen in the configuration example above, it is important to ensure that every ",(0,o.kt)("inlineCode",{parentName:"p"},"tenant")," population that can access that LAN interface is allowed access to the ",(0,o.kt)("inlineCode",{parentName:"p"},"host-service")," through the use of an ",(0,o.kt)("inlineCode",{parentName:"p"},"access-policy")," statement. (In our example, we have three tenants on the LAN: ",(0,o.kt)("em",{parentName:"p"},"trusted"),", ",(0,o.kt)("em",{parentName:"p"},"guest"),", and ",(0,o.kt)("em",{parentName:"p"},"corporate"),")."),(0,o.kt)("h3",{id:"capturing-all-inbound-ntp"},"Capturing all Inbound NTP"),(0,o.kt)("p",null,"An alternative/complementary approach to assigning the SSR's LAN interface is to \"catch\" all inbound traffic for 123/UDP and forcibly redirect it to the SSR's NTP process. This is necessary in many occasions when the NTP server for a given client platform on the LAN is hardcoded, as is the case for many small embedded platforms and Internet of Things (IoT) devices."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This configuration will catch ",(0,o.kt)("em",{parentName:"p"},"all"),' inbound NTP. If you have devices at the branch that require precision timekeeping from external sources, adjust your service definitions and/or your tenant definitions accordingly to ensure the traffic does not match the "catch-all" service.')),(0,o.kt)("p",null,"The configuration will match all traffic arriving based solely on its port and protocol, and send it to the SSR's Linux subsystem. Here is a relevant configuration excerpt:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'admin@labsystem1.fiedler# show config running authority service ntp-iot\nconfig\n    authority\n        service  inbound-ntp\n            name                  inbound-ntp\n            applies-to           router-group\n                type        router-group\n                group-name  branches\n            exit\n            description           "Local NTP"\n            scope                 private\n            transport             udp\n                protocol    udp\n                port-range  123\n                    start-port  123\n                    end-port    123\n                exit\n            exit\n            address               0.0.0.0/0\n            access-policy         trusted\n                source      trusted\n            exit\n            access-policy         guest\n                source      guest\n            exit\n            access-policy         corporate\n                source      corporate\n            exit\n            share-service-routes  false\n        exit\n    exit\nexit\n')),(0,o.kt)("p",null,"This configuration will match any destination IP address (",(0,o.kt)("inlineCode",{parentName:"p"},"0.0.0.0/0"),") for NTP (123/UDP). As in the previous example, we've added ",(0,o.kt)("inlineCode",{parentName:"p"},"access-policy")," statements for the three tenants that we see on the LAN segments at our branch locations. Likewise, we've added a ",(0,o.kt)("inlineCode",{parentName:"p"},"applies-to")," configuration block, to ensure that this service is only pushed down to the routers we've tagged as belonging to the ",(0,o.kt)("inlineCode",{parentName:"p"},"branches")," group."),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"Do not also add the ",(0,o.kt)("inlineCode",{parentName:"p"},"_internal_")," tenant to the ",(0,o.kt)("inlineCode",{parentName:"p"},"access-policy")," list, as this is (typically) the tenant that the SSR will use when sending traffic outbound to external NTP servers. We want to ensure the SSR \u2013 and only the SSR \u2013 clocks off of an external source.")),(0,o.kt)("p",null,"On each router, we'll configure a ",(0,o.kt)("inlineCode",{parentName:"p"},"service-route")," that looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"admin@labsystem1.fiedler# show config runn authority router branch1 service-route rte_inbound-ntp\n\nconfig\n    authority\n        router  branch1\n            name           branch1\n            service-route  rte_inbound-ntp\n                name          rte_inbound-ntp\n                service-name  inbound-ntp\n                nat-target    169.254.127.127\n            exit\n        exit\n    exit\nexit\n")),(0,o.kt)("p",null,"This ",(0,o.kt)("inlineCode",{parentName:"p"},"service-route")," leverages ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts_linux_host_networking"},"Linux host networking")," to send packets to ",(0,o.kt)("inlineCode",{parentName:"p"},"ntpd")," using the ",(0,o.kt)("inlineCode",{parentName:"p"},"kni254")," interface present on all SSR devices."),(0,o.kt)("h2",{id:"conclusion"},"Conclusion"),(0,o.kt)("p",null,"Avoiding unnecessary WAN traffic is always a welcome change, Using the SSR to provide NTP clock to devices at the branch ensures a consistent time source for a collection of devices that are logically grouped already."))}h.isMDXComponent=!0}}]);