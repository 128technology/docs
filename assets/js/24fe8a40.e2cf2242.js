"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[4024],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return f}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),f=o,h=u["".concat(l,".").concat(f)]||u[f]||d[f]||r;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function f(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},70846:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return d}});var a=n(87462),o=n(63366),r=(n(67294),n(3905)),i=["components"],s={title:"Network Address Translation (NAT)",sidebar_label:"NAT"},l=void 0,c={unversionedId:"config_nat",id:"config_nat",title:"Network Address Translation (NAT)",description:"Source NAT",source:"@site/docs/config_nat.md",sourceDirName:".",slug:"/config_nat",permalink:"/docs/config_nat",draft:!1,tags:[],version:"current",lastUpdatedAt:1690826972,formattedLastUpdatedAt:"Jul 31, 2023",frontMatter:{title:"Network Address Translation (NAT)",sidebar_label:"NAT"},sidebar:"docs",previous:{title:"In-Memory Metrics",permalink:"/docs/config_in-memory_metrics"},next:{title:"Rate Limiting",permalink:"/docs/config_rate_limiting"}},p={},d=[{value:"Source NAT",id:"source-nat",level:2},{value:"Destination NAT",id:"destination-nat",level:2},{value:"NAT Pools",id:"nat-pools",level:2},{value:"Static NAT bindings",id:"static-nat-bindings",level:3},{value:"Shared NAT pools",id:"shared-nat-pools",level:3},{value:"Tenant filtering",id:"tenant-filtering",level:3}],u={toc:d};function f(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"source-nat"},"Source NAT"),(0,r.kt)("p",null,"Source NAT can be enabled on ",(0,r.kt)("inlineCode",{parentName:"p"},"authority > router > node > network-interface"),". When enabling ",(0,r.kt)("inlineCode",{parentName:"p"},"source-nat")," on a network-interface, all traffic egressing the interface will be network address and port translated (NAPT) to that of the address on the interface."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The port range is not configurable and ranges between 16384 to 65534, allowing for 49,150 concurrent sessions per interface.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"admin@gouda.novigrad# show config running authority router novigrad node gouda device-interface wan network-interface wan-interface \n\nconfig\n\n    authority\n\n        router  novigrad\n            name  novigrad\n\n            node  gouda\n                name              gouda\n\n                device-interface  wan\n                    name               wan\n\n                    network-interface  wan-interface\n                        name                    wan-interface\n                        global-id               1\n                        vlan                    0\n                        type                    external\n                        conductor               false\n\n                        neighborhood            internet\n                            name  internet\n                        exit\n                        inter-router-security   interfabric\n                        prioritization-mode     local\n                        source-nat              true\n                        mtu                     1500\n                        enforced-mss            disabled\n                        icmp                    allow\n                        hostname                gouda.novigrad.net\n                        multicast-listeners     automatic\n                        multicast-report-proxy  false\n                        dhcp                    v4\n                    exit\n                exit\n            exit\n        exit\n    exit\nexit\n")),(0,r.kt)("p",null,"If support for more than 49,150 concurrent sessions per interface is needed, you can configure a ",(0,r.kt)("em",{parentName:"p"},"NAT Pool")," or add additional ",(0,r.kt)("inlineCode",{parentName:"p"},"address"),"es to the network-interface, expanding the source NAT capacity."),(0,r.kt)("p",null,"When multiple addresses are configured, utilizing ",(0,r.kt)("inlineCode",{parentName:"p"},"source-nat"),", the second address configured will only be utilized once the first is fully exhausted; so on and so forth.  Once the next configured address starts being utilized, it will remain in use until exhausted."),(0,r.kt)("h2",{id:"destination-nat"},"Destination NAT"),(0,r.kt)("p",null,"Static desination network address translation can be performed by configuring a ",(0,r.kt)("inlineCode",{parentName:"p"},"service-route > nat-target"),". It is common to leverage the public address of the router for internal services, such as VPN. Traffic destined to the SSR, configured as a ",(0,r.kt)("em",{parentName:"p"},"service")," with an ",(0,r.kt)("em",{parentName:"p"},"address")," that matches that of the public-facing network-interface is then NATed to an internal private address on the LAN for the application. This setting only performs address translation and does not modify the port."),(0,r.kt)("h2",{id:"nat-pools"},"NAT Pools"),(0,r.kt)("p",null,"NAT pools are a construct that allow for the use of IP and port ranges to be shared across one or more network-interfaces for either source or destination NATing capabilies."),(0,r.kt)("h3",{id:"static-nat-bindings"},"Static NAT bindings"),(0,r.kt)("p",null,"A static NAT binding can be configured by creating an ",(0,r.kt)("inlineCode",{parentName:"p"},"authority > router > nat-pool")," object and assigning it to a network-interface.  The following rules and constraints will apply to this configuration:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("em",{parentName:"li"},"nat-pool")," prefix is used to create a N:M mapping. Where each source IP (from ingress interface) is hashed to an IP address in the nat pool."),(0,r.kt)("li",{parentName:"ul"},"The static ",(0,r.kt)("em",{parentName:"li"},"nat-pool")," can only be configured as:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"ingress-nat-pool")," on a ",(0,r.kt)("em",{parentName:"li"},"network-interface")," when peering with another SSR"),(0,r.kt)("li",{parentName:"ul"},"egress-nat-pool on a ",(0,r.kt)("em",{parentName:"li"},"network-interface")," when not performing SVR"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"source-nat-pool")," on a ",(0,r.kt)("em",{parentName:"li"},"service-route / next-hop")))),(0,r.kt)("li",{parentName:"ul"},"SSR software will not reply to ARP requests on the pool prefix on the associated interface.  Therefore the SSR relies on the pool to be routed to the SSR gateway interface by another mechanism (e.g. static-routes, BGP, etc.) by the ",(0,r.kt)("em",{parentName:"li"},"next-hop")," in the network."),(0,r.kt)("li",{parentName:"ul"},"Changes to the pool configuration will not affect the existing sessions as it has the potential of cascading effect on the network. These changes will resolve over time as the existing sessions naturally expire.")),(0,r.kt)("p",null,"The static NAT pool will simply hash the source IP address of incoming packets to the corresponding IP address in the pool."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"nat-pool\n    name static-pool-1\n    type static\n    address-pool\n        address 10.10.10.10/31\n\nnetwork-interface\n    name    test-lan\n    address\n        ip-address 192.168.10.1\n        prefix-length 24\n    ingress-source-nat-pool static-pool-1\n")),(0,r.kt)("p",null,"In the configuration snippet above, the ",(0,r.kt)("em",{parentName:"p"},"192.168.10.0/24")," network for the ",(0,r.kt)("inlineCode",{parentName:"p"},"test-lan")," will be source NAT\u2019d to ",(0,r.kt)("inlineCode",{parentName:"p"},"10.10.10.10/31"),". Traffic from an endpoint of source address 192.168.10.10 will be source NAT\u2019d to 10.10.10.10; 192.168.10.11 will be source NAT\u2019d to 10.10.10.11 and so on. Since the NAT in the model relies on a N:M mapping this can only be configured as an ",(0,r.kt)("em",{parentName:"p"},"ingress-source-nat-pool")," (on ",(0,r.kt)("em",{parentName:"p"},"network-interface"),") or as a destination-nat-pool (on ",(0,r.kt)("em",{parentName:"p"},"service-route / next-hop"),")."),(0,r.kt)("h3",{id:"shared-nat-pools"},"Shared NAT pools"),(0,r.kt)("p",null,"In some scenarios, it is desirable to share the same NAT pool across services and interfaces. This feature accommodates the same NAT pool to be configured on different interfaces. There are some considerations that should be noted for failure and recovery."),(0,r.kt)("u",null,"Flow Move Considerations"),(0,r.kt)("p",null,"Currently session migration is only supported for SVR sessions. This restriction exists because session migration of a non-SVR session is not guaranteed to terminate on the same server. As a result, the remote server might receive mid flow packets from a different source, resulting in undefined behavior."),(0,r.kt)("u",null,"Session Recovery Considerations"),(0,r.kt)("p",null,"For shared NAT pools provisioned on an HA interface that encounters a failover, the SSR software will put the interface into recovery mode to recover all sessions. At the end of the recovery period all non-discovered ports designed as free are returned to the NAT pool."),(0,r.kt)("h3",{id:"tenant-filtering"},"Tenant filtering"),(0,r.kt)("p",null,"The ",(0,r.kt)("em",{parentName:"p"},"nat-pool")," configuration can optionally be provisioned with a list of tenants. When the configuration has ",(0,r.kt)("em",{parentName:"p"},"multiple")," IP pools available, the ",(0,r.kt)("em",{parentName:"p"},"tenant")," can be used to determine which IP pool will be selected for the source NAT. Absence of a tenant implies that the IP pool is valid for all traffic. The following rules will be applied in order to determine the selection of the NAT pool:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The packet has a source tenant associated with it",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If more than one IP pool has a matching tenant, only the first IP pool is used and the hash is applied to create a session. The remainder of the matches are discarded"),(0,r.kt)("li",{parentName:"ul"},"If a pool with no tenant is configured",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Same as above"))),(0,r.kt)("li",{parentName:"ul"},"All IP pools have tenant configured but none of them match the source tenant",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Log the failure, increment stat and drop the packet"))))),(0,r.kt)("li",{parentName:"ul"},"The packet has no source tenant associated with it",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"At least one IP pool has no tenant configured to do the source NAT otherwise this will result in the session being dropped")))),(0,r.kt)("p",null,"The tenant matching rules will apply to sub-tenants as well. For example, if an IP pool allows tenant engineering, then traffic with source tenant lab.engineering will also match the pool."))}f.isMDXComponent=!0}}]);