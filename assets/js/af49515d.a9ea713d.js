"use strict";(self.webpackChunk_128t_docs=self.webpackChunk_128t_docs||[]).push([[4065],{3905:function(e,t,o){o.d(t,{Zo:function(){return u},kt:function(){return m}});var n=o(67294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function c(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=n.createContext({}),s=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},u=function(e){var t=s(e.components);return n.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=s(o),m=r,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||a;return o?n.createElement(h,i(i({ref:t},u),{},{components:o})):n.createElement(h,i({ref:t},u))}));function m(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,i=new Array(a);i[0]=p;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,i[1]=c;for(var s=2;s<a;s++)i[s]=o[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}p.displayName="MDXCreateElement"},61515:function(e,t,o){o.r(t),o.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return c},metadata:function(){return s},toc:function(){return d}});var n=o(87462),r=o(63366),a=(o(67294),o(3905)),i=["components"],c={title:"Conductor Backup and Migration",slidebar_label:"Conductor Backup and Migration"},l=void 0,s={unversionedId:"howto_conductor_migration",id:"howto_conductor_migration",title:"Conductor Backup and Migration",description:"This guide provides the steps to migrate a conductor and the associated routers to a new conductor using the original conductor's configuration files, as well as the procedure to migrate existing routers to a new conductor when the original conductor is no longer accessible.",source:"@site/docs/howto_conductor_migration.md",sourceDirName:".",slug:"/howto_conductor_migration",permalink:"/docs/howto_conductor_migration",draft:!1,tags:[],version:"current",lastUpdatedAt:1702914966,formattedLastUpdatedAt:"Dec 18, 2023",frontMatter:{title:"Conductor Backup and Migration",slidebar_label:"Conductor Backup and Migration"},sidebar:"docs",previous:{title:"Upgrade the SSR Conductor",permalink:"/docs/conductor_upgrade"},next:{title:"Router Interactive Installation",permalink:"/docs/intro_installation_bootable_media"}},u={},d=[{value:"Conductor Backup",id:"conductor-backup",level:2},{value:"Migrating to a New Conductor",id:"migrating-to-a-new-conductor",level:2},{value:"Recover the Configuration from a Damaged or Corrupt Conductor",id:"recover-the-configuration-from-a-damaged-or-corrupt-conductor",level:2},{value:"Verify Migration",id:"verify-migration",level:2}],p={toc:d};function m(e){var t=e.components,o=(0,r.Z)(e,i);return(0,a.kt)("wrapper",(0,n.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This guide provides the steps to migrate a conductor and the associated routers to a new conductor using the original conductor's configuration files, as well as the procedure to migrate existing routers to a new conductor when the original conductor is no longer accessible."),(0,a.kt)("p",null,"Before going through this process, it is beneficial to understand the ",(0,a.kt)("a",{parentName:"p",href:"/docs/bcp_conductor_deployment"},"best practices for deploying your conductor"),"."),(0,a.kt)("h2",{id:"conductor-backup"},"Conductor Backup"),(0,a.kt)("p",null,"Use the following process to backup your conductor and router configurations from your existing conductor. It is a Juniper recommended best practice to perform this process (or create a script to perform the process) on a regular schedule. The files in the tarball are used to recover the network/node configuration to a new conductor. The process is also useful to mitigate disaster recovery."),(0,a.kt)("p",null,"Copy the following files into a tarball (a ",(0,a.kt)("inlineCode",{parentName:"p"},"*.tar.gz")," file) on the existing conductor:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," /var/lib/128technology/t128-running.json\n /var/lib/128technology/user-running.json\n /etc/128technology/salt/pki/master/master.pem\n /etc/128technology/salt/pki/master/master.pub\n /etc/128technology/global.init\n /etc/128technology/local.init\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"If you have created custom salt states, copy the contents of ",(0,a.kt)("inlineCode",{parentName:"p"},"/svr/salt")," along with the above files.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"It is also recommended to copy and save the router public keys stored in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/128technology/salt/pki/master/minions/"),". Migrating these files prevents a router that may have the same ",(0,a.kt)("inlineCode",{parentName:"p"},"minion_id")," as a previously accepted router from being accepted after migration."))),(0,a.kt)("p",null,"Use the following command to create the ",(0,a.kt)("inlineCode",{parentName:"p"},"*.tar.gz")," file. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"tar -czf /var/log/128technology/conductor-backup-$(hostname)-$(date '+%Y-%d-%d').tar.gz <list of files>\n")),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"tar -czf /var/log/128technology/conductor-backup-$(hostname)-$(date '+%Y-%d-%d').tar.gz \\\n/var/lib/128technology/t128-running.json \\ \n/var/lib/128technology/user-running.json \\ \n/etc/128technology/salt/pki/master/master.pem \\ \n/etc/128technology/salt/pki/master/master.pub\\ \n/etc/128technology/salt/pki/master/minions/ \\ \n/etc/128technology/global.init \\ \n/etc/128technology/local.init \\ \n/svr/salt\n")),(0,a.kt)("p",null,"The tarball can then be copied from the old conductor, placed on the new conductor, and extracted there. The procedures below describe the Migration and Restoration processes."),(0,a.kt)("h2",{id:"migrating-to-a-new-conductor"},"Migrating to a New Conductor"),(0,a.kt)("p",null,"This process is used to migrate an existing conductor and router configuration to a new infrastructure where the new conductor has a new IP address. It assumes that the old and the new conductors are both available, but have separate IP addresses"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a new conductor with the same conductor and router node names, but a ",(0,a.kt)("strong",{parentName:"p"},"different IP address"),". For steps to install a conductor, see ",(0,a.kt)("a",{parentName:"p",href:"/docs/single_conductor_install"},"Single Conductor Interactive Installation"),".")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Import and Commit the router configurations to the new conductor."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"tar -C / -xzvf conductor-backup-<hostname>-<timestamp>.tar.gz\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"From the conductor, run the appropriate command ",(0,a.kt)("strong",{parentName:"p"},"on each router to be migrated"),". "))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"For a standalone conductor, use the following command on each router: ",(0,a.kt)("inlineCode",{parentName:"li"},"migrate conductor <address1>")),(0,a.kt)("li",{parentName:"ul"},"For an HA conductor, use the following command on each router: ",(0,a.kt)("inlineCode",{parentName:"li"},"migrate conductor <address1> <address2>"))),(0,a.kt)("h2",{id:"recover-the-configuration-from-a-damaged-or-corrupt-conductor"},"Recover the Configuration from a Damaged or Corrupt Conductor"),(0,a.kt)("p",null,"This process is used to create a new conductor on the same network when the old conductor has been corrupted or is otherwise unusable, but a backup tarball has been or is able to be created."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If a conductor backup tarball has not been created, and the old conductor is accessible, create the tarball as described in the ",(0,a.kt)("a",{parentName:"p",href:"#conductor-backup"},"Conductor Backup")," procedure. ")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Shut down and remove the old conductor from the network to prevent routers from reconnecting there rather than the new conductor.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a new conductor with the ",(0,a.kt)("strong",{parentName:"p"},"same conductor and router node names, and the same IP address"),". For steps to install a conductor, see ",(0,a.kt)("a",{parentName:"p",href:"/docs/single_conductor_install"},"Single Conductor Interactive Installation"),".")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Run the Initializer on the new conductor. "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"initialize128t\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Run the following command to stop 128T:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"systemctl stop 128T\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Copy the conductor backup tarball onto the new conductor and extract the files."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"tar -C / -xzvf conductor-backup-<hostname>-<timestamp>.tar.gz\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Restart 128T on the new conductor. "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"systemctl start 128T\n")))),(0,a.kt)("p",null,"After the restart, the routers will attempt to connect to the conductor and begin operation. You will see a ",(0,a.kt)("strong",{parentName:"p"},"Connected")," state on the conductor showing the migration was successful, and the routers will transition to ",(0,a.kt)("strong",{parentName:"p"},"Running")," after a few minutes. If a router does not migrate successfully, an error is displayed. "),(0,a.kt)("p",null,"If the salt-master public key (",(0,a.kt)("inlineCode",{parentName:"p"},"master_minion.pub"),") is not copied over correctly or is overwritten, the routers will not be able to authenticate. You will need to access each SSR and delete the existing master public key from the router. This forces the router to reconnect and authenticate with the new conductor. "),(0,a.kt)("p",null,"Use the following command on each router to delete the master pubkey:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"rm -rf /etc/salt/pki/minion/minion_master.pub\n")),(0,a.kt)("h2",{id:"verify-migration"},"Verify Migration"),(0,a.kt)("p",null,"After the migration command is run, you will see a \u201cconnected\u201d state on the conductor showing the migration was successful, and the routers will transition to running after a few minutes. If a router does not migrate successfully, an error is displayed. "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Verify that the TCP ports 930, 4505 and 4506 on the conductor are enabled. The routers use these ports to communicate with the conductor."),(0,a.kt)("li",{parentName:"ul"},"If there is a firewall in front of the conductor, these same TCP ports must be enabled.")))}m.isMDXComponent=!0}}]);