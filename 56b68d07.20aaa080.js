(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{115:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return c})),t.d(n,"rightToc",(function(){return l})),t.d(n,"default",(function(){return d}));var a=t(2),i=t(6),r=(t(0),t(226)),o={title:"HA Sync Redundancy Plugin",sidebar_label:"HA Sync Redundancy Plugin"},c={unversionedId:"plugin_ha_sync_redundancy",id:"plugin_ha_sync_redundancy",isDocsHomePage:!1,title:"HA Sync Redundancy Plugin",description:"The HA Sync Redundancy plugin adds the ability to include an additional link in the team interface configured as per Non-Forwarding HA Interfaces. This plugin automates the manual process described here. Additionally, the plugin provides the ability to use the HA sync connection (single or dual-member) to send HA fabric traffic as well by creating a vlan sub-interface and setting up a KNI interfae in a bridge with this sub-interface.",source:"@site/docs/plugin_ha_sync_redundancy.md",slug:"/plugin_ha_sync_redundancy",permalink:"/docs/plugin_ha_sync_redundancy",version:"current",lastUpdatedAt:1634868579,sidebar_label:"HA Sync Redundancy Plugin",sidebar:"docs",previous:{title:"GRE Plugin",permalink:"/docs/plugin_gre"},next:{title:"ICMP Reachability Detection Plugin",permalink:"/docs/plugin_icmp_reachability_detection"}},l=[{value:"Configuration Snippet",id:"configuration-snippet",children:[{value:"Redundant HA Sync Interface",id:"redundant-ha-sync-interface",children:[]},{value:"HA Fabric Over HA Sync",id:"ha-fabric-over-ha-sync",children:[]}]},{value:"Use Cases",id:"use-cases",children:[]},{value:"Troubleshooting",id:"troubleshooting",children:[{value:"Config Auto-Generation",id:"config-auto-generation",children:[]},{value:"Plugin State",id:"plugin-state",children:[]},{value:"Plugin Configuration",id:"plugin-configuration",children:[]},{value:"Configuration handling",id:"configuration-handling",children:[]},{value:"Kni Namespace script",id:"kni-namespace-script",children:[]}]}],s={rightToc:l};function d(e){var n=e.components,t=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},s,t,{components:n,mdxType:"MDXLayout"}),Object(r.b)("p",null,"The HA Sync Redundancy plugin adds the ability to include an additional link in the team interface configured as per ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.128technology.com/docs/config_non_forwarding_ha_interfaces"}),"Non-Forwarding HA Interfaces"),". This plugin automates the manual process described ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.128technology.com/docs/config_adding_interfaces_to_ha_team/"}),"here"),". Additionally, the plugin provides the ability to use the HA sync connection (single or dual-member) to send HA fabric traffic as well by creating a vlan sub-interface and setting up a KNI interfae in a bridge with this sub-interface."),Object(r.b)("h2",{id:"configuration-snippet"},"Configuration Snippet"),Object(r.b)("h3",{id:"redundant-ha-sync-interface"},"Redundant HA Sync Interface"),Object(r.b)("p",null,"The configuration sample below will add Linux interface ",Object(r.b)("inlineCode",{parentName:"p"},"enp0s14f1")," to the HA sync team interface."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"config\n\n    authority\n\n        router  lshields\n            name  lshields\n\n            node  lanner7573\n                name                lanner7573\n\n                ha-sync-redundancy\n                    redundant-interface    enp0s14f1\n                exit\n            exit\n        exit\n    exit\nexit\n")),Object(r.b)("h3",{id:"ha-fabric-over-ha-sync"},"HA Fabric Over HA Sync"),Object(r.b)("p",null,"The configuration sample below will auto-generate HA fabric interfaces that will leverage the existing HA sync connection to transit between the nodes."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"config\n\n    authority\n\n        router  lshields\n            name  lshields\n\n            ha-sync-redundancy\n                generate-shared-fabric-interface    true\n            exit\n        exit\n    exit\nexit\n")),Object(r.b)("p",null,"This will auto-generate the configuration for a device-interface named ",Object(r.b)("inlineCode",{parentName:"p"},"ha-fabric")," on any nodes in the router, each with a network-interface named ",Object(r.b)("inlineCode",{parentName:"p"},"ha-fabric-intf"),". The addresses used on these interfaces will be from the network ",Object(r.b)("inlineCode",{parentName:"p"},"169.254.252.0/30"),". The network can be overridden by specifying a different network range for the option ",Object(r.b)("inlineCode",{parentName:"p"},"fabric-network")," within the ",Object(r.b)("inlineCode",{parentName:"p"},"ha-sync-redundancy")," container."),Object(r.b)("h2",{id:"use-cases"},"Use Cases"),Object(r.b)("p",null,"Within an HA router, the communication that occurs on the HA sync connection is vital to proper operation of the router. In many ways it should be thought of as akin to a backplane of a chassis based router, despite the fact that it is provided through an Ethernet connection. Due to the importance of this connection to proper functionality, customers often wish to provide redundant connections for this traffic in case of cable or interface failure."),Object(r.b)("p",null,"Additionally there is typically a desire to minimize the number of cables that run between two nodes in an HA router, possibly due to lack of physical ports available. This plugin gives the ability to leverage the existing HA sync connection for HA fabric traffic in order to limit the number of physical connections between the two nodes. This can either allow users to avoid the use of three cables when using a redundant HA connection or two avoid using two when the hardware does not provide sufficient ports."),Object(r.b)("h2",{id:"troubleshooting"},"Troubleshooting"),Object(r.b)("h3",{id:"config-auto-generation"},"Config Auto-Generation"),Object(r.b)("p",null,"When enabling use of the shared fabric interface, this plugin auto-generates configuration for a kni host interface named ",Object(r.b)("inlineCode",{parentName:"p"},"ha-fabric"),". If expected configuration is not being generated, please check the following log on the conductor for errors."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"/var/log/128technology/plugins/ha-sync-redundancy-generate-configuration.log\n")),Object(r.b)("h3",{id:"plugin-state"},"Plugin State"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"show plugin state")," command provides useful information in troubleshooting proper performance of the plugin. The ",Object(r.b)("inlineCode",{parentName:"p"},"summary")," version of this command shows a simple table indicating the status of the team and/or bridge as well as their individual members. A sample output of a fully working plugin is shown below."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"If only using one of the two options in this plugin, the output will only contain information for either the team or bridge."))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"admin@node1.conductor# show plugins state router router1 summary 128T-ha-sync-redundancy\nFri 2021-09-03 20:05:53 UTC\nRetrieving state data...\nTarget: node1.router1\n\n============== ======== ====== ================\n Interface      Exists   Up     In Bridge/Team\n============== ======== ====== ================\n team-ens3      True     True   N/A\n ens3           True     True   True\n ens4           True     True   True\n ha-fabric-br   True     True   N/A\n fabric         True     True   True\n ha-fabric      True     True   True\n\nTarget: node2.router1\n\n============== ======== ====== ================\n Interface      Exists   Up     In Bridge/Team\n============== ======== ====== ================\n team-ens3      True     True   N/A\n ens3           True     True   True\n ens4           True     True   True\n ha-fabric-br   True     True   N/A\n fabric         True     True   True\n ha-fabric      True     True   True\n\nRetrieved state data.\nCompleted in 4.12 seconds\nadmin@node1.conductor#\n")),Object(r.b)("p",null,"If there is a False value for any of these fields, further investigation should be undertaken as outlined below."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"show plugin state")," command can also be issued with a ",Object(r.b)("inlineCode",{parentName:"p"},"detail")," option. This option will report the output of the Linux commands ",Object(r.b)("inlineCode",{parentName:"p"},"brctl show")," and ",Object(r.b)("inlineCode",{parentName:"p"},"teamdctl <team name> state")," which can provide additional details of the status of the bridge and team interfaces."),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"}," If only using one of the two options in this plugin, the output will only contain information for either the team or bridge."))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"admin@node1.conductor# show plugins state router router1 detail 128T-ha-sync-redundancy\nFri 2021-09-03 20:17:21 UTC\nRetrieving state data...\n\n============================================================================\n node1.router1\n============================================================================\n   Fabric Status:\n bridge name    bridge id               STP enabled     interfaces\n ha-fabric-br           8000.500000020001       no              fabric\n                                                        ha-fabric\n\n   Team Status:\n     ports:\n       ens3:\n         ifinfo:\n           dev_addr:                           50:00:00:02:00:01\n           dev_addr_len:                       6\n           ifindex:                            3\n           ifname:                             ens3\n         link:\n           duplex:                             full\n           speed:                              1000\n           up:                                 True\n         link_watches:\n           list:\n             link_watch_0:\n               delay_down:                     0\n               delay_up:                       0\n               down_count:                     1\n               name:                           ethtool\n               up:                             True\n           up:                                 True\n       ens4:\n         ifinfo:\n           dev_addr:                           50:00:00:02:00:01\n           dev_addr_len:                       6\n           ifindex:                            4\n           ifname:                             ens4\n         link:\n           duplex:                             full\n           speed:                              1000\n           up:                                 True\n         link_watches:\n           list:\n             link_watch_0:\n               delay_down:                     0\n               delay_up:                       0\n               down_count:                     0\n               name:                           ethtool\n               up:                             True\n           up:                                 True\n     runner:\n       active_port:                            ens4\n     setup:\n       daemonized:                             False\n       dbus_enabled:                           True\n       debug_level:                            0\n       kernel_team_mode_name:                  activebackup\n       pid:                                    11070\n       pid_file:                               /var/run/teamd/team-ens3.pid\n       runner_name:                            activebackup\n       zmq_enabled:                            False\n     team_device:\n       ifinfo:\n         dev_addr:                             50:00:00:02:00:01\n         dev_addr_len:                         6\n         ifindex:                              11\n         ifname:                               team-ens3\n")),Object(r.b)("p",null,"The sections below contain information on how the plugin orchestrates the setup of the team and bridge interfaces. This information can be used to troubleshoot proper operation of the plugin if these commands show issues with either the team or the bridge."),Object(r.b)("h3",{id:"plugin-configuration"},"Plugin Configuration"),Object(r.b)("p",null,"When configuration is created for this plugin, the conductor will create a configuration file with the appropriate information on each node of the router. This file will be located in the directory ",Object(r.b)("inlineCode",{parentName:"p"},"/var/lib/128technology/plugins/ha-sync-redundancy/")," and named ",Object(r.b)("inlineCode",{parentName:"p"},"config.yaml"),". A copy of this file named ",Object(r.b)("inlineCode",{parentName:"p"},"config.yaml.current")," will also be found in this directory if the config was read correctly. This file is used to maintain the last state of the configuration to detect when changes are made so that interfaces no longer needed can be cleaned up. The contents of this file should look as follows (based on the configuration above)."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),'redundant_interface: "enp0s14f0"\nha_fabric_vlan: "1000"\n')),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"It can take several minutes after a commit from conductor for this file to be generated"))),Object(r.b)("h3",{id:"configuration-handling"},"Configuration handling"),Object(r.b)("p",null,"Upon generation of the configuration file, a configuration handler will be executed. This handler will read the configuration file and will setup the redundant team interface member as well as setup a ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://docs.128technology.com/docs/plugin_kni_namespace_scripts/"}),"kni namespace script")," configuration file that will handle the vlan interface and bridge creation. This script will write errors to the log file ",Object(r.b)("inlineCode",{parentName:"p"},"/var/log/128technology/plugins/ha-sync-redundancy.log"),", which can provide information if issues arise. The config handler can also be executed manually by running ",Object(r.b)("inlineCode",{parentName:"p"},"/usr/bin/t128-ha-sync-redundancy-config-handler"),"."),Object(r.b)("p",null,"The contents of this file should look similar to what is shown below."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-yaml"}),"vlan-interfaces:\n- name: fabric\n  base-intf: team-enp10s0f0\n  vlan-id: 2000\nbridges:\n- name: ha-fabric-br\n  kni-intf: ha-fabric\n  target-intf: fabric\n")),Object(r.b)("h3",{id:"kni-namespace-script"},"Kni Namespace script"),Object(r.b)("p",null,"This portion is only relevant to the configuration of a HA Fabric Vlan. After the configuration has been handled, as mentioned above, a configuration file for the namespace scripts will be generated at ",Object(r.b)("inlineCode",{parentName:"p"},"/var/lib/128technology/kni/host/ha-fabric.conf"),". In addition, symbolic links should be created to the kni namespace scripts in the directory ",Object(r.b)("inlineCode",{parentName:"p"},"/etc/128technology/plugins/network-scripts/host/ha-fabric")," as shown below:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{}),"[root@lr202006003427 ha-fabric]# ll\ntotal 20\nlrwxrwxrwx 1 root root  69 Aug 30 20:26 init -> /etc/128technology/plugins/network-scripts/default/kni_namespace/init\n-rwxr-xr-x 1 root root 246 Aug 30 20:52 monitoring\nlrwxrwxrwx 1 root root  62 Aug 30 20:26 reinit -> /etc/128technology/plugins/network-scripts/host/ha-fabric/init\nlrwxrwxrwx 1 root root  73 Aug 30 20:26 shutdown -> /etc/128technology/plugins/network-scripts/default/kni_namespace/shutdown\nlrwxrwxrwx 1 root root  72 Aug 30 20:26 startup -> /etc/128technology/plugins/network-scripts/default/kni_namespace/startup\n[root@lr202006003427 ha-fabric]#\n")),Object(r.b)("p",null,"If these scripts have errors, they will be shown in ",Object(r.b)("inlineCode",{parentName:"p"},"/var/log/128technology/highway.log"),". On occasion, setting the log-level to debug will provide additional details of how these scripts are run and errors they generate."))}d.isMDXComponent=!0},226:function(e,n,t){"use strict";t.d(n,"a",(function(){return u})),t.d(n,"b",(function(){return h}));var a=t(0),i=t.n(a);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=i.a.createContext({}),d=function(e){var n=i.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},u=function(e){var n=d(e.components);return i.a.createElement(s.Provider,{value:n},e.children)},b={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},p=i.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=d(t),p=a,h=u["".concat(o,".").concat(p)]||u[p]||b[p]||r;return t?i.a.createElement(h,c(c({ref:n},s),{},{components:t})):i.a.createElement(h,c({ref:n},s))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,o=new Array(r);o[0]=p;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var s=2;s<r;s++)o[s]=t[s];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,t)}p.displayName="MDXCreateElement"}}]);